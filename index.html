<!-- Cambios: AÃ±adidas reglas CSS para mejorar la responsividad en mÃ³viles (â‰¤640px), ajustando cabecera, tarjetas de resumen y botones. La lÃ³gica y estructura permanecen intactas. -->
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gestor de Comedor Escolar</title>

<!-- Tailwind CDN para prototipo -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<meta name="theme-color" content="#ffffff">

<style>
:root{
Â Â --bg:#f6f7f9; --paper:#fff; --text:#0f172a; --muted:#6b7280;
Â Â --brand:#8b0630; --brand-dark:#700424; --accent:#19b4d6; --success:#067a46; --danger:#c92a2a;
Â Â --card-border: rgba(15,23,42,0.06);
}
*{box-sizing:border-box}
body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:var(--text); margin:0; -webkit-font-smoothing:antialiased;}
.container { max-width:1100px; margin:0 auto; padding:20px; }
.header-row { display:flex; align-items:center; justify-content:space-between; gap:12px; }
.logo { width:54px;height:54px;border-radius:10px;background:#fff;display:inline-flex;align-items:center;justify-content:center;box-shadow:0 6px 20px rgba(15,23,42,0.04);border:1px solid var(--card-border); }
.title-wrap { text-align:center; flex:1; }
h1 { margin:8px 0 0; color:var(--brand); font-weight:800; font-size:28px; }
.subtle { color:var(--muted); }

.header-actions { display:flex; gap:8px; align-items:center; justify-content:flex-end; min-width:150px; }

/* Paneles */
.admin-panel { background:var(--paper); border-radius:12px; padding:18px; border:1px solid var(--card-border); box-shadow:0 14px 36px rgba(15,23,42,0.04); margin-top:18px; }
.btn-row { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
button.primary { background:linear-gradient(180deg,var(--brand),var(--brand-dark)); color:#fff; padding:10px 16px; border-radius:999px; font-weight:700; border:0; cursor:pointer; }
button.ghost { background:#fff; border:1px solid rgba(15,23,42,0.06); padding:10px 14px; border-radius:10px; cursor:pointer; }
button.small { padding:6px 8px; font-size:0.9rem; border-radius:8px; }

/* Summary + grid */
.summary-card { background:var(--paper); padding:14px; border-radius:10px; border:1px solid var(--card-border); box-shadow:0 10px 30px rgba(15,23,42,0.03); text-align:center; }
#courses-container { margin-top:14px; display:grid; gap:14px; grid-template-columns: repeat(auto-fill, minmax(280px,1fr)); }

/* Course card */
.course-card { background:var(--paper); border-radius:10px; padding:12px; border:1px solid var(--card-border); box-shadow:0 8px 24px rgba(15,23,42,0.03); display:flex; flex-direction:column; gap:8px; }
.course-card h3 { color:var(--brand); margin:0; font-weight:700; }

/* Student item */
.student-item { background:#ffffff; border-radius:10px; padding:12px; display:flex; align-items:center; justify-content:space-between; gap:12px; border-left:6px solid transparent; border:1px solid rgba(15,23,42,0.04); }
.student-left { display:flex; gap:12px; align-items:center; }
.student-name { font-weight:700; font-size:1.02rem; }
.student-meta { color:var(--muted); font-size:0.92rem; }

/* States */
.student-item.pending { border-left-color:#cbd5e1; }
.student-item.present { border-left-color:var(--success); background:#f0fdf4; box-shadow:0 8px 20px rgba(6,122,70,0.04);}
.student-item.absent { border-left-color:var(--danger); background:linear-gradient(90deg, rgba(201,42,42,0.04), #fff); text-decoration:line-through; opacity:0.96; }

/* ------- Alergia: resaltar con borde alrededor del nombre (sin texto "ALERGIA") ------- */

/* Si el alumno tiene la clase `allergic`, mostramos un borde rojo alrededor del nombre */
.student-item.allergic .name {
Â Â border: 2px solid #c92a2a;Â  /* rojo */
Â Â padding: 6px 10px;
Â Â border-radius: 8px;
Â Â display: inline-block;
Â Â background: rgba(201,42,42,0.03);
Â Â font-weight: 700;
}

.student-item.present.allergic .name {
Â Â border-color: #b91c1c;
Â Â background: rgba(185,28,28,0.06);
}

/* X button */
.mark-absent-btn { width:40px; height:40px; border-radius:8px; border:1px solid rgba(0,0,0,0.04); background:#fff; font-weight:700; cursor:pointer; }

/* Report styling */
.report-wrapper { background:var(--paper); border-radius:12px; padding:10px; border:1px solid var(--card-border); box-shadow:0 10px 30px rgba(15,23,42,0.03); }
.report-table { width:100%; border-collapse:collapse; font-size:13px; }
.report-table th, .report-table td { border:1px solid rgba(15,23,42,0.06); padding:6px 6px; text-align:center; min-width:28px; }
.report-table thead th { background:#fff; position:sticky; top:0; z-index:2; }
.report-table td.total { font-weight:700; color:var(--brand); }
.attendance-mark { display:inline-flex; align-items:center; justify-content:center; width:20px;height:20px;border-radius:50%; background:var(--success); color:#fff; font-weight:700; }

/* Modal */
.fixed-modal { position:fixed; left:0; top:0; width:100%; height:100%; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.28); z-index:90; }
.fixed-modal.active { display:flex; }
.modal-content { background:#fff; border-radius:12px; padding:16px; width:92%; max-width:840px; max-height:90vh; overflow:auto; box-shadow:0 18px 40px rgba(0,0,0,0.12); }

.small-muted { color:var(--muted); font-size:0.85rem; }

@media (max-width:800px){
Â Â #courses-container { grid-template-columns:1fr; }
}

/* --- INICIO: Mejoras de Responsividad MÃ³vil --- */
@media (max-width: 640px) {
    body {
        padding: 0; /* El container controla el espacio */
    }
    .container {
        padding: 10px;
    }
    
    /* Ajustes de la cabecera */
    .header-row {
        flex-wrap: wrap;
        gap: 12px;
        justify-content: space-between;
    }
    .title-wrap {
        flex-basis: 100%;
        order: -1; /* Mueve el tÃ­tulo arriba de todo */
        text-align: center;
    }
    h1 {
        font-size: 24px;
    }
    .header-actions {
        min-width: auto;
    }
    
    /* Rejilla de resumen a 2x2 */
    main#dashboard > section:first-child {
        grid-template-columns: repeat(2, 1fr) !important;
    }
    
    .summary-card {
        padding: 10px;
    }
    .summary-card div[style*="font-size:22px"] {
        font-size: 20px !important;
    }
    
    /* Apila los botones en la vista inicial */
    #shift-selection .admin-panel .btn-row,
    #shift-selection .admin-panel div[style*="margin-top:12px"] {
        flex-direction: column;
        align-items: stretch;
    }
    #shift-selection .admin-panel .btn-row button,
    #shift-selection .admin-panel div[style*="margin-top:12px"] button,
    #shift-selection .admin-panel div[style*="margin-top:12px"] input {
        width: 100%;
        text-align: center;
    }

    /* Ajustes en la vista del dashboard */
    #dashboard > div[style*="justify-content:space-between"] {
      flex-direction: column;
      align-items: stretch;
    }
     #dashboard > div[style*="justify-content:space-between"] button {
      width: 100%;
    }
    
    /* Modales */
    .modal-content {
        padding: 12px;
        width: 95%;
    }
}
/* --- FIN: Mejoras de Responsividad MÃ³vil --- */

@media print{
Â Â body * { visibility:hidden; }
Â Â .printable-area, .printable-area * { visibility:visible; }
Â Â .printable-area { position:absolute; left:0; top:0; width:100%; background:#fff; padding:8px; }
Â Â @page { size: landscape; margin:0.4cm; }
}
</style>
</head>
<body>

<div class="container">
Â Â <header class="header-row" role="banner">
Â Â Â Â <div class="logo" aria-hidden="true"><svg width="34" height="34" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><rect fill="#fff" width="48" height="48" rx="8"/><text x="50%" y="56%" font-size="16" fill="#8b0630" text-anchor="middle" font-family="Inter">CEVP</text></svg></div>

Â Â Â Â <div class="title-wrap">
Â Â Â Â Â Â <h1>Gestor de Comedor</h1>
Â Â Â Â Â Â <div id="role-display" class="subtle">Cargando...</div>
Â Â Â Â </div>

Â Â Â Â <div class="header-actions">
Â Â Â Â Â Â <!-- logout visible cuando admin -->
Â Â Â Â Â Â <button id="logout-btn" class="ghost small" title="Cerrar sesiÃ³n" style="display:none">Cerrar sesiÃ³n</button>
Â Â Â Â </div>
Â Â </header>

Â Â <!-- Login admin -->
Â Â <div id="admin-login-view" class="admin-panel hidden" style="max-width:640px;margin:14px auto 0">
Â Â Â Â <h2 style="text-align:center">Acceso de Administrador</h2>
Â Â Â Â <div style="text-align:center;margin-top:10px">
Â Â Â Â Â Â <button id="login-admin-btn" class="primary">Iniciar sesiÃ³n con Google</button>
Â Â Â Â </div>
Â Â </div>

Â Â <!-- Main -->
Â Â <div id="main-content" style="margin-top:18px">

Â Â Â Â <section id="shift-selection" style="text-align:center">
Â Â Â Â Â Â <h2 style="margin-bottom:12px">Elige un turno de comedor</h2>
Â Â Â Â Â Â <div class="btn-row" id="shift-buttons" style="justify-content:center">
Â Â Â Â Â Â Â Â <button class="primary large" data-shift="Primer Turno (Infantil)">Primer Turno (Infantil)</button>
Â Â Â Â Â Â Â Â <button class="primary large" data-shift="Segundo Turno (Primaria)">Segundo Turno (Primaria)</button>
Â Â Â Â Â Â </div>

Â Â Â Â Â Â <div class="admin-panel admin-only" style="margin-top:18px">
Â Â Â Â Â Â Â Â <h3 style="text-align:center;margin-bottom:10px">Panel de GestiÃ³n</h3>
Â Â Â Â Â Â Â Â <div class="btn-row" role="group" aria-label="gestion-datos">
Â Â Â Â Â Â Â Â Â Â <button id="import-csv-btn-initial" class="primary">ğŸ“¤ Importar Alumnos (CSV)</button>
Â Â Â Â Â Â Â Â Â Â <button id="manage-students-btn" class="primary">ğŸ‘¥ Gestionar Alumnos</button>
Â Â Â Â Â Â Â Â Â Â <button id="wipe-db" class="ghost">ğŸ—‘ï¸ Borrar todos los alumnos</button>
Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â <div style="margin-top:12px;display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap">
Â Â Â Â Â Â Â Â Â Â <input id="export-date-input" type="date" style="padding:8px;border-radius:8px;border:1px solid var(--card-border);background:#fff">
Â Â Â Â Â Â Â Â Â Â <button id="export-csv-btn" class="primary">ğŸ’¾ Exportar CSV del DÃ­a</button>
Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â <p id="import-status-initial" style="text-align:center;margin-top:10px;min-height:18px;color:#059669"></p>
Â Â Â Â Â Â </div>
Â Â Â Â </section>

Â Â Â Â <main id="dashboard" class="hidden" style="margin-top:18px">
Â Â Â Â Â Â <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:12px">
Â Â Â Â Â Â Â Â <button id="back-to-shifts" class="ghost">&larr; Volver a Turnos</button>
Â Â Â Â Â Â Â Â <div>
Â Â Â Â Â Â Â Â Â Â <button id="finalize-shift-btn" class="primary">ğŸ Finalizar Turno</button>
Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â </div>

Â Â Â Â Â Â <section style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px">
Â Â Â Â Â Â Â Â <div class="summary-card"><div class="small-muted">Comensales</div><div id="summary-diners" style="font-size:22px;font-weight:800">0</div></div>
Â Â Â Â Â Â Â Â <div class="summary-card"><div class="small-muted">Ausentes</div><div id="summary-absent" style="font-size:22px;font-weight:800">0</div></div>
Â Â Â Â Â Â Â Â <div class="summary-card"><div class="small-muted">Pendientes</div><div id="summary-pending" style="font-size:22px;font-weight:800">0</div></div>
Â Â Â Â Â Â Â Â <div class="summary-card"><div class="small-muted">Presentes</div><div id="summary-present" style="font-size:22px;font-weight:800">0</div></div>
Â Â Â Â Â Â </section>

Â Â Â Â Â Â <section id="student-lists">
Â Â Â Â Â Â Â Â <div id="courses-container"></div>
Â Â Â Â Â Â </section>
Â Â Â Â </main>

Â Â </div>
</div>

<input id="csv-file-input" type="file" accept=".csv" style="display:none">

<!-- Manage Students Modal (admin) -->
<div id="manage-students-modal" class="fixed-modal" aria-hidden="true">
Â Â <div class="modal-content">
Â Â Â Â <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
Â Â Â Â Â Â <h2 style="color:var(--brand)">Gestionar Alumnos</h2>
Â Â Â Â Â Â <button id="close-manage-modal" class="small">âœ•</button>
Â Â Â Â </header>
Â Â Â Â <div id="manage-students-content" style="max-height:68vh;overflow:auto"></div>
Â Â </div>
</div>

<!-- Sporadic Picker Modal (profesor) -->
<div id="sporadic-picker-modal" class="fixed-modal" aria-hidden="true">
Â Â <div class="modal-content">
Â Â Â Â <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
Â Â Â Â Â Â <h3 id="sporadic-picker-title">Seleccionar esporÃ¡dicos</h3>
Â Â Â Â Â Â <button id="close-sporadic-picker" class="small">âœ•</button>
Â Â Â Â </header>
Â Â Â Â <div id="sporadic-picker-content" style="max-height:62vh;overflow:auto"></div>
Â Â Â Â <footer style="margin-top:8px;text-align:right">
Â Â Â Â Â Â <button id="confirm-sporadic-add" class="primary">AÃ±adir seleccionados</button>
Â Â Â Â </footer>
Â Â </div>
</div>

<!-- Monthly report modal -->
<div id="monthly-report-modal" class="fixed-modal" aria-hidden="true">
Â Â <div class="modal-content">
Â Â Â Â <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
Â Â Â Â Â Â <h3 style="color:var(--brand)">Informe de Asistencia Mensual</h3>
Â Â Â Â Â Â <div style="display:flex;gap:8px;align-items:center">
Â Â Â Â Â Â Â Â <input id="report-month-input" type="month" style="padding:8px;border-radius:8px;border:1px solid var(--card-border)">
Â Â Â Â Â Â Â Â <button id="print-report-btn" class="primary">ğŸ–¨ï¸ Imprimir</button>
Â Â Â Â Â Â Â Â <button id="close-report-btn" class="small">âœ•</button>
Â Â Â Â Â Â </div>
Â Â Â Â </header>
Â Â Â Â <div id="monthly-report-content" style="max-height:66vh;overflow:auto"></div>
Â Â </div>
</div>

<!-- History modal -->
<div id="history-modal" class="fixed-modal" aria-hidden="true">
Â Â <div class="modal-content">
Â Â Â Â <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
Â Â Â Â Â Â <h3 style="color:var(--brand)">Historial de Asistencia</h3>
Â Â Â Â Â Â <button id="close-history-btn" class="small">âœ•</button>
Â Â Â Â </header>
Â Â Â Â <div style="display:flex;gap:14px">
Â Â Â Â Â Â <div style="width:35%">
Â Â Â Â Â Â Â Â <input id="history-search" placeholder="Buscar alumno..." style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--card-border)">
Â Â Â Â Â Â Â Â <div id="history-student-list" style="margin-top:8px;max-height:52vh;overflow:auto"></div>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <div style="flex:1;background:#fff;border-radius:8px;padding:10px">
Â Â Â Â Â Â Â Â <h4 id="history-student-name">Selecciona un alumno</h4>
Â Â Â Â Â Â Â Â <div id="history-dates-list" style="margin-top:8px;max-height:52vh;overflow:auto"></div>
Â Â Â Â Â Â </div>
Â Â Â Â </div>
Â Â </div>
</div>

<!-- Firebase + PapaParse -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {

Â Â const firebaseConfig = {
Â Â Â Â apiKey: "AIzaSyAeI9G1_2-E8Kghc-88bkrXa_VDJXeDyHo",
Â Â Â Â authDomain: "comedorvp.firebaseapp.com",
Â Â Â Â projectId: "comedorvp",
Â Â Â Â storageBucket: "comedorvp.firebasestorage.app",
Â Â Â Â messagingSenderId: "821870274048",
Â Â Â Â appId: "1:821870274048:web:62b85d28ceace395245ae5"
Â Â };
Â Â firebase.initializeApp(firebaseConfig);
Â Â const db = firebase.firestore();
Â Â const auth = firebase.auth();
Â Â const googleProvider = new firebase.auth.GoogleAuthProvider();

Â Â const appState = { currentShift: null, students: [], attendance: {}, tempSporadic: new Set() };

Â Â const dom = {
Â Â Â Â roleDisplay: document.getElementById('role-display'),
Â Â Â Â adminLoginView: document.getElementById('admin-login-view'),
Â Â Â Â mainContent: document.getElementById('main-content'),
Â Â Â Â coursesContainer: document.getElementById('courses-container'),
Â Â Â Â importStatusInitial: document.getElementById('import-status-initial'),
Â Â Â Â csvFileInput: document.getElementById('csv-file-input'),
Â Â Â Â manageStudentsModal: document.getElementById('manage-students-modal'),
Â Â Â Â manageStudentsContent: document.getElementById('manage-students-content'),
Â Â Â Â closeManageModal: document.getElementById('close-manage-modal'),
Â Â Â Â sporadicPickerModal: document.getElementById('sporadic-picker-modal'),
Â Â Â Â sporadicPickerContent: document.getElementById('sporadic-picker-content'),
Â Â Â Â sporadicPickerTitle: document.getElementById('sporadic-picker-title'),
Â Â Â Â closeSporadicPicker: document.getElementById('close-sporadic-picker'),
Â Â Â Â confirmSporadicAdd: document.getElementById('confirm-sporadic-add'),
Â Â Â Â monthlyReportModal: document.getElementById('monthly-report-modal'),
Â Â Â Â monthlyReportContent: document.getElementById('monthly-report-content'),
Â Â Â Â reportMonthInput: document.getElementById('report-month-input'),
Â Â Â Â printReportBtn: document.getElementById('print-report-btn'),
Â Â Â Â closeReportBtn: document.getElementById('close-report-btn'),
Â Â Â Â historyModal: document.getElementById('history-modal'),
Â Â Â Â historyStudentList: document.getElementById('history-student-list'),
Â Â Â Â historyStudentName: document.getElementById('history-student-name'),
Â Â Â Â historyDatesList: document.getElementById('history-dates-list'),
Â Â Â Â historySearch: document.getElementById('history-search'),
Â Â Â Â loginAdminBtn: document.getElementById('login-admin-btn'),
Â Â Â Â importCsvBtnInitial: document.getElementById('import-csv-btn-initial'),
Â Â Â Â manageStudentsBtn: document.getElementById('manage-students-btn'),
Â Â Â Â wipeDbBtn: document.getElementById('wipe-db'),
Â Â Â Â exportCsvBtn: document.getElementById('export-csv-btn'),
Â Â Â Â exportDateInput: document.getElementById('export-date-input'),
Â Â Â Â finalizeShiftBtn: document.getElementById('finalize-shift-btn'),
Â Â Â Â backToShiftsBtn: document.getElementById('back-to-shifts'),
Â Â Â Â summary: { diners: document.getElementById('summary-diners'), absent: document.getElementById('summary-absent'), pending: document.getElementById('summary-pending'), present: document.getElementById('summary-present') },
Â Â Â Â logoutBtn: document.getElementById('logout-btn')
Â Â };

Â Â /* ----- Firestore helpers ----- */
Â Â async function fetchStudents() {
Â Â Â Â const snap = await db.collection('students').get();
Â Â Â Â return snap.docs.map(d => ({ id: d.id, ...d.data() }));
Â Â }
Â Â async function addStudentBatch(students) {
Â Â Â Â const batch = db.batch(); const col = db.collection('students'); let added = 0;
Â Â Â Â students.forEach(s => {
Â Â Â Â Â Â if (s.name && s.course) {
Â Â Â Â Â Â Â Â const docRef = col.doc();
Â Â Â Â Â Â Â Â batch.set(docRef, { name: s.name.trim(), course: s.course.trim(), shift: s.shift ? s.shift.trim() : '', status: s.status || (s.shift ? 'fixed' : 'sporadic'), allergic: !!s.allergic });
Â Â Â Â Â Â Â Â added++;
Â Â Â Â Â Â }
Â Â Â Â });
Â Â Â Â if (added) await batch.commit();
Â Â Â Â return added;
Â Â }
Â Â async function updateStudentDoc(id, updates) {
Â Â Â Â try { await db.collection('students').doc(id).update(updates); return true; }
Â Â Â Â catch(e){ console.error(e); return false; }
Â Â }
Â Â async function deleteAllStudents() { const snap = await db.collection('students').get(); const batch = db.batch(); snap.docs.forEach(d => batch.delete(d.ref)); await batch.commit(); }

Â Â async function logAttendance(studentId, dateStr, state) {
Â Â Â Â if (studentId.startsWith('sporadic_')) return;
Â Â Â Â const docRef = db.collection('attendance').doc(`${studentId}_${dateStr}`);
Â Â Â Â await docRef.set({ studentId, date: dateStr, state });
Â Â }
Â Â async function logBatchAttendance(ids, dateStr, state) {
Â Â Â Â const valid = ids.filter(id => !id.startsWith('sporadic_'));
Â Â Â Â if (!valid.length) return;
Â Â Â Â const batch = db.batch(); const col = db.collection('attendance');
Â Â Â Â valid.forEach(id => batch.set(col.doc(`${id}_${dateStr}`), { studentId: id, date: dateStr, state }));
Â Â Â Â await batch.commit();
Â Â }
Â Â async function fetchAttendanceByDate(dateStr) { const snap = await db.collection('attendance').where('date','==',dateStr).get(); const out = {}; snap.docs.forEach(d=>out[d.data().studentId]=d.data().state); return out; }
Â Â async function fetchAttendanceByMonth(ym) { const start=ym+'-01', end=ym+'-31'; const snap = await db.collection('attendance').where('date','>=',start).where('date','<=',end).get(); const map = new Map(); snap.docs.forEach(d=>{ const r=d.data(); if(!map.has(r.studentId)) map.set(r.studentId,new Set()); const day = parseInt(r.date.slice(-2).replace(/^0+/,''),10); if(!isNaN(day)) map.get(r.studentId).add(day);}); return map; }

Â Â /* ----- UI helpers ----- */
Â Â function updateSummary() {
Â Â Â Â const vals = Object.values(appState.attendance);
Â Â Â Â dom.summary.diners.textContent = vals.length;
Â Â Â Â dom.summary.absent.textContent = vals.filter(v=>'absent'===v).length;
Â Â Â Â dom.summary.present.textContent = vals.filter(v=>'present'===v).length;
Â Â Â Â dom.summary.pending.textContent = vals.filter(v=>'pending'===v).length;
Â Â }

Â Â function createStudentElement(s) {
Â Â const div = document.createElement('div');
Â Â const stateClass = appState.attendance && appState.attendance[s.id]Â 
Â Â Â Â ? appState.attendance[s.id]Â 
Â Â Â Â : 'pending';

Â Â div.className = `student-item ${stateClass}${s.allergic ? ' allergic' : ''}`;
Â Â div.dataset.studentId = s.id;
Â Â div.dataset.studentName = s.name;

Â Â div.innerHTML = `
Â Â Â Â <div class="student-left">
      <span class="name">${s.name}</span>
    </div>
Â Â Â Â <div class="flex items-center gap-2">
Â Â Â Â Â Â <button class="mark-absent-btn bg-rose-500/50 hover:bg-rose-500 text-white font-bold"Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â title="Marcar ausente">&times;</button>
Â Â Â Â </div>
Â Â `;
  // CorrecciÃ³n: El .name no debe tener la clase allergic, ya que el estilo se aplica por descendencia.
  // El div principal .student-item ya tiene la clase .allergic
Â Â return div.outerHTML.replace('<span class="name">', `<span class="name ${s.allergic ? 'allergic-name-highlight' : ''}">`);
}


Â Â /* ----- Render courses ----- */
Â Â async function renderCourses(shift) {
Â Â Â Â appState.currentShift = shift;
Â Â Â Â document.getElementById('shift-selection').style.display = 'none';
Â Â Â Â document.getElementById('dashboard').classList.remove('hidden');
Â Â Â Â dom.coursesContainer.innerHTML = '<p class="small-muted">Cargando alumnos...</p>';

Â Â Â Â appState.students = await fetchStudents();
Â Â Â Â const today = new Date().toISOString().slice(0,10);
Â Â Â Â const attendance = await fetchAttendanceByDate(today);
Â Â Â Â appState.attendance = {};
Â Â Â Â appState.students.forEach(s => appState.attendance[s.id] = attendance[s.id] || 'pending');

Â Â Â Â dom.coursesContainer.innerHTML = '';

Â Â Â Â // show only students assigned to this shift OR those tempSporadic added for today
Â Â Â Â const assigned = appState.students.filter(s => (s.shift && s.shift === shift) || appState.tempSporadic.has(s.id));
Â Â Â Â const courses = [...new Set(assigned.map(s => s.course))].sort();

Â Â Â Â if (!courses.length) {
Â Â Â Â Â Â dom.coursesContainer.innerHTML = '<p class="small-muted">No hay alumnos en este turno.</p>';
Â Â Â Â } else {
Â Â Â Â Â Â courses.forEach(course => {
Â Â Â Â Â Â Â Â const card = document.createElement('div'); card.className = 'course-card';
Â Â Â Â Â Â Â Â const studentsInCourse = assigned.filter(s => s.course === course).sort((a,b)=>a.name.localeCompare(b.name));
Â Â Â Â Â Â Â Â const listHtml = studentsInCourse.map(createStudentElement).join('');
Â Â Â Â Â Â Â Â const pickerBtn = `<div style="margin-top:8px"><button class="open-sporadic-picker primary small" data-course="${course}">+ AÃ±adir esporÃ¡dico</button></div>`;
Â Â Â Â Â Â Â Â card.innerHTML = `<div><h3>${course}</h3><div style="display:flex;flex-direction:column;gap:8px;margin-top:8px" data-course-list="${course}">${listHtml}</div></div>${pickerBtn}`;
Â Â Â Â Â Â Â Â dom.coursesContainer.appendChild(card);
Â Â Â Â Â Â });
Â Â Â Â }
Â Â Â Â updateSummary();
Â Â }

Â Â /* ----- Sporadic picker ----- */
Â Â let currentPickerCourse = null;
Â Â function openSporadicPickerModal(course) {
Â Â Â Â currentPickerCourse = course;
Â Â Â Â dom.sporadicPickerTitle.textContent = `Seleccionar esporÃ¡dicos â€” ${course}`;
Â Â Â Â const candidates = appState.students.filter(s => s.course === course && (!s.shift || s.shift.trim()==='') && !(s.id && s.id.startsWith && s.id.startsWith('sporadic_')));
Â Â Â Â const container = dom.sporadicPickerContent;
Â Â Â Â if (!candidates.length) {
Â Â Â Â Â Â container.innerHTML = `<p class="small-muted">No hay alumnos sin turno asignado en ${course}.</p>`;
Â Â Â Â } else {
Â Â Â Â Â Â let html = `<div style="display:flex;flex-direction:column;gap:8px">`;
Â Â Â Â Â Â candidates.sort((a,b)=>a.name.localeCompare(b.name)).forEach(s => {
Â Â Â Â Â Â Â Â html += `<label style="display:flex;align-items:center;gap:8px;padding:8px;border:1px solid var(--card-border);border-radius:8px;background:#fff">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <input type="checkbox" class="sporadic-candidate" data-id="${s.id}">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <div style="flex:1"><strong>${s.name}</strong><div class="small-muted">${s.course}</div></div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </label>`;
Â Â Â Â Â Â });
Â Â Â Â Â Â html += `</div>`;
Â Â Â Â Â Â container.innerHTML = html;
Â Â Â Â }
Â Â Â Â dom.sporadicPickerModal.classList.add('active');
Â Â }
Â Â dom.closeSporadicPicker.addEventListener('click', () => dom.sporadicPickerModal.classList.remove('active'));
Â Â dom.confirmSporadicAdd.addEventListener('click', async () => {
Â Â Â Â const checked = Array.from(dom.sporadicPickerContent.querySelectorAll('.sporadic-candidate:checked')).map(cb => cb.dataset.id);
Â Â Â Â if (!checked.length) { alert('Selecciona al menos un alumno.'); return; }
Â Â Â Â const today = new Date().toISOString().slice(0,10);
Â Â Â Â for (const id of checked) {
Â Â Â Â Â Â try {
Â Â Â Â Â Â Â Â await logAttendance(id, today, 'present');
Â Â Â Â Â Â Â Â appState.tempSporadic.add(id);
Â Â Â Â Â Â Â Â appState.attendance[id] = 'present';
Â Â Â Â Â Â } catch (e) { console.error('error al aÃ±adir esporÃ¡dico', e); }
Â Â Â Â }
Â Â Â Â if (appState.currentShift) await renderCourses(appState.currentShift);
Â Â Â Â dom.sporadicPickerModal.classList.remove('active');
Â Â });

Â Â /* ----- CSV import ----- */
Â Â function handleCsvImport(file) {
Â Â Â Â if (!file) return;
Â Â Â Â dom.importStatusInitial.textContent = 'Procesando archivo...';
Â Â Â Â Papa.parse(file, { header:true, skipEmptyLines:true,
Â Â Â Â Â Â complete: async (results) => {
Â Â Â Â Â Â Â Â try {
Â Â Â Â Â Â Â Â Â Â const fields = (results.meta.fields || []).map(f => (f||'').toLowerCase().trim());
Â Â Â Â Â Â Â Â Â Â if (!fields.includes('nombre') || !fields.includes('curso')) {
Â Â Â Â Â Â Â Â Â Â Â Â dom.importStatusInitial.textContent = 'Error: CSV debe tener columnas "nombre" y "curso" (turno opcional).';
Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â await deleteAllStudents();
Â Â Â Â Â Â Â Â Â Â const mapped = results.data.map(r => {
Â Â Â Â Â Â Â Â Â Â Â Â const rawShift = (r.turno || r.shift || '').toString().trim();
Â Â Â Â Â Â Â Â Â Â Â Â let shift = '';
Â Â Â Â Â Â Â Â Â Â Â Â if (rawShift) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (/primer/i.test(rawShift)) shift = 'Primer Turno (Infantil)';
Â Â Â Â Â Â Â Â Â Â Â Â Â Â else if (/segund/i.test(rawShift)) shift = 'Segundo Turno (Primaria)';
Â Â Â Â Â Â Â Â Â Â Â Â Â Â else shift = rawShift;
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â return { name: (r.nombre||'').toString().trim(), course: (r.curso||'').toString().trim(), shift, status: shift ? 'fixed' : 'sporadic', allergic: false };
Â Â Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â Â Â const added = await addStudentBatch(mapped);
Â Â Â Â Â Â Â Â Â Â dom.importStatusInitial.textContent = `ImportaciÃ³n completa âœ… (${added})`;
Â Â Â Â Â Â Â Â Â Â appState.students = await fetchStudents();
Â Â Â Â Â Â Â Â Â Â if (appState.currentShift) await renderCourses(appState.currentShift);
Â Â Â Â Â Â Â Â } catch (err) {
Â Â Â Â Â Â Â Â Â Â console.error('CSV import error', err);
Â Â Â Â Â Â Â Â Â Â dom.importStatusInitial.textContent = 'Error al procesar CSV. Mira la consola.';
Â Â Â Â Â Â Â Â } finally { setTimeout(()=>dom.importStatusInitial.textContent='',5000); }
Â Â Â Â Â Â },
Â Â Â Â Â Â error: (err) => { console.error(err); dom.importStatusInitial.textContent = 'Error leyendo CSV'; setTimeout(()=>dom.importStatusInitial.textContent='',3000); }
Â Â Â Â });
Â Â }

Â Â /* ----- Export CSV ----- */
Â Â async function exportFullDayCsv(dateStr) {
Â Â Â Â const all = await fetchStudents();
Â Â Â Â const attendance = await fetchAttendanceByDate(dateStr);
Â Â Â Â const rows = all.map(s => ({ Fecha: dateStr, Turno: s.shift || '(EsporÃ¡dico)', Nombre: s.name, Curso: s.course, Estado: attendance[s.id] || 'pending' }));
Â Â Â Â rows.sort((a,b) => (a.Turno||'').localeCompare(b.Turno||'') || a.Curso.localeCompare(b.Curso) || a.Nombre.localeCompare(b.Nombre));
Â Â Â Â const csv = Papa.unparse(rows);
Â Â Â Â const blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' });
Â Â Â Â const url = URL.createObjectURL(blob);
Â Â Â Â const a = document.createElement('a'); a.href = url; a.download = `asistencia_${dateStr}.csv`; a.click(); URL.revokeObjectURL(url);
Â Â }

Â Â /* ----- Finalizar turno ----- */
Â Â async function finalizeShift() {
Â Â Â Â if (!confirm('Â¿Seguro que quieres finalizar el turno? Los pendientes pasarÃ¡n a ausentes.')) return;
Â Â Â Â const today = new Date().toISOString().slice(0,10);
Â Â Â Â const toMark = [];
Â Â Â Â for (const id in appState.attendance) {
Â Â Â Â Â Â if (appState.attendance[id] === 'pending') {
Â Â Â Â Â Â Â Â appState.attendance[id] = 'absent';
Â Â Â Â Â Â Â Â toMark.push(id);
Â Â Â Â Â Â Â Â const el = document.querySelector(`[data-student-id="${id}"]`); if (el) { el.classList.remove('pending','present'); el.classList.add('absent'); }
Â Â Â Â Â Â }
Â Â Â Â }
Â Â Â Â await logBatchAttendance(toMark, today, 'absent');
Â Â Â Â updateSummary();
Â Â }

Â Â /* ----- History ----- */
Â Â async function showHistoryModal() {
Â Â Â Â document.getElementById('history-modal').classList.add('active');
Â Â Â Â dom.historyStudentList.innerHTML = '<p class="small-muted">Cargando...</p>';
Â Â Â Â const all = await fetchStudents(); all.sort((a,b)=>a.name.localeCompare(b.name));
Â Â Â Â if (!all.length) dom.historyStudentList.innerHTML = '<p class="small-muted">No hay alumnos registrados.</p>';
Â Â Â Â else dom.historyStudentList.innerHTML = all.map(s => `<div class="history-student p-2" data-id="${s.id}" data-name="${s.name}" style="border-bottom:1px solid var(--card-border);padding:8px;cursor:pointer"><strong>${s.name}</strong><div class="small-muted">${s.shift || '(EsporÃ¡dico)'} â€¢ ${s.course}</div></div>`).join('');
Â Â }
Â Â async function showStudentHistory(id, name) {
Â Â Â Â dom.historyStudentName.textContent = `Historial de: ${name}`;
Â Â Â Â dom.historyDatesList.innerHTML = '<p class="small-muted">Buscando...</p>';
Â Â Â Â const snap = await db.collection('attendance').where('studentId','==',id).get();
Â Â Â Â const dates = snap.docs.map(d=>d.data().date).sort().reverse();
Â Â Â Â dom.historyDatesList.innerHTML = dates.length ? dates.map(d=>`<div style="padding:6px;border-bottom:1px solid var(--card-border)">${new Date(d+'T00:00:00').toLocaleDateString('es-ES',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}</div>`).join('') : '<p class="small-muted">Sin registros.</p>';
Â Â }

Â Â /* ----- Monthly report + print ----- */
Â Â async function generateMonthlyReport(ym) {
Â Â Â Â dom.monthlyReportContent.innerHTML = '<p class="small-muted">Generando informe...</p>';
Â Â Â Â if (!ym) { dom.monthlyReportContent.innerHTML = '<p style="color:#b45309">Selecciona un mes.</p>'; return; }
Â Â Â Â const [y,m] = ym.split('-').map(v=>parseInt(v,10)); const days = new Date(y,m,0).getDate();
Â Â Â Â const all = await fetchStudents(); const attendanceData = await fetchAttendanceByMonth(ym);
Â Â Â Â const byCourse = all.reduce((acc,s)=>{ (acc[s.course]=acc[s.course]||[]).push(s); return acc; },{});
Â Â Â Â let html = `<div class="printable-area"><h2 style="text-align:center">${new Date(y,m-1,1).toLocaleString('es-ES',{month:'long',year:'numeric'})}</h2>`;
Â Â Â Â Object.keys(byCourse).sort().forEach(course=>{
Â Â Â Â Â Â const students = byCourse[course].sort((a,b)=>a.name.localeCompare(b.name));
Â Â Â Â Â Â html += `<div class="report-wrapper" style="margin-top:12px"><div style="display:flex;justify-content:space-between;align-items:center"><strong>${course}</strong><small>DÃ­as: ${days} â€” ${students.length} alumnos</small></div><div style="overflow:auto;margin-top:8px"><table class="report-table"><thead><tr><th>Alumno</th>`;
Â Â Â Â Â Â for(let d=1; d<=days; d++) html += `<th>${d}</th>`; html += `<th>Total</th></tr></thead><tbody>`;
Â Â Â Â Â Â students.forEach(st=>{
Â Â Â Â Â Â Â Â const attended = attendanceData.get(st.id) || new Set();
Â Â Â Â Â Â Â Â html += `<tr><td style="text-align:left;padding-left:6px">${st.name}</td>`;
Â Â Â Â Â Â Â Â for (let d=1; d<=days; d++) html += attended.has(d) ? `<td><span class="attendance-mark">âœ“</span></td>` : `<td></td>`;
Â Â Â Â Â Â Â Â html += `<td class="total">${attended.size}</td></tr>`;
Â Â Â Â Â Â });
Â Â Â Â Â Â html += `</tbody></table></div></div>`;
Â Â Â Â });
Â Â Â Â html += `</div>`;
Â Â Â Â dom.monthlyReportContent.innerHTML = html;
Â Â }

Â Â dom.printReportBtn.addEventListener('click', async () => {
Â Â Â Â let ym = dom.reportMonthInput.value;
Â Â Â Â if (!ym) { const now = new Date(); ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`; dom.reportMonthInput.value = ym; }
Â Â Â Â await generateMonthlyReport(ym);
Â Â Â Â const content = dom.monthlyReportContent.innerHTML;
Â Â Â Â const styles = Array.from(document.styleSheets).map(s => Array.from(s.cssRules).map(r => r.cssText).join('\n')).join('\n');
Â Â Â Â const iframe = document.createElement('iframe'); iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0'; iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
Â Â Â Â document.body.appendChild(iframe);
Â Â Â Â const doc = iframe.contentWindow.document;
Â Â Â Â doc.open(); doc.write(`<!doctype html><html><head><meta charset="utf-8"><title>Imprimir informe ${ym}</title><style>${styles}</style></head><body>${content}</body></html>`); doc.close();
Â Â Â Â setTimeout(()=>{ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); } catch(e){ console.error(e); alert('Error al imprimir: '+e.message);} setTimeout(()=>{ try{ document.body.removeChild(iframe); } catch(e){} },800); },300);
Â Â });

Â Â /* ----- Manage students modal (admin) ----- */
Â Â async function openManageStudentsModal() {
Â Â Â Â dom.manageStudentsModal.classList.add('active');
Â Â Â Â dom.manageStudentsContent.innerHTML = '<p class="small-muted">Cargando...</p>';
Â Â Â Â const all = await fetchStudents(); const byCourse = all.reduce((acc,s)=>{ (acc[s.course]=acc[s.course]||[]).push(s); return acc; },{});
Â Â Â Â let html = '';
Â Â Â Â Object.keys(byCourse).sort().forEach(course=>{
Â Â Â Â Â Â html += `<h4 style="margin-top:12px;color:var(--brand)">${course}</h4>`;
Â Â Â Â Â Â byCourse[course].sort((a,b)=>a.name.localeCompare(b.name)).forEach(s=>{
Â Â Â Â Â Â Â Â const checkedPrimer = s.shift === 'Primer Turno (Infantil)' ? 'checked' : '';
Â Â Â Â Â Â Â Â const checkedSegundo = s.shift === 'Segundo Turno (Primaria)' ? 'checked' : '';
Â Â Â Â Â Â Â Â const isAllergic = s.allergic ? 'checked' : '';
Â Â Â Â Â Â Â Â const isSporadic = !s.shift || s.shift.trim()==='';
Â Â Â Â Â Â Â Â html += `<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;padding:8px;border-bottom:1px solid var(--card-border);align-items:center">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <div><strong>${s.name}</strong></div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <div style="display:flex;gap:8px;align-items:center">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" class="student-shift-checkbox" data-id="${s.id}" data-prop="primer" ${checkedPrimer}> Primer</label>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" class="student-shift-checkbox" data-id="${s.id}" data-prop="segundo" ${checkedSegundo}> Segundo</label>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <div style="display:flex;justify-content:flex-end;gap:8px;align-items:center">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" class="student-update-control" data-id="${s.id}" data-prop="allergic" ${isAllergic}> Alergia</label>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <button class="toggle-status-btn ghost small" data-id="${s.id}" data-status="${s.status||'fixed'}">${isSporadic ? 'Hacer Fijo' : 'Hacer EsporÃ¡dico'}</button>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â </div>`;
Â Â Â Â Â Â });
Â Â Â Â });
Â Â Â Â dom.manageStudentsContent.innerHTML = html;

Â Â Â Â // event listeners
Â Â Â Â dom.manageStudentsContent.querySelectorAll('.student-shift-checkbox').forEach(cb => {
Â Â Â Â Â Â cb.addEventListener('change', async (ev) => {
Â Â Â Â Â Â Â Â const id = ev.target.dataset.id;
Â Â Â Â Â Â Â Â const primer = dom.manageStudentsContent.querySelector(`input.student-shift-checkbox[data-id="${id}"][data-prop="primer"]`).checked;
Â Â Â Â Â Â Â Â const segundo = dom.manageStudentsContent.querySelector(`input.student-shift-checkbox[data-id="${id}"][data-prop="segundo"]`).checked;
Â Â Â Â Â Â Â Â let newShift = '';
Â Â Â Â Â Â Â Â if (primer && !segundo) newShift = 'Primer Turno (Infantil)';
Â Â Â Â Â Â Â Â else if (!primer && segundo) newShift = 'Segundo Turno (Primaria)';
Â Â Â Â Â Â Â Â else newShift = '';
Â Â Â Â Â Â Â Â const ok = await updateStudentDoc(id, { shift: newShift, status: newShift ? 'fixed' : 'sporadic' });
Â Â Â Â Â Â Â Â if (ok) { const s = appState.students.find(x=>x.id===id); if (s) { s.shift = newShift; s.status = newShift ? 'fixed' : 'sporadic'; } dom.importStatusInitial.textContent = 'Guardado'; setTimeout(()=>dom.importStatusInitial.textContent='',1200); }
Â Â Â Â Â Â });
Â Â Â Â });

Â Â Â Â dom.manageStudentsContent.querySelectorAll('.student-update-control[data-prop="allergic"]').forEach(cb => {
Â Â Â Â Â Â cb.addEventListener('change', async (ev) => {
Â Â Â Â Â Â Â Â const id = ev.target.dataset.id; const val = !!ev.target.checked; const ok = await updateStudentDoc(id,{ allergic: val });
Â Â Â Â Â Â Â Â if (ok) { const s = appState.students.find(x=>x.id===id); if (s) s.allergic = val; dom.importStatusInitial.textContent = 'Guardado'; setTimeout(()=>dom.importStatusInitial.textContent='',1200); }
Â Â Â Â Â Â });
Â Â Â Â });

Â Â Â Â dom.manageStudentsContent.querySelectorAll('.toggle-status-btn').forEach(btn => {
Â Â Â Â Â Â btn.addEventListener('click', async (ev) => {
Â Â Â Â Â Â Â Â const id = ev.target.dataset.id; const current = ev.target.dataset.status || 'fixed';
Â Â Â Â Â Â Â Â if (current === 'sporadic') {
Â Â Â Â Â Â Â Â Â Â const ok = await updateStudentDoc(id, { status: 'fixed' });
Â Â Â Â Â Â Â Â Â Â if (ok) { ev.target.dataset.status = 'fixed'; ev.target.textContent = 'Hacer EsporÃ¡dico'; dom.importStatusInitial.textContent='Guardado'; setTimeout(()=>dom.importStatusInitial.textContent='',1200); }
Â Â Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â Â Â const ok = await updateStudentDoc(id, { status: 'sporadic', shift: '' });
Â Â Â Â Â Â Â Â Â Â if (ok) {
Â Â Â Â Â Â Â Â Â Â Â Â ev.target.dataset.status = 'sporadic'; ev.target.textContent = 'Hacer Fijo';
Â Â Â Â Â Â Â Â Â Â Â Â const p = dom.manageStudentsContent.querySelector(`input.student-shift-checkbox[data-id="${id}"][data-prop="primer"]`);
Â Â Â Â Â Â Â Â Â Â Â Â const sbox = dom.manageStudentsContent.querySelector(`input.student-shift-checkbox[data-id="${id}"][data-prop="segundo"]`);
Â Â Â Â Â Â Â Â Â Â Â Â if (p) p.checked=false; if (sbox) sbox.checked=false;
Â Â Â Â Â Â Â Â Â Â Â Â dom.importStatusInitial.textContent='Guardado'; setTimeout(()=>dom.importStatusInitial.textContent='',1200);
Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â });
Â Â Â Â });

Â Â }

Â Â dom.closeManageModal.addEventListener('click', ()=> dom.manageStudentsModal.classList.remove('active'));

Â Â /* ----- Delegation inside courses (picker / attendance) ----- */
Â Â dom.coursesContainer.addEventListener('click', async (e) => {
Â Â Â Â const openPickerBtn = e.target.closest('.open-sporadic-picker');
Â Â Â Â if (openPickerBtn) { openSporadicPickerModal(openPickerBtn.dataset.course); return; }

Â Â Â Â const studentDiv = e.target.closest('.student-item');
Â Â Â Â if (!studentDiv) return;
Â Â Â Â const studentId = studentDiv.dataset.studentId || studentDiv.id;
Â Â Â Â const isX = e.target.closest('.mark-absent-btn');
Â Â Â Â const current = appState.attendance[studentId] || 'pending';
Â Â Â Â const newState = isX ? (current === 'absent' ? 'pending' : 'absent') : (current === 'present' ? 'pending' : 'present');
Â Â Â Â appState.attendance[studentId] = newState;
Â Â Â Â studentDiv.classList.remove('pending','present','absent'); studentDiv.classList.add(newState);
Â Â Â Â updateSummary();
Â Â Â Â try { await logAttendance(studentId, new Date().toISOString().slice(0,10), newState); } catch(err){ console.error('logAttendance error', err); }
Â Â });

Â Â /* ----- Routing & UI visibility (default to profesor) ----- */
Â Â function setUIForRole(isAdmin) {
Â Â Â Â if (isAdmin) {
Â Â Â Â Â Â dom.roleDisplay.textContent = 'Admin: ' + (auth.currentUser ? (auth.currentUser.displayName || 'Admin') : 'Admin');
Â Â Â Â Â Â document.querySelectorAll('.admin-only').forEach(el=>el.style.display='block');
Â Â Â Â Â Â dom.logoutBtn.style.display = 'inline-flex';
Â Â Â Â } else {
Â Â Â Â Â Â dom.roleDisplay.textContent = 'Modo: Profesor / Cuidador';
Â Â Â Â Â Â document.querySelectorAll('.admin-only').forEach(el=>el.style.display='none');
Â Â Â Â Â Â dom.logoutBtn.style.display = 'none';
Â Â Â Â }
Â Â Â Â document.getElementById('dashboard').classList.add('hidden');
Â Â Â Â document.getElementById('shift-selection').style.display = 'block';
Â Â }

Â Â auth.onAuthStateChanged(user => {
Â Â Â Â const isAdmin = user && !user.isAnonymous;
Â Â Â Â setUIForRole(isAdmin);
Â Â });

Â Â /* ----- Controls wiring ----- */
Â Â dom.loginAdminBtn.addEventListener('click', ()=> auth.signInWithPopup(googleProvider).catch(e=>{ console.error(e); alert('Error login'); }));
Â Â dom.logoutBtn.addEventListener('click', ()=> auth.signOut().then(()=>{ setUIForRole(false); }));
Â Â dom.importCsvBtnInitial.addEventListener('click', ()=> dom.csvFileInput.click());
Â Â dom.csvFileInput.addEventListener('change', e => handleCsvImport(e.target.files[0]));
Â Â dom.manageStudentsBtn.addEventListener('click', openManageStudentsModal);
Â Â dom.wipeDbBtn.addEventListener('click', async ()=> { if (!confirm('Â¿Borrar todos los alumnos?')) return; await deleteAllStudents(); appState.students = []; if (appState.currentShift) renderCourses(appState.currentShift); });
Â Â dom.exportCsvBtn.addEventListener('click', ()=> { const d = dom.exportDateInput.value || new Date().toISOString().slice(0,10); exportFullDayCsv(d); });

Â Â document.querySelectorAll('#shift-buttons button').forEach(btn => btn.addEventListener('click', ()=> renderCourses(btn.dataset.shift)));
Â Â dom.finalizeShiftBtn.addEventListener('click', finalizeShift);
Â Â dom.backToShiftsBtn.addEventListener('click', ()=> { document.getElementById('shift-selection').style.display='block'; document.getElementById('dashboard').classList.add('hidden'); });

Â Â document.getElementById('show-monthly-report-btn')?.addEventListener('click', async ()=> {
Â Â Â Â const now = new Date(); const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
Â Â Â Â dom.reportMonthInput.value = ym; dom.monthlyReportModal.classList.add('active'); await generateMonthlyReport(ym);
Â Â });

Â Â document.getElementById('show-history-btn')?.addEventListener('click', showHistoryModal);
Â Â document.getElementById('close-history-btn')?.addEventListener('click', ()=> document.getElementById('history-modal').classList.remove('active'));
Â Â dom.historyStudentList.addEventListener('click', ev => { const row = ev.target.closest('.history-student'); if (!row) return; showStudentHistory(row.dataset.id, row.dataset.name); });
Â Â dom.historySearch.addEventListener('input', (e)=>{ const q=e.target.value.toLowerCase(); document.querySelectorAll('#history-student-list .history-student').forEach(el=> el.style.display = (el.dataset.name.toLowerCase().includes(q)?'':'none')); });

Â Â document.getElementById('close-report-btn')?.addEventListener('click', ()=> dom.monthlyReportModal.classList.remove('active'));

Â Â window.addEventListener('error', ev => console.error('GLOBAL ERROR:', ev.message));
Â Â window.addEventListener('unhandledrejection', ev => console.error('UNHANDLED REJECTION:', ev.reason));

Â Â setUIForRole(false);
Â Â document.getElementById('export-date-input').value = new Date().toISOString().slice(0,10);

Â Â if ('serviceWorker' in navigator) { navigator.serviceWorker.register && navigator.serviceWorker.register('/sw.js').then(()=>console.log('sw registered')).catch(()=>{}); }

}); // DOMContentLoaded
</script>
</body>
</html>

