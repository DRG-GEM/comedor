<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestor de Comedor Escolar</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', sans-serif; }
.admin-only { display: none; }
.user-only { display: none; }
.student-item { transition: all 0.2s ease-in-out; }
.student-item.pending { background-color: #374151; }
.student-item.present { background-color: #166534; transform: scale(1.02); }
.student-item.absent { background-color: #991b1b; text-decoration: line-through; opacity: 0.6; }
#role-selection-screen { backdrop-filter: blur(10px); }
#history-modal, #generic-modal { transition: opacity 0.3s ease; }
</style>
</head>
<body class="bg-gray-900 text-white antialiased">

<div id="role-selection-screen" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
  <div class="text-center bg-gray-800 p-8 rounded-lg shadow-2xl">
    <h2 class="text-3xl font-bold text-cyan-400 mb-6">¿Cómo quieres acceder?</h2>
    <div class="space-y-4">
      <button id="login-admin" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg text-lg">Soy Administrador</button>
      <button id="login-user" class="w-full bg-teal-600 hover:bg-teal-500 text-white font-bold py-3 px-6 rounded-lg text-lg">Soy Profesor / Cuidador</button>
    </div>
  </div>
</div>

<div id="app" class="container mx-auto p-4 md:p-8 max-w-7xl opacity-0 transition-opacity duration-500">
  <header class="text-center mb-8">
    <h1 class="text-4xl font-bold text-cyan-400">Gestor de Comedor</h1>
    <p id="role-display" class="text-gray-400 mt-2 font-semibold"></p>
  </header>

  <div id="shift-selection" class="text-center">
    <h2 class="text-2xl font-semibold mb-4">Elige un turno de comedor</h2>
    <div id="shift-buttons" class="flex flex-wrap justify-center gap-4">
      <button class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-6 rounded-lg text-lg" data-shift="Primer Turno (Infantil)">Primer Turno (Infantil)</button>
      <button class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-6 rounded-lg text-lg" data-shift="Segundo Turno (Primaria)">Segundo Turno (Primaria)</button>
    </div>
    <div class="mt-8 admin-only">
      <h3 class="text-xl font-semibold mb-4">Gestión de Datos</h3>
      <button id="import-csv-btn-initial" class="bg-green-600 hover:bg-green-500 font-bold py-3 px-6 rounded-lg">📤 Importar Alumnos (CSV)</button>
      <p id="import-status-initial" class="text-green-400 mt-2 h-6"></p>
      <button id="wipe-db" class="bg-red-600 hover:bg-red-500 font-bold py-2 px-4 rounded-lg mt-4">🗑️ Borrar todos los alumnos</button>
      <button id="export-csv" class="bg-yellow-600 hover:bg-yellow-500 font-bold py-2 px-4 rounded-lg mt-4">📥 Exportar CSV</button>
    </div>
  </div>

  <main id="dashboard" class="hidden">
    <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
      <button id="back-to-shifts" class="bg-gray-600 hover:bg-gray-500 font-bold py-2 px-4 rounded-lg">&larr; Cambiar Turno</button>
      <div class="flex flex-wrap gap-4">
        <button id="import-csv-btn-dashboard" class="bg-green-600 hover:bg-green-500 font-bold py-2 px-4 rounded-lg admin-only">📤 Importar Alumnos (CSV)</button>
        <button id="show-history" class="bg-indigo-600 hover:bg-indigo-500 font-bold py-2 px-4 rounded-lg admin-only">📜 Ver Historial Completo</button>
        <button id="reset-count" class="bg-amber-600 hover:bg-amber-500 font-bold py-2 px-4 rounded-lg">↻ Reiniciar Estados</button>
        <button id="export-csv-dashboard" class="bg-yellow-600 hover:bg-yellow-500 font-bold py-2 px-4 rounded-lg admin-only">📥 Exportar CSV</button>
      </div>
    </div>
    <p id="import-status-dashboard" class="text-center text-green-400 mb-4 h-6"></p>

    <section id="summary" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-gray-800 p-4 rounded-lg text-center"><h3 class="text-lg font-semibold text-gray-400">Comensales del Día</h3><p id="summary-diners" class="text-3xl font-bold">0</p></div>
      <div class="bg-red-800 bg-opacity-50 p-4 rounded-lg text-center"><h3 class="text-lg font-semibold text-red-300">Ausentes</h3><p id="summary-absent" class="text-3xl font-bold">0</p></div>
      <div class="bg-blue-800 bg-opacity-50 p-4 rounded-lg text-center"><h3 class="text-lg font-semibold text-blue-300">Pendientes</h3><p id="summary-pending" class="text-3xl font-bold">0</p></div>
      <div class="bg-green-800 bg-opacity-50 p-4 rounded-lg text-center"><h3 class="text-lg font-semibold text-green-300">PRESENTES</h3><p id="summary-present" class="text-3xl font-bold">0</p></div>
    </section>

    <section id="student-lists">
      <div id="courses-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>
  </main>
</div>

<input type="file" id="csv-file-input" class="hidden" accept=".csv">

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<!-- PapaParse CSV Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const firebaseConfig = {
    apiKey: "AIzaSyAeI9G1_2-E8Kghc-88bkrXa_VDJXeDyHo",
    authDomain: "comedorvp.firebaseapp.com",
    projectId: "comedorvp",
    storageBucket: "comedorvp.appspot.com",
    messagingSenderId: "821870274048",
    appId: "1:821870274048:web:62b85d28ceace395245ae5"
  };
  const appId = firebaseConfig.projectId;
  let db, auth, userRole = null;
  const appState = { currentShift: null, students: [], attendance: {} };
  let modalResolve = null;

  const dom = {
    roleScreen: document.getElementById('role-selection-screen'),
    app: document.getElementById('app'),
    roleDisplay: document.getElementById('role-display'),
    shiftSelection: document.getElementById('shift-selection'),
    dashboard: document.getElementById('dashboard'),
    coursesContainer: document.getElementById('courses-container'),
    csvFileInput: document.getElementById('csv-file-input'),
    importStatusInitial: document.getElementById('import-status-initial'),
    importStatusDashboard: document.getElementById('import-status-dashboard'),
    genericModal: null // por ahora no usado
  };

  function setUIVisibility() {
    dom.roleScreen.style.display = 'none';
    dom.app.classList.remove('opacity-0');
    document.querySelectorAll('.admin-only').forEach(el => el.style.display = (userRole==='admin')?'block':'none');
    document.querySelectorAll('.user-only').forEach(el => el.style.display = (userRole==='user')?'block':'none');
    dom.roleDisplay.textContent = userRole==='admin'?'Modo: Administrador':'Modo: Profesor / Cuidador';
  }

  async function initFirebase() {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    auth = firebase.auth();
    try{ await auth.signInAnonymously(); } catch(e){ console.error(e); }
  }

  function updateSummary() {
    const statuses = Object.values(appState.attendance);
    document.getElementById('summary-diners').textContent = statuses.length;
    document.getElementById('summary-absent').textContent = statuses.filter(s=>s==='absent').length;
    document.getElementById('summary-present').textContent = statuses.filter(s=>s==='present').length;
    document.getElementById('summary-pending').textContent = statuses.filter(s=>s==='pending').length;
  }

  function createStudentElement({id,name}) {
    return `<div id="${id}" class="student-item p-3 rounded-md cursor-pointer flex justify-between items-center mt-2 pending" data-student-id="${id}" data-student-name="${name}"><span>${name}</span><button class="mark-absent-btn bg-red-500 hover:bg-red-400 text-white font-bold w-6 h-6 rounded-full flex items-center justify-center">&times;</button></div>`;
  }

  async function fetchStudents(shift) {
    if(!db) return [];
    const snapshot = await db.collection("students").where("shift","==",shift).get();
    return snapshot.docs.map(d=>({id:d.id,...d.data()}));
  }

  async function addStudentBatch(students) {
    if(!db) return 0;
    const batch = db.batch();
    const coll = db.collection("students");
    students.forEach(s=>{
      if(s.name && s.course && s.shift) batch.set(coll.doc(),{name:s.name.trim(),course:s.course.trim(),shift:s.shift.trim()});
    });
    await batch.commit();
    return students.length;
  }

  async function handleCsvImport(file){
    if(!file) return;
    dom.importStatusInitial.textContent = 'Procesando archivo...';
    dom.importStatusDashboard.textContent = 'Procesando archivo...';

    Papa.parse(file,{
      header:true,
      skipEmptyLines:true,
      complete: async results=>{
        dom.csvFileInput.value = '';
        const headers = results.meta.fields.map(h=>h.toLowerCase().trim());
        if(!results.data.length||!headers.includes('name')||!headers.includes('course')||!headers.includes('shift')){
          dom.importStatusInitial.textContent = '❌ CSV inválido.';
          dom.importStatusDashboard.textContent = '❌ CSV inválido.';
          return;
        }
        await addStudentBatch(results.data);
        dom.importStatusInitial.textContent = `✅ Alumnos importados!`;
        dom.importStatusDashboard.textContent = `✅ Alumnos importados!`;
        if(appState.currentShift) renderCourses(appState.currentShift);
      },
      error: e=>{
        console.error(e);
        dom.importStatusInitial.textContent = '❌ Error leyendo CSV';
        dom.importStatusDashboard.textContent = '❌ Error leyendo CSV';
      }
    });
  }

  async function renderCourses(shift){
    appState.currentShift = shift;
    dom.shiftSelection.classList.add('hidden');
    dom.dashboard.classList.remove('hidden');
    dom.coursesContainer.innerHTML = '<p class="text-center">Cargando...</p>';
    appState.students = await fetchStudents(shift);
    appState.attendance = {};
    appState.students.forEach(s=>appState.attendance[s.id]='pending');
    dom.coursesContainer.innerHTML = '';
    const courses = [...new Set(appState.students.map(s=>s.course))];
    if(!courses.length){
      dom.coursesContainer.innerHTML='<p class="text-center">No hay alumnos.</p>';
      return;
    }
    courses.forEach(course=>{
      const div = document.createElement('div');
      div.className='bg-gray-800 rounded-lg p-4 shadow-lg flex flex-col';
      div.innerHTML = `<h3 class="text-xl font-bold text-cyan-300 mb-3">${course}</h3>
        <div class="space-y-2" data-course-list="${course}">${appState.students.filter(s=>s.course===course).map(createStudentElement).join('')}</div>
        <button class="add-student-btn mt-4 bg-blue-600 hover:bg-blue-500 font-bold py-2 px-4 rounded-lg" data-course="${course}">+ Añadir Alumno</button>`;
      dom.coursesContainer.appendChild(div);
    });
    updateSummary();
  }

  async function saveAttendanceToFirestore(){
    if(!appState.currentShift) return;
    const dateStr = new Date().toISOString().split('T')[0];
    const coll = db.collection("attendance").doc(appState.currentShift).collection(dateStr);
    const batch = db.batch();
    appState.students.forEach(s=>{
      const state = appState.attendance[s.id];
      if(state==='present'||state==='absent'){
        batch.set(coll.doc(s.id),{
          name: s.name,
          course: s.course,
          status: state,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    });
    await batch.commit();
    console.log(`Asistencia guardada: ${dateStr}, turno: ${appState.currentShift}`);
  }

  async function exportCsvByDate(dateStr, shift){
    const coll = db.collection("attendance").doc(shift).collection(dateStr);
    const snapshot = await coll.get();
    if(snapshot.empty){ alert(`No hay datos para ${shift} el ${dateStr}`); return; }
    let rows = [];
    ['present','absent'].forEach(status=>{
      snapshot.docs.filter(d=>d.data().status===status).forEach(doc=>{
        const s = doc.data();
        rows.push({fecha: dateStr, turno: shift, nombre: s.name, curso: s.course, estado: status.toUpperCase()});
      });
    });
    const csv = Papa.unparse(rows);
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.setAttribute("download", `asistencia_${shift.replace(/ /g,'_')}_${dateStr}.csv`);
    link.click();
  }

  function setStudentState(id,state){
    appState.attendance[id]=state;
    const el = document.getElementById(id);
    if(el) el.className=`student-item p-3 rounded-md cursor-pointer flex justify-between items-center mt-2 ${state}`;
    updateSummary();
    saveAttendanceToFirestore();
  }

  dom.csvFileInput.addEventListener('change', e=>handleCsvImport(e.target.files[0]));

  document.getElementById('import-csv-btn-initial').addEventListener('click', ()=>dom.csvFileInput.click());
  document.getElementById('import-csv-btn-dashboard').addEventListener('click', ()=>dom.csvFileInput.click());

  document.getElementById('wipe-db').addEventListener('click', async ()=>{
    if(!confirm('¿Seguro que quieres borrar todos los alumnos?')) return;
    const snapshot = await db.collection("students").get();
    const batch = db.batch();
    snapshot.docs.forEach(doc=>batch.delete(doc.ref));
    await batch.commit();
    alert('Todos los alumnos eliminados!');
    if(appState.currentShift) renderCourses(appState.currentShift);
  });

  document.getElementById('export-csv').addEventListener('click', async ()=>{
    if(!appState.currentShift) return;
    const today = new Date().toISOString().split('T')[0];
    const date = prompt('Introduce la fecha a exportar (yyyy-mm-dd):', today);
    if(!date) return;
    await exportCsvByDate(date, appState.currentShift);
  });

  document.getElementById('export-csv-dashboard').addEventListener('click', async ()=>{
    if(!appState.currentShift) return;
    const today = new Date().toISOString().split('T')[0];
    const date = prompt('Introduce la fecha a exportar (yyyy-mm-dd):', today);
    if(!date) return;
    await exportCsvByDate(date, appState.currentShift);
  });

  document.getElementById('back-to-shifts').addEventListener('click', ()=>{
    dom.dashboard.classList.add('hidden');
    dom.shiftSelection.classList.remove('hidden');
  });

  document.getElementById('reset-count').addEventListener('click', ()=>{
    Object.keys(appState.attendance).forEach(k=>appState.attendance[k]='pending');
    document.querySelectorAll('.student-item').forEach(el=>el.className='student-item p-3 rounded-md cursor-pointer flex justify-between items-center mt-2 pending');
    updateSummary();
  });

  document.getElementById('login-admin').addEventListener('click', async ()=>{
    userRole='admin';
    await initFirebase();
    setUIVisibility();
  });

  document.getElementById('login-user').addEventListener('click', async ()=>{
    userRole='user';
    await initFirebase();
    setUIVisibility();
  });

  dom.coursesContainer.addEventListener('click', e=>{
    const studentEl = e.target.closest('.student-item');
    if(studentEl){
      const id = studentEl.dataset.studentId;
      const current = appState.attendance[id];
      const next = current==='pending'?'present':current==='present'?'absent':'pending';
      setStudentState(id,next);
    }
    if(e.target.classList.contains('add-student-btn')){
      const course = e.target.dataset.course;
      const name = prompt('Nombre del alumno:');
      if(!name) return;
      const newStudent = {name:name.trim(), course, shift: appState.currentShift};
      addStudentBatch([newStudent]).then(()=>renderCourses(appState.currentShift));
    }
  });

});
</script>
</body>
</html>
