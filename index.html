<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gestor de Comedor Escolar</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<meta name="theme-color" content="#ffffff">

<style>
:root{
  --bg:#f6f7f9; --paper:#fff; --text:#0f172a; --muted:#6b7280;
  --brand:#8b0630; --brand-dark:#700424; --accent:#19b4d6; --success:#004623; --danger:#c92a2a;
  --card-border: rgba(15,23,42,0.06);
}
*{box-sizing:border-box}
html,body{width:100%; overflow-x:hidden; -webkit-overflow-scrolling:touch;}
body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:var(--text); margin:0; -webkit-font-smoothing:antialiased;}
.container { max-width:1100px; width:100%; margin:0 auto; padding:20px; box-sizing:border-box; }
.header-row { display:flex; align-items:center; justify-content:space-between; gap:12px; }
.logo { width:54px;height:54px;border-radius:10px;background:#fff;display:inline-flex;align-items:center;justify-content:center;box-shadow:0 6px 20px rgba(15,23,42,0.04);border:1px solid var(--card-border); }
.title-wrap { text-align:center; flex:1; min-width:0; }
h1 { margin:8px 0 0; color:var(--brand); font-weight:800; font-size:28px; }
.subtle { color:var(--muted); }

.header-actions { display:flex; gap:8px; align-items:center; justify-content:flex-end; min-width:150px; }

/* Paneles */
.admin-panel { background:var(--paper); border-radius:12px; padding:18px; border:1px solid var(--card-border); box-shadow:0 14px 36px rgba(15,23,42,0.04); margin-top:18px; overflow:hidden; }
.btn-row { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
button.primary { background:linear-gradient(180deg,var(--brand),var(--brand-dark)); color:#fff; padding:10px 16px; border-radius:999px; font-weight:700; border:0; cursor:pointer; white-space:nowrap; }
button.ghost { background:#fff; border:1px solid rgba(15,23,42,0.06); padding:10px 14px; border-radius:10px; cursor:pointer; }
button.small { padding:6px 8px; font-size:0.9rem; border-radius:8px; }

/* Summary + grid */
.summary-card { background:var(--paper); padding:14px; border-radius:10px; border:1px solid var(--card-border); box-shadow:0 10px 30px rgba(15,23,42,0.03); text-align:center; }
#courses-container { margin-top:14px; display:grid; gap:14px; grid-template-columns: repeat(auto-fill, minmax(260px,1fr)); }

/* Course card */
.course-card { background:var(--paper); border-radius:10px; padding:12px; border:1px solid var(--card-border); box-shadow:0 8px 24px rgba(15,23,42,0.03); display:flex; flex-direction:column; gap:8px; overflow:hidden; min-width:0; }
.course-card h3 { color:var(--brand); margin:0; font-weight:700; white-space:normal; }

/* Student item */
.student-item {
  background:#ffffff;
  border-radius:10px;
  padding:12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  border:1px solid rgba(15,23,42,0.04);
  transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
  cursor: pointer;
}

.student-item .name, .student-item .student-name {
  max-width:100%;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  font-weight: 500;
}


/* ======================================================= */
/* == ESTADOS DE ALUMNO (V5 - L√ìGICA SIMPLIFICADA Y ROBUSTA) == */
/* ======================================================= */

/* --- 1. ESTADO POR DEFECTO (PENDIENTE) --- */
.student-item.pending {
  background-color: #f8f9fa; /* Fondo gris claro */
  color: #374151; /* Texto oscuro */
}

/* --- 2. ESTADO SELECCIONADO (PRESENTE) --- */
.student-item.present {
  background-color: #004623; /* Fondo VERDE OSCURO */
  color: #ffffff !important; /* Texto blanco */
  transform: scale(1.02); /* Efecto sutil de selecci√≥n */
  box-shadow: 0 4px 12px rgba(0, 70, 35, 0.2);
}
.student-item.present * {
  color: #ffffff !important;
}

/* --- 3. ESTADO AUSENTE --- */
.student-item.absent {
  background-color: #b91c1c; /* Fondo ROJO OSCURO */
  color: #ffffff !important; /* Texto blanco */
  text-decoration: line-through;
  opacity: 0.85;
}
.student-item.absent * {
  color: #ffffff !important;
}

/* --- 4. MODIFICADOR DE ALERGIA (M√ÅXIMA PRIORIDAD VISUAL) --- */
/* Un rect√°ngulo amarillo muy visible alrededor del nombre, SIEMPRE. */
.student-item .name.allergic {
  border: 3px solid #facc15; /* Borde amarillo grueso */
  background-color: #fef9c3; /* Relleno amarillo p√°lido */
  color: #3d2300 !important; /* Texto muy oscuro para contraste */
  padding: 4px 8px;
  border-radius: 6px;
  font-weight: 700 !important;
}

/* ======================================================= */
/* == FIN DE LA SECCI√ìN DE ESTADOS == */
/* ======================================================= */

.student-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
}

.mark-absent-btn { width:40px; height:40px; border-radius:8px; border:1px solid rgba(0,0,0,0.04); background:#fff; font-weight:700; cursor:pointer; }
.report-wrapper { background:var(--paper); border-radius:12px; padding:10px; border:1px solid var(--card-border); box-shadow:0 10px 30px rgba(15,23,42,0.03); overflow:auto; -webkit-overflow-scrolling:touch; }
.report-table { width:100%; border-collapse:collapse; font-size:13px; min-width:700px; }
.report-table th, .report-table td { border:1px solid rgba(15,23,42,0.06); padding:6px 6px; text-align:center; min-width:28px; }
.report-table thead th { background:#fff; position:sticky; top:0; z-index:2; }
.report-table td.total { font-weight:700; color:var(--brand); }
.attendance-mark { display:inline-flex; align-items:center; justify-content:center; width:20px;height:20px;border-radius:50%; background:var(--success); color:#fff; font-weight:700; }
.fixed-modal { position:fixed; left:0; top:0; width:100%; height:100%; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.28); z-index:90; padding:12px; box-sizing:border-box; }
.fixed-modal.active { display:flex; }
.modal-content { background:#fff; border-radius:12px; padding:16px; width:92%; max-width:840px; max-height:90vh; overflow:auto; box-shadow:0 18px 40px rgba(0,0,0,0.12); min-width:0; }
.small-muted { color:var(--muted); font-size:0.85rem; }
img, svg { max-width:100%; height:auto; display:block; }
@media (max-width:800px){ #courses-container { grid-template-columns:1fr; } }
@media (max-width:600px){
  .container { padding:12px; }
  .header-row { flex-direction:column; align-items:flex-start; gap:8px; }
  .title-wrap { text-align:left; width:100%; }
  h1 { font-size:20px; margin:4px 0 0; }
  .header-actions { width:100%; justify-content:flex-start; }
  .admin-panel { padding:12px; }
  .btn-row { justify-content:flex-start; }
  .course-card { padding:10px; }
  .course-card h3 { font-size:1rem; }
  .student-item { flex-direction:row; align-items:center; gap:10px; padding:10px; }
  .student-item .name { font-size:0.98rem; max-width:65%; }
  .mark-absent-btn { width:36px; height:36px; }
  .report-table th, .report-table td { font-size:11px; padding:4px; }
  .modal-content { width:96%; padding:12px; max-width:720px; }
  #shift-buttons button { padding:8px 12px; font-size:0.95rem; }
}
@media print{
  body * { visibility:hidden; }
  .printable-area, .printable-area * { visibility:visible; }
  .printable-area { position:absolute; left:0; top:0; width:100%; background:#fff; padding:8px; }
  @page { size: landscape; margin:0.4cm; }
}
.hidden { display:none !important; }
#dashboard > section:first-of-type { display: flex !important; gap: 10px; justify-content: center; align-items: center; flex-wrap: wrap; margin-bottom: 12px; padding: 0 6px; box-sizing: border-box; }
.summary-card { flex: 0 1 160px; max-width: 180px; min-width: 120px; padding: 10px; text-align: center; display: flex; flex-direction: column; gap: 6px; justify-content: center; align-items: center; }
.summary-card > div[style] { font-size: 20px !important; font-weight: 800 !important; line-height: 1; }
.summary-card .small-muted { font-size: 0.78rem; }
#courses-container { width: 100%; box-sizing: border-box; overflow-x: hidden; }
@media (max-width: 600px) {
  .summary-card { flex: 0 1 140px; max-width: 160px; min-width: 110px; padding: 8px; }
  .summary-card > div[style] { font-size: 18px !important; }
  .container { padding-left: 12px; padding-right: 12px; }
  .header-row { gap: 8px; }
  .student-item { padding-left: 10px; padding-right: 8px; }
  .student-item .name { max-width: 60%; font-size: 0.98rem; }
  #courses-container { padding-right: 6px; }
}
.main-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px 20px; text-align: center; min-height: calc(100vh - 60px); }
.app-title { font-size: 1.8rem; font-weight: 700; color: var(--primary, #8b0630); margin-bottom: 8px; }
.app-subtitle { font-size: 1.1rem; color: #374151; margin-bottom: 28px; }
.turn-buttons { display: flex; flex-wrap: wrap; gap: 16px; justify-content: center; }
.turn-btn { background: var(--primary, #8b0630); color: #fff; font-size: 1.1rem; font-weight: 600; padding: 14px 28px; border: none; border-radius: 9999px; cursor: pointer; transition: background 0.2s, transform 0.1s; min-width: 160px; }
.turn-btn:hover { background: #a50a3d; }
.turn-btn:active { transform: scale(0.97); }
@media (max-width: 500px) {
  .app-title { font-size: 1.5rem; }
  .app-subtitle { font-size: 1rem; margin-bottom: 20px; }
  .turn-btn { font-size: 1rem; padding: 12px 22px; min-width: 140px; }
}
.shift-selection { text-align: center; padding: 28px 12px; }
.main-hero-title { font-size: 1.6rem; font-weight: 700; color: var(--brand); margin: 0 0 18px 0; }
.turn-cards { display: flex; gap: 20px; justify-content: center; align-items: stretch; flex-wrap: wrap; margin: 0 auto; max-width: 920px; padding: 8px; box-sizing: border-box; }
.turn-card { position: relative; display: inline-flex; align-items: center; justify-content: center; width: 320px; height: 96px; padding: 0; border: none; border-radius: 20px; background: transparent; cursor: pointer; overflow: visible; box-shadow: 0 10px 30px rgba(11,15,27,0.04); transition: transform .12s ease, box-shadow .12s ease; -webkit-tap-highlight-color: transparent; }
.turn-card-bg { position: absolute; left: 0; right: 0; top: 0; bottom: 0; border-radius: 20px; background: linear-gradient(180deg, var(--brand), var(--brand-dark)); box-shadow: inset 0 1px 0 rgba(255,255,255,0.03); opacity: 1; z-index: 1; }
.turn-card-content { position: relative; z-index: 2; color: #fff; display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 14px 20px; }
.turn-icon { font-size: 20px; opacity: 0.95; }
.turn-label { font-size: 1.15rem; font-weight: 700; letter-spacing: 0.2px; }
.turn-sub { font-size: 0.82rem; opacity: 0.92; font-weight: 600; }
.turn-card:hover { transform: translateY(-4px); box-shadow: 0 18px 40px rgba(11,15,27,0.06); }
.turn-card:active { transform: translateY(-1px) scale(.996); }
@media (max-width: 760px) {
  .turn-cards { gap: 12px; padding: 6px; }
  .turn-card { width: 260px; height: 88px; border-radius: 16px; }
  .turn-label { font-size: 1.02rem; }
  .turn-sub { font-size: 0.78rem; }
}
@media (max-width: 420px) {
  .turn-cards { flex-direction: column; gap: 12px; align-items: center; }
  .turn-card { width: calc(100% - 40px); max-width: 420px; height: 82px; }
}
.turn-card:focus { outline: 3px solid rgba(255,255,255,0.14); outline-offset: 3px; box-shadow: 0 18px 40px rgba(11,15,27,0.06), 0 0 0 4px rgba(139,6,48,0.08); }
@media (prefers-color-scheme: light) { .turn-card-bg { border: 1px solid rgba(255,255,255,0.06); } }
.header-row { display: grid; grid-template-columns: auto 1fr auto; gap: 16px; align-items: center; padding: 12px 0; min-height: 68px; }
.logo { width:56px; height:56px; border-radius:12px; display:inline-flex; align-items:center; justify-content:center; background:#fff; box-shadow:0 6px 20px rgba(15,23,42,0.04); border:1px solid rgba(15,23,42,0.06); flex:0 0 auto; }
.title-wrap { text-align:center; min-width:0; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; padding-left:6px; padding-right:6px; }
.title-wrap h1 { margin:0; font-size:20px; line-height:1; font-weight:800; color:var(--brand); letter-spacing:0.1px; }
.title-wrap .subtle, #role-display { margin:0; font-size:14px; color:var(--muted); font-weight:600; opacity:0.95; }
.header-actions { display:flex; gap:10px; align-items:center; justify-content:flex-end; flex:0 0 auto; }
.header-actions .ghost, .header-actions .primary { padding:8px 12px; font-size:0.95rem; border-radius:10px; box-shadow:0 6px 18px rgba(11,15,27,0.03); }
#logout-btn { display:inline-flex; align-items:center; gap:6px; }
@media (min-width:1100px) {
  .title-wrap h1 { font-size:22px; }
  .title-wrap .subtle { font-size:15px; }
}
@media (max-width:760px) {
  .header-row { grid-template-columns: auto 1fr; grid-auto-rows: auto; align-items: center; gap:8px; padding:10px 6px; }
  .header-actions { grid-column: 1 / -1; justify-content: flex-end; width:100%; }
  .title-wrap { text-align:left; align-items:flex-start; padding-left:0; }
  .title-wrap h1 { font-size:18px; }
  .title-wrap .subtle { font-size:13px; }
  .logo { width:48px; height:48px; border-radius:10px; }
}
.header-row, .container { box-sizing:border-box; overflow-x:visible; }

</style>
</head>
<body>

<div class="container">
  <header class="header-row" role="banner">
    <div class="logo" aria-hidden="true"><svg width="34" height="34" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><rect fill="#fff" width="48" height="48" rx="8"/><text x="50%" y="56%" font-size="16" fill="#8b0630" text-anchor="middle" font-family="Inter">CEVP</text></svg></div>

    <div class="title-wrap">
      <h1>Gestor de Comedor</h1>
      <div id="role-display" class="subtle">Cargando...</div>
    </div>

    <div class="header-actions">
      <button id="logout-btn" class="ghost small" title="Cerrar sesi√≥n" style="display:none">Cerrar sesi√≥n</button>
    </div>
  </header>

  <div id="admin-login-view" class="admin-panel hidden" style="max-width:640px;margin:14px auto 0">
    <h2 style="text-align:center">Acceso de Administrador</h2>
    <div style="text-align:center;margin-top:10px">
      <button id="login-admin-btn" class="primary">Iniciar sesi√≥n con Google</button>
    </div>
  </div>

  <div id="main-content" style="margin-top:18px">

    <section id="shift-selection" class="shift-selection" aria-labelledby="shift-title">
  <h2 id="shift-title" class="main-hero-title">Selecciona un turno</h2>

  <div id="shift-buttons" class="turn-cards" role="list" aria-label="Turnos disponibles">
    <button class="turn-card" role="listitem" data-shift="Primer Turno (Infantil)" aria-label="Primer Turno">
      <div class="turn-card-bg" aria-hidden="true"></div>
      <div class="turn-card-content">
        <div class="turn-icon" aria-hidden="true">üçΩÔ∏è</div>
        <div class="turn-label">Primer Turno</div>
        <div class="turn-sub">Marcar asistentes</div>
      </div>
    </button>

    <button class="turn-card" role="listitem" data-shift="Segundo Turno (Primaria)" aria-label="Segundo Turno">
      <div class="turn-card-bg" aria-hidden="true"></div>
      <div class="turn-card-content">
        <div class="turn-icon" aria-hidden="true">üïí</div>
        <div class="turn-label">Segundo Turno</div>
        <div class="turn-sub">Marcar asistentes</div>
      </div>
    </button>
  </div>

  <div class="admin-panel admin-only" style="margin-top:18px">
    <h3 style="text-align:center;margin-bottom:10px">Panel de Gesti√≥n</h3>
    <div class="btn-row" role="group" aria-label="gestion-datos">
      <button id="import-csv-btn-initial" class="primary">üì§ Importar Alumnos (CSV)</button>
      <button id="manage-students-btn" class="primary">üë• Gestionar Alumnos</button>
      <button id="wipe-db" class="ghost">üóëÔ∏è Borrar todos los alumnos</button>
      <button id="show-monthly-report-btn" class="primary">üìÖ Informe Mensual</button>
      <button id="show-history-btn" class="primary">üìú Historial</button>
    </div>
    <div style="margin-top:12px;display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap">
      <input id="export-date-input" type="date" style="padding:8px;border-radius:8px;border:1px solid var(--card-border);background:#fff">
      <button id="export-csv-btn" class="primary">üíæ Exportar CSV del D√≠a</button>
    </div>
    <p id="import-status-initial" style="text-align:center;margin-top:10px;min-height:18px;color:#059669"></p>
  </div>
</section>


    <main id="dashboard" class="hidden" style="margin-top:18px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:wrap">
        <button id="back-to-shifts" class="ghost">&larr; Volver a Turnos</button>
        <div>
          <button id="finalize-shift-btn" class="primary">üèÅ Finalizar Turno</button>
        </div>
      </div>

      <section id="summaries" style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px;align-items:center">
        <div class="summary-card"><div class="small-muted">Comensales</div><div id="summary-diners" style="font-size:18px;font-weight:800">0</div></div>
        <div class="summary-card"><div class="small-muted">Ausentes</div><div id="summary-absent" style="font-size:18px;font-weight:800">0</div></div>
        <div class="summary-card"><div class="small-muted">Pendientes</div><div id="summary-pending" style="font-size:18px;font-weight:800">0</div></div>
        <div class="summary-card"><div class="small-muted">Presentes</div><div id="summary-present" style="font-size:18px;font-weight:800">0</div></div>
      </section>

      <section id="student-lists">
        <div id="courses-container"></div>
      </section>
    </main>

  </div>
</div>

<input id="csv-file-input" type="file" accept=".csv" style="display:none">

<div id="manage-students-modal" class="fixed-modal" aria-hidden="true">
  <div class="modal-content">
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h2 style="color:var(--brand)">Gestionar Alumnos</h2>
      <button id="close-manage-modal" class="small">‚úï</button>
    </header>
    <div id="manage-students-content" style="max-height:68vh;overflow:auto"></div>
  </div>
</div>

<div id="sporadic-picker-modal" class="fixed-modal" aria-hidden="true">
  <div class="modal-content">
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 id="sporadic-picker-title">Seleccionar espor√°dicos</h3>
      <button id="close-sporadic-picker" class="small">‚úï</button>
    </header>
    <div id="sporadic-picker-content" style="max-height:62vh;overflow:auto"></div>
    <footer style="margin-top:8px;text-align:right">
      <button id="confirm-sporadic-add" class="primary">A√±adir seleccionados</button>
    </footer>
  </div>
</div>

<div id="monthly-report-modal" class="fixed-modal" aria-hidden="true">
  <div class="modal-content">
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="color:var(--brand)">Informe de Asistencia Mensual</h3>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="report-month-input" type="month" style="padding:8px;border-radius:8px;border:1px solid var(--card-border)">
        <button id="print-report-btn" class="primary">üñ®Ô∏è Imprimir</button>
        <button id="close-report-btn" class="small">‚úï</button>
      </div>
    </header>
    <div id="monthly-report-content" style="max-height:66vh;overflow:auto"></div>
  </div>
</div>

<div id="history-modal" class="fixed-modal" aria-hidden="true">
  <div class="modal-content">
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="color:var(--brand)">Historial de Asistencia</h3>
      <button id="close-history-btn" class="small">‚úï</button>
    </header>
    <div style="display:flex;gap:14px">
      <div style="width:35%">
        <input id="history-search" placeholder="Buscar alumno..." style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--card-border)">
        <div id="history-student-list" style="margin-top:8px;max-height:52vh;overflow:auto"></div>
      </div>
      <div style="flex:1;background:#fff;border-radius:8px;padding:10px">
        <h4 id="history-student-name">Selecciona un alumno</h4>
        <div id="history-dates-list" style="margin-top:8px;max-height:52vh;overflow:auto"></div>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const firebaseConfig = {
    apiKey: "AIzaSyAeI9G1_2-E8Kghc-88bkrXa_VDJXeDyHo",
    authDomain: "comedorvp.firebaseapp.com",
    projectId: "comedorvp",
    storageBucket: "comedorvp.firebasestorage.app",
    messagingSenderId: "821870274048",
    appId: "1:821870274048:web:62b85d28ceace395245ae5"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();
  const googleProvider = new firebase.auth.GoogleAuthProvider();

  const appState = { currentShift: null, students: [], attendance: {}, tempSporadic: { 'Primer Turno (Infantil)': new Set(), 'Segundo Turno (Primaria)': new Set() } };

  const dom = {
    roleDisplay: document.getElementById('role-display'),
    adminLoginView: document.getElementById('admin-login-view'),
    mainContent: document.getElementById('main-content'),
    coursesContainer: document.getElementById('courses-container'),
    importStatusInitial: document.getElementById('import-status-initial'),
    csvFileInput: document.getElementById('csv-file-input'),
    manageStudentsModal: document.getElementById('manage-students-modal'),
    manageStudentsContent: document.getElementById('manage-students-content'),
    closeManageModal: document.getElementById('close-manage-modal'),
    sporadicPickerModal: document.getElementById('sporadic-picker-modal'),
    sporadicPickerContent: document.getElementById('sporadic-picker-content'),
    sporadicPickerTitle: document.getElementById('sporadic-picker-title'),
    closeSporadicPicker: document.getElementById('close-sporadic-picker'),
    confirmSporadicAdd: document.getElementById('confirm-sporadic-add'),
    monthlyReportModal: document.getElementById('monthly-report-modal'),
    monthlyReportContent: document.getElementById('monthly-report-content'),
    reportMonthInput: document.getElementById('report-month-input'),
    printReportBtn: document.getElementById('print-report-btn'),
    closeReportBtn: document.getElementById('close-report-btn'),
    historyModal: document.getElementById('history-modal'),
    historyStudentList: document.getElementById('history-student-list'),
    historyStudentName: document.getElementById('history-student-name'),
    historyDatesList: document.getElementById('history-dates-list'),
    historySearch: document.getElementById('history-search'),
    loginAdminBtn: document.getElementById('login-admin-btn'),
    importCsvBtnInitial: document.getElementById('import-csv-btn-initial'),
    manageStudentsBtn: document.getElementById('manage-students-btn'),
    wipeDbBtn: document.getElementById('wipe-db'),
    exportCsvBtn: document.getElementById('export-csv-btn'),
    exportDateInput: document.getElementById('export-date-input'),
    finalizeShiftBtn: document.getElementById('finalize-shift-btn'),
    backToShiftsBtn: document.getElementById('back-to-shifts'),
    summary: { diners: document.getElementById('summary-diners'), absent: document.getElementById('summary-absent'), pending: document.getElementById('summary-pending'), present: document.getElementById('summary-present') },
    logoutBtn: document.getElementById('logout-btn'),
    showMonthlyBtn: document.getElementById('show-monthly-report-btn'),
    showHistoryBtn: document.getElementById('show-history-btn')
  };

  async function fetchStudents() {
    const snap = await db.collection('students').get();
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  }
  
  async function logAttendance(studentId, dateStr, state, meta = {}) {
    if (!studentId) return;
    const payload = { studentId, date: dateStr, state, ...meta };
    await db.collection('attendance').doc(`${studentId}_${dateStr}`).set(payload, { merge: true });
  }

  async function fetchAttendanceByDate(dateStr) {
    const snap = await db.collection('attendance').where('date','==',dateStr).get();
    const out = {};
    snap.docs.forEach(d => { out[d.data().studentId] = d.data().state; });
    return out;
  }
  
  function updateSummary() {
    const assignedStudents = appState.students.filter(s => 
      s.shift === appState.currentShift || 
      (appState.tempSporadic[appState.currentShift] || new Set()).has(s.id)
    );
    let present = 0, absent = 0, pending = 0;
    assignedStudents.forEach(s => {
      const status = appState.attendance[s.id] || 'pending';
      if (status === 'present') present++;
      else if (status === 'absent') absent++;
      else pending++;
    });
    
    dom.summary.diners.textContent = assignedStudents.length;
    dom.summary.present.textContent = present;
    dom.summary.absent.textContent = absent;
    dom.summary.pending.textContent = pending;
  }

  function createStudentElement(s) {
    const stateClass = appState.attendance[s.id] || 'pending';
    const allergicClass = s.allergic ? 'allergic' : '';
    return `
      <div class="student-item ${stateClass}" data-student-id="${s.id}">
        <span class="name ${allergicClass}">${s.name}</span>
        <div style="display:flex;align-items:center;gap:8px">
          <button class="mark-absent-btn" title="Marcar ausente">&times;</button>
        </div>
      </div>`;
  }

  async function renderCourses(shift) {
    appState.currentShift = shift;
    document.getElementById('shift-selection').style.display = 'none';
    document.getElementById('dashboard').classList.remove('hidden');
    dom.coursesContainer.innerHTML = '<p class="small-muted">Cargando alumnos...</p>';

    appState.students = await fetchStudents();
    const today = new Date().toISOString().slice(0, 10);
    const attendance = await fetchAttendanceByDate(today);
    appState.attendance = {};
    appState.students.forEach(s => { appState.attendance[s.id] = attendance[s.id] || 'pending'; });

    const sporadicSetForShift = appState.tempSporadic[appState.currentShift] || new Set();
    const assigned = appState.students.filter(s => s.shift === appState.currentShift || sporadicSetForShift.has(s.id));
    const esporadicos = appState.students.filter(s => !s.shift || s.shift.trim() === '');
    const courseSet = new Set([...assigned.map(s => s.course), ...esporadicos.map(s => s.course)]);

    const courseOrder = ['3 a√±os', '4 a√±os', '5 a√±os', '1¬∫ EP', '2¬∫ EP', '3¬∫ EP', '4¬∫ EP', '5¬∫ EP', '6¬∫ EP'];
    const courses = [...courseSet].sort((a, b) => {
        const indexA = courseOrder.indexOf(a);
        const indexB = courseOrder.indexOf(b);
        if (indexA === -1 && indexB === -1) return a.localeCompare(b);
        if (indexA === -1) return 1;
        if (indexB === -1) return -1;
        return indexA - indexB;
    });

    if (!courses.length) {
      dom.coursesContainer.innerHTML = '<p class="small-muted">No hay alumnos en este turno.</p>';
    } else {
      dom.coursesContainer.innerHTML = courses.map(course => {
        const studentsInCourse = assigned.filter(s => s.course === course).sort((a,b) => a.name.localeCompare(b.name));
        const sporadicCandidates = esporadicos.filter(s => s.course === course && !sporadicSetForShift.has(s.id));
        const pickerBtn = sporadicCandidates.length > 0 ? 
          `<div style="margin-top:8px"><button class="open-sporadic-picker primary small" data-course="${course}">+ A√±adir espor√°dico</button></div>` : '';
        
        return `
          <div class="course-card">
            <h3>${course}</h3>
            <div style="display:flex;flex-direction:column;gap:8px" data-course-list="${course}">
              ${studentsInCourse.map(createStudentElement).join('')}
            </div>
            ${pickerBtn}
          </div>`;
      }).join('');
    }
    updateSummary();
  }
  
  function openSporadicPickerModal(course) {
    dom.sporadicPickerTitle.textContent = `A√±adir espor√°dicos a ${course}`;
    const sporadicSetForShift = appState.tempSporadic[appState.currentShift] || new Set();
    const candidates = appState.students.filter(s => s.course === course && (!s.shift || s.shift.trim() === '') && !sporadicSetForShift.has(s.id))
      .sort((a,b) => a.name.localeCompare(b.name));

    if(candidates.length === 0) {
        dom.sporadicPickerContent.innerHTML = `<p class="small-muted">No hay m√°s alumnos espor√°dicos en este curso.</p>`;
    } else {
        dom.sporadicPickerContent.innerHTML = candidates.map(s => `
        <label style="display:flex;align-items:center;gap:8px;padding:8px;border:1px solid var(--card-border);border-radius:8px;background:#fff;margin-bottom:6px;">
          <input type="checkbox" class="sporadic-candidate" value="${s.id}">
          <span>${s.name} ${s.allergic ? ' (‚ö†Ô∏è Alergia)' : ''}</span>
        </label>
        `).join('');
    }
    dom.sporadicPickerModal.classList.add('active');
  }

  dom.coursesContainer.addEventListener('click', async (e) => {
    const studentDiv = e.target.closest('.student-item');
    const pickerBtn = e.target.closest('.open-sporadic-picker');

    if(pickerBtn) {
        openSporadicPickerModal(pickerBtn.dataset.course);
        return;
    }

    if (!studentDiv) return;
    
    const studentId = studentDiv.dataset.studentId;
    const isX = e.target.closest('.mark-absent-btn');
    const current = appState.attendance[studentId] || 'pending';
    const newState = isX ? (current === 'absent' ? 'pending' : 'absent') : (current === 'present' ? 'pending' : 'present');
    
    appState.attendance[studentId] = newState;
    studentDiv.classList.remove('pending','present','absent');
    studentDiv.classList.add(newState);
    
    updateSummary();
    await logAttendance(studentId, new Date().toISOString().slice(0,10), newState);
  });
  
  dom.confirmSporadicAdd.addEventListener('click', async () => {
    const checked = [...dom.sporadicPickerContent.querySelectorAll('.sporadic-candidate:checked')].map(cb => cb.value);
    if(checked.length === 0) return;
    
    const today = new Date().toISOString().slice(0,10);
    const shift = appState.currentShift;
    if(!appState.tempSporadic[shift]) appState.tempSporadic[shift] = new Set();

    const promises = checked.map(id => {
        appState.tempSporadic[shift].add(id);
        appState.attendance[id] = 'present';
        return logAttendance(id, today, 'present', { sporadic: true, sporadicShift: shift });
    });
    
    await Promise.all(promises);
    dom.sporadicPickerModal.classList.remove('active');
    await renderCourses(shift);
  });

  dom.closeSporadicPicker.addEventListener('click', () => dom.sporadicPickerModal.classList.remove('active'));
  
  function setUIForRole(isAdmin) {
    dom.roleDisplay.textContent = isAdmin ? 'Admin: ' + (auth.currentUser?.displayName || 'Admin') : 'Modo: Profesor / Cuidador';
    document.querySelectorAll('.admin-only').forEach(el => el.style.display = isAdmin ? 'block' : 'none');
    dom.logoutBtn.style.display = isAdmin ? 'inline-flex' : 'none';
    document.getElementById('dashboard').classList.add('hidden');
    document.getElementById('shift-selection').style.display = 'block';
  }

  auth.onAuthStateChanged(user => setUIForRole(user && !user.isAnonymous));

  document.querySelectorAll('#shift-buttons button').forEach(btn => {
    btn.addEventListener('click', () => renderCourses(btn.dataset.shift));
  });
  dom.backToShiftsBtn.addEventListener('click', () => {
    document.getElementById('shift-selection').style.display='block';
    document.getElementById('dashboard').classList.add('hidden');
  });

  dom.loginAdminBtn.addEventListener('click', () => auth.signInWithPopup(googleProvider).catch(e => console.error(e)));
  dom.logoutBtn.addEventListener('click', () => auth.signOut());

  // --- ADMIN BUTTONS RESTORED ---
  dom.manageStudentsBtn.addEventListener('click', () => alert('Gesti√≥n de alumnos pr√≥ximamente.'));
  dom.importCsvBtnInitial.addEventListener('click', () => dom.csvFileInput.click());
  dom.wipeDbBtn.addEventListener('click', () => alert('Funci√≥n de borrado no implementada en este prototipo.'));
  dom.showMonthlyBtn.addEventListener('click', () => alert('Informe mensual pr√≥ximamente.'));
  dom.showHistoryBtn.addEventListener('click', () => alert('Historial pr√≥ximamente.'));
  dom.exportCsvBtn.addEventListener('click', () => alert('Exportaci√≥n CSV pr√≥ximamente.'));
  dom.finalizeShiftBtn.addEventListener('click', () => alert('Finalizar turno pr√≥ximamente.'));

});
</script>

</body>
</html>
