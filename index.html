<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestor de Comedor Escolar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .admin-only { display: none; }
    .user-only { display: none; }
    .student-item { transition: all 0.2s ease-in-out; }
    .student-item.pending { background-color: #374151; }
    .student-item.present { background-color: #166534; transform: scale(1.02); }
    .student-item.absent { background-color: #991b1b; text-decoration: line-through; opacity: 0.6; }
    #role-selection-screen { backdrop-filter: blur(10px); }
    #history-modal, #generic-modal { transition: opacity 0.3s ease; }
  </style>
</head>
<body class="bg-gray-900 text-white antialiased">

  <!-- Pantalla de selecciÃ³n de rol -->
  <div id="role-selection-screen" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
    <div class="text-center bg-gray-800 p-8 rounded-lg shadow-2xl">
      <h2 class="text-3xl font-bold text-cyan-400 mb-6">Â¿CÃ³mo quieres acceder?</h2>
      <div class="space-y-4">
        <button id="login-admin" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg text-lg">Soy Administrador</button>
        <button id="login-user" class="w-full bg-teal-600 hover:bg-teal-500 text-white font-bold py-3 px-6 rounded-lg text-lg">Soy Profesor / Cuidador</button>
      </div>
    </div>
  </div>

  <!-- AplicaciÃ³n -->
  <div id="app" class="container mx-auto p-4 md:p-8 max-w-7xl opacity-0 transition-opacity duration-500">
    <header class="text-center mb-8">
      <h1 class="text-4xl font-bold text-cyan-400">Gestor de Comedor</h1>
      <p id="role-display" class="text-gray-400 mt-2 font-semibold"></p>
    </header>

    <div id="shift-selection" class="text-center">
      <h2 class="text-2xl font-semibold mb-4">Elige un turno de comedor</h2>
      <div id="shift-buttons" class="flex flex-wrap justify-center gap-4">
        <button class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-6 rounded-lg text-lg" data-shift="Primer Turno (Infantil)">Primer Turno (Infantil)</button>
        <button class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-6 rounded-lg text-lg" data-shift="Segundo Turno (Primaria)">Segundo Turno (Primaria)</button>
      </div>
      <div class="mt-8 admin-only">
        <h3 class="text-xl font-semibold mb-4">GestiÃ³n de Datos</h3>
        <button id="import-csv-btn-initial" class="bg-green-600 hover:bg-green-500 font-bold py-3 px-6 rounded-lg">ðŸ“¤ Importar Alumnos (CSV)</button>
        <p id="import-status-initial" class="text-green-400 mt-2 h-6"></p>
      </div>
    </div>

    <main id="dashboard" class="hidden">
      <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
        <button id="back-to-shifts" class="bg-gray-600 hover:bg-gray-500 font-bold py-2 px-4 rounded-lg">&larr; Cambiar Turno</button>
        <div class="flex flex-wrap gap-4">
          <button id="import-csv-btn-dashboard" class="bg-green-600 hover:bg-green-500 font-bold py-2 px-4 rounded-lg admin-only">ðŸ“¤ Importar Alumnos (CSV)</button>
          <button id="show-history" class="bg-indigo-600 hover:bg-indigo-500 font-bold py-2 px-4 rounded-lg admin-only">ðŸ“œ Ver Historial Completo</button>
          <button id="reset-count" class="bg-amber-600 hover:bg-amber-500 font-bold py-2 px-4 rounded-lg">â†» Reiniciar Estados</button>
        </div>
      </div>
      <p id="import-status-dashboard" class="text-center text-green-400 mb-4 h-6"></p>

      <section id="summary" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-gray-800 p-4 rounded-lg text-center">
          <h3 class="text-lg font-semibold text-gray-400">Comensales del DÃ­a</h3>
          <p id="summary-diners" class="text-3xl font-bold">0</p>
        </div>
        <div class="bg-red-800 bg-opacity-50 p-4 rounded-lg text-center">
          <h3 class="text-lg font-semibold text-red-300">Ausentes</h3>
          <p id="summary-absent" class="text-3xl font-bold">0</p>
        </div>
        <div class="bg-blue-800 bg-opacity-50 p-4 rounded-lg text-center">
          <h3 class="text-lg font-semibold text-blue-300">Pendientes</h3>
          <p id="summary-pending" class="text-3xl font-bold">0</p>
        </div>
        <div class="bg-green-800 bg-opacity-50 p-4 rounded-lg text-center">
          <h3 class="text-lg font-semibold text-green-300">Presentes</h3>
          <p id="summary-present" class="text-3xl font-bold">0</p>
        </div>
      </section>

      <section id="student-lists">
        <div id="courses-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      </section>
    </main>
  </div>

  <!-- Input oculto para CSV -->
  <input type="file" id="csv-file-input" accept=".csv" style="display: none;">

  <!-- MÃ³dulo principal -->
  <script type="module">
    import Papa from 'https://cdn.jsdelivr.net/npm/papaparse@5.4.1/+esm';
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import {
      getFirestore, collection, query, where, getDocs,
      writeBatch, doc, addDoc, setDoc
    } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    // ConfiguraciÃ³n de Firebase (tuya)
    const firebaseConfig = {
      apiKey: "AIzaSyAeI9G1_2-E8Kghc-88bkrXa_VDJXeDyHo",
      authDomain: "comedorvp.firebaseapp.com",
      projectId: "comedorvp",
      storageBucket: "comedorvp.appspot.com",
      messagingSenderId: "821870274048",
      appId: "1:821870274048:web:62b85d28ceace395245ae5"
    };

    // Inicializaciones
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let userRole = null;
    const appState = { currentShift: null, students: [], attendance: {} };
    let modalResolve = null;

    const dom = {
      roleScreen: document.getElementById('role-selection-screen'),
      app: document.getElementById('app'),
      roleDisplay: document.getElementById('role-display'),
      shiftSelection: document.getElementById('shift-selection'),
      dashboard: document.getElementById('dashboard'),
      coursesContainer: document.getElementById('courses-container'),
      csvFileInput: document.getElementById('csv-file-input'),
      importStatusInitial: document.getElementById('import-status-initial'),
      importStatusDashboard: document.getElementById('import-status-dashboard'),
      historyModal: document.getElementById('history-modal'),
      historyStudentList: document.getElementById('history-student-list'),
      historyStudentName: document.getElementById('history-student-name'),
      historyDatesList: document.getElementById('history-dates-list'),
      genericModal: document.getElementById('generic-modal'),
      modal: {
        title: document.getElementById('modal-title'),
        text: document.getElementById('modal-text'),
        input: document.getElementById('modal-input'),
        okBtn: document.getElementById('modal-ok-btn'),
        cancelBtn: document.getElementById('modal-cancel-btn'),
      }
    };

    // Muestra/oculta UI segÃºn rol
    function setUIVisibility() {
      dom.roleScreen.style.display = 'none';
      dom.app.classList.remove('opacity-0');
      document.querySelectorAll('.admin-only')
        .forEach(el => el.style.display = userRole === 'admin' ? 'block' : 'none');
      document.querySelectorAll('.user-only')
        .forEach(el => el.style.display = userRole === 'user' ? 'block' : 'none');
      dom.roleDisplay.textContent = userRole === 'admin'
        ? 'Modo: Administrador'
        : 'Modo: Profesor / Cuidador';
      dom.roleDisplay.className = userRole === 'admin'
        ? 'text-indigo-400 mt-2 font-semibold'
        : 'text-teal-400 mt-2 font-semibold';
    }

    // AutenticaciÃ³n anÃ³nima / custom token
    async function initFirebase() {
      return new Promise(resolve => {
        onAuthStateChanged(auth, async user => {
          if (user) return resolve(user);
          try {
            if (typeof __initial_auth_token !== 'undefined') {
              await signInWithCustomToken(auth, __initial_auth_token);
            } else {
              await signInAnonymously(auth);
            }
          } catch (e) {
            console.error('Auth Error:', e);
          }
        });
      });
    }

    // Modal genÃ©rico
    function showModal({ title, text, showInput = false, placeholder = '', okText = 'Aceptar', cancelText = 'Cancelar' }) {
      return new Promise(resolve => {
        modalResolve = resolve;
        dom.modal.title.textContent = title;
        dom.modal.text.textContent = text;
        dom.modal.input.style.display = showInput ? 'block' : 'none';
        if (showInput) {
          dom.modal.input.value = '';
          dom.modal.input.placeholder = placeholder;
        }
        dom.modal.okBtn.textContent = okText;
        dom.modal.cancelBtn.textContent = cancelText;
        dom.genericModal.classList.remove('hidden');
      });
    }

    // Lectura de alumnos por turno
    async function fetchStudents(shift) {
      const q = query(
        collection(db, "artifacts", firebaseConfig.projectId, "public", "data", "students"),
        where("shift", "==", shift)
      );
      const snap = await getDocs(q);
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    // AÃ±ade un solo alumno (modo admin)
    async function addStudentToDB(name, course, shift) {
      try {
        const ref = await addDoc(
          collection(db, "artifacts", firebaseConfig.projectId, "public", "data", "students"),
          { name, course, shift }
        );
        return { id: ref.id, name, course, shift };
      } catch (e) {
        console.error("Error addStudentToDB:", e);
        return null;
      }
    }

    // Batch para CSV
    async function addStudentBatch(students) {
      if (students.length === 0) return 0;
      const batch = writeBatch(db);
      const coll = collection(db, "artifacts", firebaseConfig.projectId, "public", "data", "students");
      let valid = 0;
      students.forEach(s => {
        if (s.name && s.course && s.shift) {
          const ref = doc(coll);
          batch.set(ref, {
            name: s.name.trim(),
            course: s.course.trim(),
            shift: s.shift.trim()
          });
          valid++;
        }
      });
      try {
        await batch.commit();
        return valid;
      } catch (e) {
        console.error("Error committing batch:", e);
        return null;
      }
    }

    // Registrar asistencia
    async function logAttendance(studentId, studentName, dateString) {
      if (studentId.startsWith('temp_')) return;
      const id = `${studentId}_${dateString}`;
      try {
        await setDoc(
          doc(db, "artifacts", firebaseConfig.projectId, "public", "data", "attendance", id),
          { studentId, studentName, date: dateString }
        );
      } catch (e) {
        console.error("Error logAttendance:", e);
      }
    }

    // UI de resumen
    function updateSummary() {
      const vals = Object.values(appState.attendance);
      document.getElementById('summary-diners').textContent = vals.length;
      document.getElementById('summary-absent').textContent = vals.filter(v => v === 'absent').length;
      document.getElementById('summary-present').textContent = vals.filter(v => v === 'present').length;
      document.getElementById('summary-pending').textContent = vals.filter(v => v === 'pending
