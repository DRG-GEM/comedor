<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestor de Comedor Escolar</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<!-- PWA Meta Tags -->
<meta name="theme-color" content="#0f172a">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Comedor">
<link rel="apple-touch-icon" href="https://placehold.co/192x192/0f172a/FFFFFF?text=GDC">
<link rel="manifest" href="/manifest.json">
<style>
body { font-family: 'Inter', sans-serif; background-color: #0f172a; }
.admin-only { display: none; }
.user-only { display: none; }
.student-item { transition: all 0.2s ease-in-out; border-left-width: 4px; }
.student-item.pending { border-color: #4b5563; }
.student-item.present { border-color: #10B981; background-color: #10B9811A; transform: scale(1.02); }
.student-item.absent { border-color: #F43F5E; background-color: #F43F5E1A; text-decoration: line-through; opacity: 0.7; }
#history-modal, #monthly-report-modal { transition: opacity 0.3s ease; }

@media print {
  body * { visibility: hidden; }
  .printable-area, .printable-area * { visibility: visible; }
  .printable-area { position: absolute; left: 0; top: 0; width: 100%; color: black !important; }
  .no-print, .no-print * { display: none !important; }
  table { width: 100%; border-collapse: collapse; font-size: 9px; }
  th, td { border: 1px solid #ccc; padding: 4px; text-align: center; }
  th:first-child, td:first-child { text-align: left; }
  .attendance-mark { background-color: #10B981 !important; color: #10B981 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; border-radius: 50%; }
  h2, h3 { color: black !important; margin-top: 20px; }
}
</style>
</head>
<body class="bg-slate-900 text-slate-200 antialiased">

<!-- App principal -->
<div id="app" class="container mx-auto p-4 md:p-8 max-w-7xl">
  <header class="text-center mb-10">
    <div class="flex justify-center items-center gap-3 mb-2">
        <svg class="w-10 h-10 text-teal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2z"></path></svg>
        <h1 class="text-4xl font-extrabold text-white">Gestor de Comedor</h1>
    </div>
    <p id="role-display" class="text-slate-400 mt-2 font-semibold">Cargando...</p>
  </header>
  
  <div id="admin-login-view" class="hidden text-center bg-slate-800/50 p-8 rounded-2xl max-w-md mx-auto">
      <h2 class="text-2xl font-bold mb-6 text-white">Acceso de Administrador</h2>
      <button id="login-admin-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg text-lg flex items-center justify-center gap-3 mx-auto shadow-lg hover:shadow-indigo-500/50 transition-shadow">
        <svg class="w-6 h-6" viewBox="0 0 24 24"><path fill="currentColor" d="M21.35,11.1H12.18V13.83H18.69C18.36,17.64 15.19,19.27 12.19,19.27C8.36,19.27 5,16.25 5,12C5,7.9 8.2,4.73 12.19,4.73C14.03,4.73 15.69,5.36 16.95,6.57L19.05,4.54C17.22,2.77 15,2 12.19,2C6.42,2 2.03,6.8 2.03,12C2.03,17.05 6.16,22 12.19,22C17.6,22 21.54,18.22 21.54,12.33C21.54,11.76 21.48,11.43 21.35,11.1V11.1Z"></path></svg>
        <span>Iniciar Sesi√≥n con Google</span>
      </button>
  </div>

  <div id="main-content" class="hidden">
      <!-- Selecci√≥n de turno -->
      <div id="shift-selection" class="text-center">
        <h2 class="text-2xl font-bold mb-6 text-white">Elige un turno de comedor</h2>
        <div id="shift-buttons" class="flex flex-wrap justify-center gap-4">
          <button class="bg-teal-600 hover:bg-teal-500 text-white font-bold py-3 px-8 rounded-lg text-lg transition-transform hover:scale-105" data-shift="Primer Turno (Infantil)">Primer Turno (Infantil)</button>
          <button class="bg-teal-600 hover:bg-teal-500 text-white font-bold py-3 px-8 rounded-lg text-lg transition-transform hover:scale-105" data-shift="Segundo Turno (Primaria)">Segundo Turno (Primaria)</button>
        </div>
        <div class="mt-12 pt-8 border-t border-slate-700/50 admin-only max-w-3xl mx-auto">
          <h3 class="text-xl font-bold mb-6 text-white">Panel de Gesti√≥n</h3>
          <div class="bg-slate-800/50 p-6 rounded-2xl">
              <h4 class="text-lg font-semibold mb-4 text-slate-300">Gesti√≥n de Datos</h4>
              <div class="flex flex-col md:flex-row gap-4 justify-center">
                  <button id="import-csv-btn-initial" class="bg-green-600 hover:bg-green-500 font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2">üì§ <span>Importar Alumnos (CSV)</span></button>
                  <button id="wipe-db" class="bg-red-600 hover:bg-red-500 font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2">üóëÔ∏è <span>Borrar todos los alumnos</span></button>
              </div>
              <p id="import-status-initial" class="text-green-400 mt-4 h-6"></p>
              
              <div class="mt-8 pt-6 border-t border-slate-700">
                  <h4 class="text-lg font-semibold mb-4 text-slate-300">Consultas y Exportaci√≥n</h4>
                  <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                      <button id="show-history-btn" class="bg-purple-600 hover:bg-purple-500 font-bold py-3 px-6 rounded-lg w-full sm:w-auto">üìú Historial por Alumno</button>
                      <button id="show-monthly-report-btn" class="bg-sky-600 hover:bg-sky-500 font-bold py-3 px-6 rounded-lg w-full sm:w-auto">üìÖ Informe Mensual</button>
                  </div>
                   <div class="mt-6 flex flex-col sm:flex-row gap-4 justify-center items-center">
                      <input type="date" id="export-date-input" class="p-3 w-full sm:w-auto rounded-lg bg-slate-700 text-white border border-slate-600 focus:ring-2 focus:ring-cyan-500">
                      <button id="export-csv-btn" class="bg-blue-600 hover:bg-blue-500 font-bold py-3 px-6 rounded-lg w-full sm:w-auto">üíæ Exportar CSV del D√≠a</button>
                   </div>
              </div>
          </div>
        </div>
      </div>

      <!-- Dashboard -->
      <main id="dashboard" class="hidden">
        <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
          <button id="back-to-shifts" class="bg-slate-700 hover:bg-slate-600 font-bold py-2 px-4 rounded-lg">&larr; Volver a Turnos</button>
          <div class="flex flex-wrap gap-4">
            <button id="finalize-shift-btn" class="bg-orange-600 hover:bg-orange-500 font-bold py-2 px-4 rounded-lg">üèÅ Finalizar Turno</button>
          </div>
        </div>
        
        <section id="summary" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
          <div class="bg-slate-800 p-4 rounded-xl text-center"><h3 class="text-lg font-semibold text-slate-400">Comensales</h3><p id="summary-diners" class="text-4xl font-bold text-white">0</p></div>
          <div class="bg-slate-800 p-4 rounded-xl text-center"><h3 class="text-lg font-semibold text-rose-400">Ausentes</h3><p id="summary-absent" class="text-4xl font-bold text-white">0</p></div>
          <div class="bg-slate-800 p-4 rounded-xl text-center"><h3 class="text-lg font-semibold text-amber-400">Pendientes</h3><p id="summary-pending" class="text-4xl font-bold text-white">0</p></div>
          <div class="bg-slate-800 p-4 rounded-xl text-center"><h3 class="text-lg font-semibold text-emerald-400">Presentes</h3><p id="summary-present" class="text-4xl font-bold text-white">0</p></div>
        </section>

        <section id="student-lists">
          <div id="courses-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>
      </main>
  </div>
</div>

<input type="file" id="csv-file-input" class="hidden" accept=".csv">

<!-- History Modal -->
<div id="history-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 hidden opacity-0 z-40">
    <div class="bg-slate-800 rounded-lg shadow-xl w-full max-w-4xl h-full max-h-[90vh] flex flex-col border border-slate-700">
        <header class="p-4 border-b border-slate-700 flex justify-between items-center">
            <h2 class="text-2xl font-bold text-teal-300">Historial de Asistencia</h2>
            <button id="close-history-btn" class="text-3xl font-bold hover:text-red-500">&times;</button>
        </header>
        <div class="p-4 flex-grow flex flex-col md:flex-row gap-4 overflow-hidden">
            <div class="w-full md:w-1/3 flex flex-col">
                <input type="text" id="history-search" placeholder="Buscar alumno..." class="w-full p-2 rounded-md bg-slate-900 border border-slate-700 mb-4">
                <div id="history-student-list" class="flex-grow overflow-y-auto pr-2"></div>
            </div>
            <div id="history-details-container" class="w-full md:w-2/3 bg-slate-900 rounded-lg p-4 flex-grow flex flex-col">
                <h3 id="history-student-name" class="text-xl font-semibold mb-4 text-center">Selecciona un alumno</h3>
                <div id="history-dates-list" class="flex-grow overflow-y-auto text-center"></div>
            </div>
        </div>
    </div>
</div>

<!-- Monthly Report Modal -->
<div id="monthly-report-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 hidden opacity-0 z-40">
    <div class="bg-slate-800 rounded-lg shadow-xl w-full max-w-7xl h-full max-h-[95vh] flex flex-col border border-slate-700">
        <header class="p-4 border-b border-slate-700 flex justify-between items-center no-print">
            <h2 class="text-2xl font-bold text-teal-300">Informe de Asistencia Mensual</h2>
            <div class="flex items-center gap-4">
                <input type="month" id="report-month-input" class="p-2 rounded-lg bg-slate-700 text-white border border-slate-600">
                <button id="print-report-btn" class="bg-blue-600 hover:bg-blue-500 font-bold py-2 px-4 rounded-lg flex items-center gap-2">üñ®Ô∏è <span>Imprimir</span></button>
                <button id="close-report-btn" class="text-3xl font-bold hover:text-red-500">&times;</button>
            </div>
        </header>
        <div id="monthly-report-content" class="p-6 flex-grow overflow-y-auto printable-area">
            <p class="text-center text-slate-400">Selecciona un mes para generar el informe.</p>
        </div>
    </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<!-- PapaParse -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const firebaseConfig = {
      apiKey: "AIzaSyAeI9G1_2-E8Kghc-88bkrXa_VDJXeDyHo",
      authDomain: "comedorvp.firebaseapp.com",
      projectId: "comedorvp",
      storageBucket: "comedorvp.firebasestorage.app",
      messagingSenderId: "821870274048",
      appId: "1:821870274048:web:62b85d28ceace395245ae5"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();
  const googleProvider = new firebase.auth.GoogleAuthProvider();
  let userRole = null;
  const appState = { currentShift: null, students: [], attendance: {} };

  const dom = {
    app: document.getElementById('app'),
    roleDisplay: document.getElementById('role-display'),
    shiftSelection: document.getElementById('shift-selection'),
    dashboard: document.getElementById('dashboard'),
    coursesContainer: document.getElementById('courses-container'),
    csvFileInput: document.getElementById('csv-file-input'),
    importStatusInitial: document.getElementById('import-status-initial'),
    wipeDbBtn: document.getElementById('wipe-db'),
    finalizeShiftBtn: document.getElementById('finalize-shift-btn'),
    adminLoginView: document.getElementById('admin-login-view'),
    mainContent: document.getElementById('main-content'),
    historyModal: document.getElementById('history-modal'),
    closeHistoryBtn: document.getElementById('close-history-btn'),
    historyStudentList: document.getElementById('history-student-list'),
    historyStudentName: document.getElementById('history-student-name'),
    historyDatesList: document.getElementById('history-dates-list'),
    historySearch: document.getElementById('history-search'),
    monthlyReportModal: document.getElementById('monthly-report-modal'),
    monthlyReportContent: document.getElementById('monthly-report-content'),
    reportMonthInput: document.getElementById('report-month-input')
  };

  function setUIVisibility(role) {
    userRole = role;
    dom.app.classList.remove('opacity-0');
    dom.adminLoginView.classList.add('hidden');
    dom.mainContent.classList.add('hidden');
    if (userRole === 'admin') {
        dom.mainContent.classList.remove('hidden');
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
        document.querySelectorAll('.user-only').forEach(el => el.style.display = 'none');
        const user = auth.currentUser;
        dom.roleDisplay.textContent = user ? `Admin: ${user.displayName || 'Usuario'}` : 'Admin';
    } else if (userRole === 'user') {
        dom.mainContent.classList.remove('hidden');
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.user-only').forEach(el => el.style.display = 'block');
        dom.roleDisplay.textContent = 'Modo: Profesor / Cuidador';
    } else if (userRole === 'login') {
        dom.adminLoginView.classList.remove('hidden');
        dom.roleDisplay.textContent = 'Acceso de Administrador';
    }
  }

  async function fetchStudents(shift) { let query = db.collection("students"); if (shift) { query = query.where("shift", "==", shift); } const snapshot = await query.get(); return snapshot.docs.map(doc => ({id:doc.id, ...doc.data()})); }
  async function addStudentBatch(students) { const batch = db.batch(); const collection = db.collection("students"); students.forEach(s => { if(s.name && s.course && s.shift){ batch.set(collection.doc(), {name:s.name.trim(), course:s.course.trim(), shift:s.shift.trim()}); } }); await batch.commit(); }
  async function deleteAllStudents() { const snapshot = await db.collection("students").get(); const batch = db.batch(); snapshot.docs.forEach(doc => batch.delete(doc.ref)); await batch.commit(); }
  async function logAttendance(studentId, dateStr, state) { if (studentId.startsWith('sporadic_')) return; const docRef = db.collection("attendance").doc(`${studentId}_${dateStr}`); await docRef.set({studentId, date: dateStr, state}); }
  async function logBatchAttendance(studentsToUpdate, dateStr, state) { const validStudents = studentsToUpdate.filter(id => !id.startsWith('sporadic_')); if (validStudents.length === 0) return; const batch = db.batch(); const collection = db.collection("attendance"); validStudents.forEach(studentId => { const docRef = collection.doc(`${studentId}_${dateStr}`); batch.set(docRef, { studentId, date: dateStr, state }); }); await batch.commit(); }
  async function fetchAttendanceByDate(dateStr) { const snapshot = await db.collection("attendance").where("date","==",dateStr).get(); const data = {}; snapshot.docs.forEach(doc=>data[doc.data().studentId]=doc.data().state); return data; }
  async function fetchAttendanceByMonth(yearMonth) {
    const startDate = `${yearMonth}-01`;
    const endDate = `${yearMonth}-31`;
    const snapshot = await db.collection("attendance").where('date', '>=', startDate).where('date', '<=', endDate).get();
    const data = new Map();
    snapshot.docs.forEach(doc => {
        const record = doc.data();
        if (!data.has(record.studentId)) { data.set(record.studentId, new Set()); }
        data.get(record.studentId).add(parseInt(record.date.slice(-2)));
    });
    return data;
  }

  function updateSummary() { const vals = Object.values(appState.attendance); const summary = { diners: document.getElementById('summary-diners'), absent: document.getElementById('summary-absent'), pending: document.getElementById('summary-pending'), present: document.getElementById('summary-present') }; summary.diners.textContent = vals.length; summary.absent.textContent = vals.filter(s=>'absent'===s).length; summary.present.textContent = vals.filter(s=>'present'===s).length; summary.pending.textContent = vals.filter(s=>'pending'===s).length; }
  function createStudentElement(s){ return `<div id="${s.id}" class="student-item bg-slate-800 p-3 rounded-lg flex justify-between items-center" data-student-id="${s.id}" data-student-name="${s.name}"><span class="font-medium">${s.name}</span><button class="mark-absent-btn bg-rose-500/50 hover:bg-rose-500 text-white font-bold w-7 h-7 rounded-full flex items-center justify-center transition-colors">&times;</button></div>`; }
  async function renderCourses(shift) { appState.currentShift = shift; dom.shiftSelection.classList.add('hidden'); dom.dashboard.classList.remove('hidden'); dom.coursesContainer.innerHTML = '<p class="text-center text-lg">Cargando alumnos...</p>'; appState.students = await fetchStudents(shift); const today = new Date().toISOString().slice(0,10); const attendance = await fetchAttendanceByDate(today); appState.attendance = {}; appState.students.forEach(s=>appState.attendance[s.id]=attendance[s.id]||'pending'); dom.coursesContainer.innerHTML = ''; const courses = [...new Set(appState.students.map(s=>s.course))].sort(); if(courses.length===0){ dom.coursesContainer.innerHTML='<p class="text-center text-lg text-slate-400">No hay alumnos en este turno.</p>'; }else{ courses.forEach(course=>{ const card = document.createElement('div'); card.className='bg-slate-800/50 rounded-xl p-4 shadow-lg flex flex-col'; const list = appState.students.filter(s=>s.course===course).map(createStudentElement).join(''); const sporadicBtn = userRole === 'user' ? `<button class="add-sporadic-btn mt-4 bg-purple-600 hover:bg-purple-500 font-semibold py-2 px-4 rounded-lg w-full" data-course="${course}">+ A√±adir Espor√°dico</button>` : ''; card.innerHTML=`<div class="flex-grow"><h3 class="text-xl font-bold text-teal-300 mb-4">${course}</h3><div class="space-y-2">${list}</div></div>${sporadicBtn}`; dom.coursesContainer.appendChild(card); }); } updateSummary(); }

  function handleCsvImport(file){ if(!file) return; [dom.importStatusInitial].forEach(el=>el.textContent='Procesando archivo...'); Papa.parse(file,{header:true,skipEmptyLines:true,complete: async (results)=>{ const headers = results.meta.fields.map(h => h.toLowerCase().trim()); if(!headers.includes('nombre') || !headers.includes('curso') || !headers.includes('turno')){ [dom.importStatusInitial].forEach(el=>el.textContent='Error: CSV debe tener columnas "nombre", "curso", y "turno"'); return; } await deleteAllStudents(); const studentsToImport = results.data.map(r => ({ name: r.nombre ? r.nombre.trim() : '', course: r.curso ? r.curso.trim() : '', shift: r.turno ? r.turno.trim() : '' })); await addStudentBatch(studentsToImport); [dom.importStatusInitial].forEach(el=>el.textContent='Importaci√≥n completa ‚úÖ'); if (appState.currentShift) { renderCourses(appState.currentShift); } },error: err=>{[dom.importStatusInitial].forEach(el=>el.textContent='Error: '+err.message);}}); }
  async function exportFullDayCsv(dateStr){ const allStudents = await fetchStudents(null); const attendance = await fetchAttendanceByDate(dateStr); const rows = allStudents.map(s=>{ const state = attendance[s.id]||'pending'; return {Fecha:dateStr, Turno:s.shift, Nombre:s.name, Curso:s.course, Estado:state}; }); rows.sort((a,b) => a.Turno.localeCompare(b.Turno) || a.Curso.localeCompare(b.Curso) || a.Nombre.localeCompare(b.Nombre)); const csv = Papa.unparse(rows); const blob = new Blob([`\uFEFF${csv}`],{type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download=`asistencia_completa_${dateStr}.csv`; a.click(); URL.revokeObjectURL(url); }
  function addSporadicStudent(course) { const name = prompt(`Nombre del alumno espor√°dico para ${course}:`); if (name && name.trim()) { const student = { id: `sporadic_${Date.now()}`, name: `${name.trim()} (Espor√°dico)`, course: course }; appState.students.push(student); appState.attendance[student.id] = 'pending'; const listContainer = document.querySelector(`[data-course-list="${course}"]`); if (listContainer) { listContainer.insertAdjacentHTML('beforeend', createStudentElement(student)); } updateSummary(); } }
  async function finalizeShift() { if (!confirm("¬øSeguro que quieres finalizar el turno? Todos los alumnos pendientes pasar√°n a estar ausentes.")) { return; } const today = new Date().toISOString().slice(0, 10); const studentsToMarkAbsent = []; for (const studentId in appState.attendance) { if (appState.attendance[studentId] === 'pending') { studentsToMarkAbsent.push(studentId); appState.attendance[studentId] = 'absent'; const studentDiv = document.getElementById(studentId); if (studentDiv) { studentDiv.classList.remove('pending'); studentDiv.classList.add('absent'); } } } await logBatchAttendance(studentsToMarkAbsent, today, 'absent'); updateSummary(); }

  async function showHistoryModal() { dom.historyModal.classList.remove('hidden'); setTimeout(() => dom.historyModal.classList.remove('opacity-0'), 10); dom.historyStudentList.innerHTML = '<p>Cargando alumnos...</p>'; try { const allStudents = await fetchStudents(null); allStudents.sort((a, b) => a.name.localeCompare(b.name)); if (allStudents.length > 0) { dom.historyStudentList.innerHTML = allStudents.map(s => `<div class="p-2 hover:bg-slate-700 cursor-pointer rounded-md history-student" data-student-id="${s.id}" data-student-name="${s.name}"><p class="font-semibold">${s.name}</p><p class="text-sm text-slate-400">${s.shift} - ${s.course}</p></div>`).join(''); } else { dom.historyStudentList.innerHTML = '<p>No hay alumnos registrados.</p>'; } } catch(e) { console.error("Error fetching students for history", e); dom.historyStudentList.innerHTML = '<p class="text-red-400">Error al cargar alumnos.</p>'; } dom.historyStudentName.textContent = 'Selecciona un alumno'; dom.historyDatesList.innerHTML = ''; }
  async function showStudentHistory(studentId, studentName) { dom.historyStudentName.textContent = `Historial de: ${studentName}`; dom.historyDatesList.innerHTML = '<p>Buscando fechas...</p>'; try { const snapshot = await db.collection("attendance").where("studentId", "==", studentId).get(); const dates = snapshot.docs.map(doc => doc.data().date).sort().reverse(); if (dates.length > 0) { dom.historyDatesList.innerHTML = `<ul class="space-y-1 text-left">${dates.map(d => `<li class="bg-slate-700 p-2 rounded">${new Date(d + 'T00:00:00').toLocaleDateString('es-ES', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</li>`).join('')}</ul>`; } else { dom.historyDatesList.innerHTML = '<p>Este alumno no tiene registros de asistencia.</p>'; } } catch(e) { console.error("Error fetching student history", e); dom.historyDatesList.innerHTML = '<p class="text-red-400">Error al buscar las fechas.</p>'; } }
  
  async function generateMonthlyReport(yearMonth) {
    dom.monthlyReportContent.innerHTML = '<div class="text-center text-slate-400">Generando informe, por favor espera...</div>';
    if (!yearMonth) { dom.monthlyReportContent.innerHTML = '<div class="text-center text-amber-400">Por favor, selecciona un mes.</div>'; return; }
    const [year, month] = yearMonth.split('-').map(Number);
    const date = new Date(year, month - 1, 1);
    const monthName = date.toLocaleString('es-ES', { month: 'long' });
    const allStudents = await fetchStudents(null);
    const attendanceData = await fetchAttendanceByMonth(yearMonth);
    const daysInMonth = new Date(year, month, 0).getDate();
    const headers = Array.from({length: daysInMonth}, (_, i) => `<th class="p-2 font-semibold">${i + 1}</th>`).join('');
    const studentsByCourse = allStudents.reduce((acc, student) => { (acc[student.course] = acc[student.course] || []).push(student); return acc; }, {});
    let reportHTML = `<h2 class="text-3xl font-bold text-center mb-6 text-white">${monthName.charAt(0).toUpperCase() + monthName.slice(1)} ${year}</h2>`;
    for (const course of Object.keys(studentsByCourse).sort()) {
        reportHTML += `<div class="mb-8"><h3 class="text-2xl font-bold mb-4 text-teal-300">${course}</h3><div class="overflow-x-auto"><table class="w-full text-slate-300"><thead><tr class="bg-slate-700/50"><th class="p-2 text-left font-semibold">Alumno</th>${headers}<th class="p-2 font-semibold">Total</th></tr></thead><tbody>`;
        studentsByCourse[course].sort((a,b) => a.name.localeCompare(b.name)).forEach((student, index) => {
            const attendedDays = attendanceData.get(student.id) || new Set();
            const rowClass = index % 2 === 0 ? 'bg-slate-800/50' : 'bg-slate-800/20';
            let rowHTML = `<tr class="${rowClass}"><td class="p-2 font-medium text-white">${student.name}</td>`;
            for (let day = 1; day <= daysInMonth; day++) {
                rowHTML += attendedDays.has(day) ? '<td class="attendance-mark text-center text-emerald-400">‚úì</td>' : '<td></td>';
            }
            rowHTML += `<td class="font-bold text-center text-white">${attendedDays.size}</td></tr>`;
            reportHTML += rowHTML;
        });
        reportHTML += `</tbody></table></div></div>`;
    }
    dom.monthlyReportContent.innerHTML = reportHTML;
  }
  
  function handleRouting() { const hash = window.location.hash; const user = auth.currentUser; const isRealUser = user && !user.isAnonymous; if (hash === '#admin') { if (isRealUser) { setUIVisibility('admin'); } else { setUIVisibility('login'); } } else { setUIVisibility('user'); } }

  auth.onAuthStateChanged(user => { handleRouting(); });
  window.addEventListener('hashchange', handleRouting);
  handleRouting();

  document.getElementById('login-admin-btn').addEventListener('click', () => { auth.signInWithPopup(googleProvider).catch(error => { console.error("Google Sign-In Error:", error); alert("No se pudo iniciar sesi√≥n con Google."); }); });
  document.querySelectorAll('#shift-buttons button').forEach(btn=>{ btn.addEventListener('click', ()=>renderCourses(btn.dataset.shift)); });
  dom.csvFileInput.addEventListener('change', e=>handleCsvImport(e.target.files[0]));
  document.getElementById('import-csv-btn-initial').addEventListener('click', ()=>dom.csvFileInput.click());
  dom.wipeDbBtn.addEventListener('click', async ()=>{if(confirm('¬øSeguro que quieres borrar todos los alumnos?')){await deleteAllStudents(); if(appState.currentShift){renderCourses(appState.currentShift);}}});
  
  document.getElementById('export-csv-btn').addEventListener('click', () => { const dateInput = document.getElementById('export-date-input'); const dateStr = dateInput.value; if (dateStr) { exportFullDayCsv(dateStr); } else { alert('Por favor, selecciona una fecha para exportar.'); } });
  document.getElementById('export-date-input').value = new Date().toISOString().slice(0,10);

  document.getElementById('show-history-btn').addEventListener('click', showHistoryModal);
  document.getElementById('show-monthly-report-btn').addEventListener('click', () => { const now = new Date(); const year = now.getFullYear(); const month = (now.getMonth() + 1).toString().padStart(2, '0'); dom.reportMonthInput.value = `${year}-${month}`; dom.monthlyReportModal.classList.remove('hidden'); setTimeout(() => dom.monthlyReportModal.classList.remove('opacity-0'), 10); generateMonthlyReport(`${year}-${month}`); });
  dom.reportMonthInput.addEventListener('change', (e) => generateMonthlyReport(e.target.value));
  document.getElementById('print-report-btn').addEventListener('click', () => window.print());
  document.getElementById('close-report-btn').addEventListener('click', () => { dom.monthlyReportModal.classList.add('opacity-0'); setTimeout(() => dom.monthlyReportModal.classList.add('hidden'), 300); });
  
  dom.closeHistoryBtn.addEventListener('click', () => { dom.historyModal.classList.add('opacity-0'); setTimeout(() => dom.historyModal.classList.add('hidden'), 300); });
  dom.historyStudentList.addEventListener('click', e => { const studentEl = e.target.closest('.history-student'); if (studentEl) { showStudentHistory(studentEl.dataset.studentId, studentEl.dataset.studentName); } });
  dom.historySearch.addEventListener('input', e => { const searchTerm = e.target.value.toLowerCase(); document.querySelectorAll('#history-student-list .history-student').forEach(el => { el.style.display = el.dataset.studentName.toLowerCase().includes(searchTerm) ? '' : 'none'; }); });

  dom.finalizeShiftBtn.addEventListener('click', finalizeShift);
  document.getElementById('back-to-shifts').addEventListener('click', ()=>{dom.dashboard.classList.add('hidden'); dom.shiftSelection.classList.remove('hidden');});

  dom.coursesContainer.addEventListener('click', async e=>{ const studentDiv = e.target.closest('.student-item'); const sporadicBtn = e.target.closest('.add-sporadic-btn'); if (sporadicBtn) { addSporadicStudent(sporadicBtn.dataset.course); return; } if(!studentDiv) return; const studentId = studentDiv.dataset.studentId; let newState; if(e.target.classList.contains('mark-absent-btn')){ newState = appState.attendance[studentId] === 'absent' ? 'pending' : 'absent'; } else { newState = appState.attendance[studentId] === 'present' ? 'pending' : 'present'; } appState.attendance[studentId] = newState; studentDiv.classList.remove('pending','present','absent'); studentDiv.classList.add(newState); updateSummary(); await logAttendance(studentId, new Date().toISOString().slice(0,10), newState); });

});
</script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js').then(registration => {
        console.log('ServiceWorker registration successful');
      }, err => {
        console.log('ServiceWorker registration failed: ', err);
      });
    });
  }
</script>
</body>
</html>

