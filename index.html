<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestor de Comedor Escolar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f6f7f9;
      margin: 0;
    }
    .fixed-modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background-color: white;
      border-radius: 12px;
      padding: 20px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    .student-list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #eee;
      gap: 1rem;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .tabs {
      display: flex;
      border-bottom: 1px solid #ccc;
      margin-bottom: 15px;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
    }
    .tab.active {
      border-bottom-color: #8b0630;
      color: #8b0630;
      font-weight: bold;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="p-6 text-center">
    <h1 class="text-3xl font-bold mb-4">Gestor de Comedor Escolar</h1>
    <button id="manage-students-btn" class="bg-rose-600 text-white px-4 py-2 rounded-lg">👥 Gestionar Alumnos</button>
  </div>
  <div id="dashboard" class="p-6">
  <h2 class="text-2xl font-bold mb-6 text-center">Control de Comensales</h2>
  <div id="courses-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
</div>
  <div id="manage-students-modal" class="fixed-modal hidden opacity-0">
    <div class="modal-content">
      <h2 class="text-2xl font-bold mb-4 text-center" style="color:#8b0630">Gestión de Alumnos</h2>

      <div class="tabs">
        <div class="tab active" data-tab="fixed">Alumnos Fijos</div>
        <div class="tab" data-tab="sporadic">Esporádicos</div>
        <div class="tab" data-tab="all">Todos</div>
      </div>

      <div class="tab-content active" id="fixed-tab">
        <div class="student-list" id="fixed-students-list"></div>
      </div>

      <div class="tab-content" id="sporadic-tab">
        <div class="student-list" id="sporadic-students-list"></div>
      </div>

      <div class="tab-content" id="all-tab">
        <div class="student-list" id="all-students-list"></div>
      </div>

      <div class="flex justify-end gap-4 mt-6">
        <button id="close-manage-modal" class="bg-gray-200 px-4 py-2 rounded">Cancelar</button>
      </div>
    </div>
  </div>
<!-- Modal de Gestión de Alumnos -->
<div id="manage-students-modal" class="fixed-modal hidden opacity-0">
  <div class="modal-content">
    <h2 class="text-2xl font-bold mb-4 text-center" style="color:#8b0630">Gestión de Alumnos</h2>

    <!-- Pestañas -->
    <div class="tabs">
      <div class="tab active" data-tab="fixed">Alumnos Fijos</div>
      <div class="tab" data-tab="sporadic">Esporádicos</div>
      <div class="tab" data-tab="all">Todos</div>
    </div>

    <!-- Contenido de pestañas -->
    <div class="tab-content active" id="fixed-tab">
      <div class="student-list" id="fixed-students-list">
        <!-- Aquí se renderizan los alumnos con turno asignado -->
      </div>
    </div>

    <div class="tab-content" id="sporadic-tab">
      <div class="student-list" id="sporadic-students-list">
        <!-- Aquí se renderizan los alumnos sin turno -->
      </div>
    </div>

    <div class="tab-content" id="all-tab">
      <div class="student-list" id="all-students-list">
        <!-- Aquí se renderizan todos los alumnos -->
      </div>
    </div>

    <!-- Botón de cierre -->
    <div class="flex justify-end gap-4 mt-6">
      <button id="close-manage-modal" class="bg-gray-200 px-4 py-2 rounded">Cancelar</button>
    </div>
  </div>
</div>
<script>
  // 🔧 Configura tu Firebase
  const firebaseConfig = {
    apiKey: "TU_API_KEY",
    authDomain: "TU_DOMINIO.firebaseapp.com",
    projectId: "TU_ID_PROYECTO"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // 🔧 Referencias DOM
  const dom = {
    manageStudentsBtn: document.getElementById('manage-students-btn'),
    manageStudentsModal: document.getElementById('manage-students-modal'),
    closeManageModal: document.getElementById('close-manage-modal'),
    fixedStudentsList: document.getElementById('fixed-students-list'),
    sporadicStudentsList: document.getElementById('sporadic-students-list'),
    allStudentsList: document.getElementById('all-students-list')
  };

  // 🧠 Abrir modal
  dom.manageStudentsBtn.addEventListener('click', async () => {
    await renderStudentLists();
    dom.manageStudentsModal.classList.remove('hidden');
    setTimeout(() => dom.manageStudentsModal.classList.remove('opacity-0'), 10);
  });

  // 🧠 Cerrar modal
  dom.closeManageModal.addEventListener('click', () => {
    dom.manageStudentsModal.classList.add('opacity-0');
    setTimeout(() => dom.manageStudentsModal.classList.add('hidden'), 300);
  });

  // 🧠 Tabs
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
    });
  });
// Añadir referencias DOM
dom.manageStudentsBtn = document.createElement('button');
dom.manageStudentsBtn.id = 'manage-students-btn';
dom.manageStudentsBtn.className = 'primary';
dom.manageStudentsBtn.textContent = '👥 Gestionar Alumnos';
document.querySelector('[aria-label="gestion-datos"]').appendChild(dom.manageStudentsBtn);

dom.manageStudentsModal = document.getElementById('manage-students-modal');
dom.closeManageModal = document.getElementById('close-manage-modal');
dom.fixedStudentsList = document.getElementById('fixed-students-list');
dom.sporadicStudentsList = document.getElementById('sporadic-students-list');
dom.allStudentsList = document.getElementById('all-students-list');

// Abrir modal
dom.manageStudentsBtn.addEventListener('click', async () => {
  await renderStudentLists();
  dom.manageStudentsModal.classList.remove('hidden');
  setTimeout(() => dom.manageStudentsModal.classList.remove('opacity-0'), 10);
});

// Cerrar modal
dom.closeManageModal.addEventListener('click', () => {
  dom.manageStudentsModal.classList.add('opacity-0');
  setTimeout(() => dom.manageStudentsModal.classList.add('hidden'), 300);
});

// Tabs
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
  });
});

// Renderizar alumnos en el modal
async function renderStudentLists() {
  const allStudents = await fetchStudents(null);
  const fixed = allStudents.filter(s => s.shift);
  const sporadic = allStudents.filter(s => !s.shift);

  const renderItem = (s) => `
    <div class="student-list-item" data-id="${s.id}">
      <span class="font-semibold">${s.name}</span>
      <label class="checkbox-label">
        <input type="checkbox" class="alergic-toggle" data-id="${s.id}" ${s.alergic ? 'checked' : ''}>
        <span>Alérgico</span>
      </label>
      <select class="shift-selector" data-id="${s.id}">
        <option value="" ${!s.shift ? 'selected' : ''}>Sin turno</option>
        <option value="Primer Turno (Infantil)" ${s.shift === 'Primer Turno (Infantil)' ? 'selected' : ''}>Primer Turno</option>
        <option value="Segundo Turno (Primaria)" ${s.shift === 'Segundo Turno (Primaria)' ? 'selected' : ''}>Segundo Turno</option>
      </select>
    </div>
  `;

  dom.fixedStudentsList.innerHTML = fixed.map(renderItem).join('');
  dom.sporadicStudentsList.innerHTML = sporadic.map(renderItem).join('');
  dom.allStudentsList.innerHTML = allStudents.map(renderItem).join('');

  activateStudentControls();
}

// Guardar cambios
function activateStudentControls() {
  document.querySelectorAll('.alergic-toggle').forEach(input => {
    input.addEventListener('change', async () => {
      const studentId = input.dataset.id;
      const isAlergic = input.checked;
      await db.collection("students").doc(studentId).update({ alergic: isAlergic });
    });
  });

  document.querySelectorAll('.shift-selector').forEach(select => {
    select.addEventListener('change', async () => {
      const studentId = select.dataset.id;
      const newShift = select.value || null;
      await db.collection("students").doc(studentId).update({ shift: newShift });
      if (appState.currentShift) renderCourses(appState.currentShift);
    });
  });
}

  // 🔄 Obtener alumnos
  async function fetchStudents() {
    const snapshot = await db.collection("students").get();
    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  }

  // 🧠 Renderizar listas
  async function renderStudentLists() {
    const students = await fetchStudents();
    const fixed = students.filter(s => s.shift);
    const sporadic = students.filter(s => !s.shift);

    const renderItem = (s) => `
      <div class="student-list-item" data-id="${s.id}">
        <span class="font-semibold">${s.name}</span>
        <label class="checkbox-label">
          <input type="checkbox" class="alergic-toggle" data-id="${s.id}" ${s.alergic ? 'checked' : ''}>
          <span>Alérgico</span>
        </label>
        <select class="shift-selector" data-id="${s.id}">
          <option value="" ${!s.shift ? 'selected' : ''}>Sin turno</option>
          <option value="Primer Turno (Infantil)" ${s.shift === 'Primer Turno (Infantil)' ? 'selected' : ''}>Primer Turno</option>
          <option value="Segundo Turno (Primaria)" ${s.shift === 'Segundo Turno (Primaria)' ? 'selected' : ''}>Segundo Turno</option>
        </select>
      </div>
    `;

    dom.fixedStudentsList.innerHTML = fixed.map(renderItem).join('');
    dom.sporadicStudentsList.innerHTML = sporadic.map(renderItem).join('');
    dom.allStudentsList.innerHTML = students.map(renderItem).join('');

    activateStudentControls();
  }
const appState = {
  students: [],
  attendance: {},
  currentShift: null
};

async function renderCourses() {
  const students = await fetchStudents();
  appState.students = students.filter(s => s.shift); // solo alumnos con turno
  const courses = [...new Set(appState.students.map(s => s.course))].sort();

  const container = document.getElementById('courses-container');
  container.innerHTML = '';

  courses.forEach(course => {
    const studentsInCourse = appState.students.filter(s => s.course === course);
    const listHtml = studentsInCourse.map(s => {
      const alergicClass = s.alergic ? 'border-red-500 border-l-4' : '';
      return `
        <div class="bg-white p-4 rounded shadow ${alergicClass}">
          <p class="font-semibold">${s.name}</p>
          <p class="text-sm text-gray-500">${s.shift}</p>
        </div>
      `;
    }).join('');

    const card = document.createElement('div');
    card.className = 'bg-gray-50 p-4 rounded-lg shadow';
    card.innerHTML = `
      <h3 class="text-lg font-bold mb-2">${course}</h3>
      <div class="space-y-2">${listHtml}</div>
      <button class="add-sporadic-btn mt-4 bg-blue-600 text-white px-3 py-1 rounded" data-course="${course}">+ Añadir Esporádico</button>
    `;
    container.appendChild(card);
  });
}
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('.add-sporadic-btn');
  if (!btn) return;

  const course = btn.dataset.course;
  const eligible = appState.students.filter(s => !s.shift && s.course === course);

  if (eligible.length === 0) {
    alert("No hay alumnos esporádicos disponibles para este curso.");
    return;
  }

  const names = eligible.map(s => s.name).join('\n');
  const selectedName = prompt(`Selecciona un alumno esporádico:\n${names}`);
  const selected = eligible.find(s => s.name === selectedName);

  if (selected) {
    const listContainer = btn.previousElementSibling;
    const alergicClass = selected.alergic ? 'border-red-500 border-l-4' : '';
    listContainer.insertAdjacentHTML('beforeend', `
      <div class="bg-white p-4 rounded shadow ${alergicClass}">
        <p class="font-semibold">${selected.name}</p>
        <p class="text-sm text-gray-500">Esporádico</p>
      </div>
    `);
  }
});

  // 🧠 Guardar cambios
  function activateStudentControls() {
    document.querySelectorAll('.alergic-toggle').forEach(input => {
      input.addEventListener('change', async () => {
        const studentId = input.dataset.id;
        const isAlergic = input.checked;
        await db.collection("students").doc(studentId).update({ alergic: isAlergic });
      });
    });

    document.querySelectorAll('.shift-selector').forEach(select => {
      select.addEventListener('change', async () => {
        const studentId = select.dataset.id;
        const newShift = select.value || null;
        await db.collection("students").doc(studentId).update({ shift: newShift });
      });
    });
  }
</script>
  <!-- Modal de Gestión de Alumnos -->
<div id="manage-students-modal" class="fixed-modal hidden opacity-0 z-50">
  <div class="modal-content">
    <h2 class="text-2xl font-bold mb-4 text-center" style="color:var(--brand)">Gestión de Alumnos</h2>

    <div class="tabs">
      <div class="tab active" data-tab="fixed">Fijos</div>
      <div class="tab" data-tab="sporadic">Esporádicos</div>
      <div class="tab" data-tab="all">Todos</div>
    </div>

    <div class="tab-content active" id="fixed-tab">
      <div class="student-list" id="fixed-students-list"></div>
    </div>

    <div class="tab-content" id="sporadic-tab">
      <div class="student-list" id="sporadic-students-list"></div>
    </div>

    <div class="tab-content" id="all-tab">
      <div class="student-list" id="all-students-list"></div>
    </div>

    <div class="flex justify-end gap-4 mt-6">
      <button id="close-manage-modal" class="ghost">Cancelar</button>
    </div>
  </div>
</div>

</body>
</html>
