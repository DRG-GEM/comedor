<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gestor de Comedor Escolar</title>

<!-- Tailwind CDN para prototipo -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<meta name="theme-color" content="#ffffff">

<style>
:root{
  --bg:#f6f7f9; --paper:#fff; --text:#0f172a; --muted:#6b7280;
  --brand:#8b0630; --brand-dark:#700424; --accent:#19b4d6; --success:#004623; --danger:#c92a2a;
  --card-border: rgba(15,23,42,0.06);
}
*{box-sizing:border-box}
html,body{width:100%; overflow-x:hidden; -webkit-overflow-scrolling:touch;}
body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:var(--text); margin:0; -webkit-font-smoothing:antialiased;}
.container { max-width:1100px; width:100%; margin:0 auto; padding:20px; box-sizing:border-box; }
.header-row { display:flex; align-items:center; justify-content:space-between; gap:12px; }
.logo { width:54px;height:54px;border-radius:10px;background:#fff;display:inline-flex;align-items:center;justify-content:center;box-shadow:0 6px 20px rgba(15,23,42,0.04);border:1px solid var(--card-border); }
.title-wrap { text-align:center; flex:1; min-width:0; }
h1 { margin:8px 0 0; color:var(--brand); font-weight:800; font-size:28px; }
.subtle { color:var(--muted); }

.header-actions { display:flex; gap:8px; align-items:center; justify-content:flex-end; min-width:150px; }

/* Paneles */
.admin-panel { background:var(--paper); border-radius:12px; padding:18px; border:1px solid var(--card-border); box-shadow:0 14px 36px rgba(15,23,42,0.04); margin-top:18px; overflow:hidden; }
.btn-row { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
button.primary { background:linear-gradient(180deg,var(--brand),var(--brand-dark)); color:#fff; padding:10px 16px; border-radius:999px; font-weight:700; border:0; cursor:pointer; white-space:nowrap; }
button.ghost { background:#fff; border:1px solid rgba(15,23,42,0.06); padding:10px 14px; border-radius:10px; cursor:pointer; }
button.small { padding:6px 8px; font-size:0.9rem; border-radius:8px; }

/* Summary + grid */
.summary-card { background:var(--paper); padding:14px; border-radius:10px; border:1px solid var(--card-border); box-shadow:0 10px 30px rgba(15,23,42,0.03); text-align:center; }
#courses-container { margin-top:14px; display:grid; gap:14px; grid-template-columns: repeat(auto-fill, minmax(260px,1fr)); }

/* Course card */
.course-card { background:var(--paper); border-radius:10px; padding:12px; border:1px solid var(--card-border); box-shadow:0 8px 24px rgba(15,23,42,0.03); display:flex; flex-direction:column; gap:8px; overflow:hidden; min-width:0; }
.course-card h3 { color:var(--brand); margin:0; font-weight:700; white-space:normal; }

/* Student item */
.student-item { background:#ffffff; border-radius:10px; padding:12px; display:flex; align-items:center; justify-content:space-between; gap:12px; border-left:6px solid transparent; border:1px solid rgba(15,23,42,0.04); transition: background .12s ease, box-shadow .12s ease, transform .06s ease; word-break:break-word; min-width:0; }
.student-left { display:flex; gap:12px; align-items:center; min-width:0; }
.student-name { font-weight:700; font-size:1.02rem; }
.student-meta { color:var(--muted); font-size:0.92rem; }

/* Prevent long names causing horizontal overflow */
.student-item .name, .student-item .student-name {
  max-width:100%;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  word-break:break-word;
  overflow-wrap:anywhere;
  min-width:0;
}

/* States */
.student-item.pending { border-left-color:#cbd5e1; background:#fff; color:var(--text); }
.student-item.present { border-left-color:var(--success); background: var(--success); color:#ffffff; box-shadow: 0 8px 20px rgba(0,70,35,0.12); }
.student-item.present * { color: #ffffff !important; } /* asegurar contraste del texto dentro */
.student-item.absent { border-left-color:var(--danger); background:linear-gradient(90deg, rgba(201,42,42,0.04), #fff); text-decoration:line-through; opacity:0.96; }

/* Alergia: recuadro alrededor del nombre (pantalla) */
.student-item.allergic .name {
  border: 3px solid #facc15;   /* amarillo intenso */
  background: #fef9c3;        /* amarillo claro */
  padding: 6px 10px;
  border-radius: 8px;
  display: inline-block;
  font-weight: 700;
  color: inherit;
}

/* cuando est√° presente y al√©rgico, mantener contraste */
.student-item.present.allergic .name {
  border-color: #facc15;
  background: #fde047; /* un amarillo m√°s fuerte sobre fondo oscuro */
  color: #000;
}

/* En impresi√≥n quitamos el fondo pero mantenemos el borde */
@media print {
  .student-item.allergic .name {
    background: transparent !important;
    border: 2px solid #facc15 !important;
    color: #000 !important;
  }
}


/* X button */
.mark-absent-btn { width:40px; height:40px; border-radius:8px; border:1px solid rgba(0,0,0,0.04); background:#fff; font-weight:700; cursor:pointer; }

/* Report styling (tables grandes --> scroll dentro del wrapper para no romper el layout) */
.report-wrapper { background:var(--paper); border-radius:12px; padding:10px; border:1px solid var(--card-border); box-shadow:0 10px 30px rgba(15,23,42,0.03); overflow:auto; -webkit-overflow-scrolling:touch; }
.report-table { width:100%; border-collapse:collapse; font-size:13px; min-width:700px; }
.report-table th, .report-table td { border:1px solid rgba(15,23,42,0.06); padding:6px 6px; text-align:center; min-width:28px; }
.report-table thead th { background:#fff; position:sticky; top:0; z-index:2; }
.report-table td.total { font-weight:700; color:var(--brand); }
.attendance-mark { display:inline-flex; align-items:center; justify-content:center; width:20px;height:20px;border-radius:50%; background:var(--success); color:#fff; font-weight:700; }

/* Modal */
.fixed-modal { position:fixed; left:0; top:0; width:100%; height:100%; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.28); z-index:90; padding:12px; box-sizing:border-box; }
.fixed-modal.active { display:flex; }
.modal-content { background:#fff; border-radius:12px; padding:16px; width:92%; max-width:840px; max-height:90vh; overflow:auto; box-shadow:0 18px 40px rgba(0,0,0,0.12); min-width:0; }

.small-muted { color:var(--muted); font-size:0.85rem; }

/* Make images and svg responsive */
img, svg { max-width:100%; height:auto; display:block; }

@media (max-width:800px){
  #courses-container { grid-template-columns:1fr; }
}

/* Better mobile adjustments */
@media (max-width:600px){
  .container { padding:12px; }
  .header-row { flex-direction:column; align-items:flex-start; gap:8px; }
  .title-wrap { text-align:left; width:100%; }
  h1 { font-size:20px; margin:4px 0 0; }
  .header-actions { width:100%; justify-content:flex-start; }
  .admin-panel { padding:12px; }
  .btn-row { justify-content:flex-start; }
  .course-card { padding:10px; }
  .course-card h3 { font-size:1rem; }
  .student-item { flex-direction:row; align-items:center; gap:10px; padding:10px; }
  .student-item .name { font-size:0.98rem; max-width:65%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .student-item .flex, .student-item > .flex { flex:0 0 auto; display:inline-flex; }
  .mark-absent-btn { width:36px; height:36px; }
  .report-table th, .report-table td { font-size:11px; padding:4px; }
  .modal-content { width:96%; padding:12px; max-width:720px; }
  #shift-buttons button { padding:8px 12px; font-size:0.95rem; }
}

@media print{
  body * { visibility:hidden; }
  .printable-area, .printable-area * { visibility:visible; }
  .printable-area { position:absolute; left:0; top:0; width:100%; background:#fff; padding:8px; }
  @page { size: landscape; margin:0.4cm; }
}

/* utility hidden class fallback (if tailwind not available) */
.hidden { display:none !important; }
  /* ----------------------------
   Ajustes para resumen en m√≥vil
   ---------------------------- */

/* Convertir la fila de resumen (primera section dentro de #dashboard) en flex centrado */
#dashboard > section:first-of-type {
  display: flex !important;
  gap: 10px;
  justify-content: center;
  align-items: center;
  flex-wrap: wrap;
  margin-bottom: 12px;
  padding: 0 6px;
  box-sizing: border-box;
}

/* Tarjetas: tama√±o controlado, centradas y con texto adaptativo */
.summary-card {
  flex: 0 1 160px;      /* crecer 0, encoger 1, base 160px */
  max-width: 180px;
  min-width: 120px;
  padding: 10px;
  text-align: center;
  display: flex;
  flex-direction: column;
  gap: 6px;
  justify-content: center;
  align-items: center;
}

/* N√∫mero dentro de la tarjeta (ajustable) */
.summary-card > div[style] {
  font-size: 20px !important;
  font-weight: 800 !important;
  line-height: 1;
}

/* Texto peque√±o */
.summary-card .small-muted {
  font-size: 0.78rem;
}

/* Evitar que el grid de cursos provoque overflow lateral en m√≥viles */
#courses-container {
  width: 100%;
  box-sizing: border-box;
  overflow-x: hidden; /* evitar scroll horizontal inesperado */
}

/* Ajustes m√°s agresivos para pantallas peque√±as */
@media (max-width: 600px) {
  /* Tarjetas a√∫n m√°s compactas en m√≥vil */
  .summary-card {
    flex: 0 1 140px;
    max-width: 160px;
    min-width: 110px;
    padding: 8px;
  }
  .summary-card > div[style] { font-size: 18px !important; }

  /* Reduce paddings generales que causan desbordamiento */
  .container { padding-left: 12px; padding-right: 12px; }

  /* Asegurar que los botones en la cabecera no empujen el layout */
  .header-row { gap: 8px; }

  /* Student items: si la tarjeta era la causa, hacemos que se adapten un poco */
  .student-item { padding-left: 10px; padding-right: 8px; }
  .student-item .name { max-width: 60%; font-size: 0.98rem; }

  /* Si a√∫n existiera overflow en tablas del informe, permitir wrap en impresi√≥n ya manejado antes */
  #courses-container { padding-right: 6px; }
}
/* -----------------------
   Pantalla principal
   ----------------------- */
.main-screen {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  padding: 40px 20px;
  text-align: center;
  min-height: calc(100vh - 60px); /* deja margen con la cabecera si la hay */
}

.app-title {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--primary, #8b0630);
  margin-bottom: 8px;
}

.app-subtitle {
  font-size: 1.1rem;
  color: #374151;
  margin-bottom: 28px;
}

.turn-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  justify-content: center;
}

.turn-btn {
  background: var(--primary, #8b0630);
  color: #fff;
  font-size: 1.1rem;
  font-weight: 600;
  padding: 14px 28px;
  border: none;
  border-radius: 9999px;
  cursor: pointer;
  transition: background 0.2s, transform 0.1s;
  min-width: 160px;
}

.turn-btn:hover {
  background: #a50a3d;
}

.turn-btn:active {
  transform: scale(0.97);
}

/* Responsive */
@media (max-width: 500px) {
  .app-title { font-size: 1.5rem; }
  .app-subtitle { font-size: 1rem; margin-bottom: 20px; }
  .turn-btn { font-size: 1rem; padding: 12px 22px; min-width: 140px; }
}
/* -----------------------------
  Estilo moderno para pantalla principal / selecci√≥n de turno
   ----------------------------- */

.shift-selection {
  text-align: center;
  padding: 28px 12px;
}

/* t√≠tulo principal */
.main-hero-title {
  font-size: 1.6rem;
  font-weight: 700;
  color: var(--brand);
  margin: 0 0 18px 0;
}

/* contenedor de "tarjetas" */
.turn-cards {
  display: flex;
  gap: 20px;
  justify-content: center;
  align-items: stretch;
  flex-wrap: wrap;
  margin: 0 auto;
  max-width: 920px;
  padding: 8px;
  box-sizing: border-box;
}

/* tarjeta */
.turn-card {
  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 320px;
  height: 96px;
  padding: 0;
  border: none;
  border-radius: 20px;
  background: transparent;
  cursor: pointer;
  overflow: visible;
  box-shadow: 0 10px 30px rgba(11,15,27,0.04);
  transition: transform .12s ease, box-shadow .12s ease;
  -webkit-tap-highlight-color: transparent;
}

/* fondo decorativo (usa color primario) */
.turn-card-bg {
  position: absolute;
  left: 0; right: 0; top: 0; bottom: 0;
  border-radius: 20px;
  background: linear-gradient(180deg, var(--brand), var(--brand-dark));
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.03);
  opacity: 1;
  z-index: 1;
}

/* contenido por encima */
.turn-card-content {
  position: relative;
  z-index: 2;
  color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 14px 20px;
}

/* icono */
.turn-icon {
  font-size: 20px;
  opacity: 0.95;
}

/* etiqueta grande */
.turn-label {
  font-size: 1.15rem;
  font-weight: 700;
  letter-spacing: 0.2px;
}

/* subt√≠tulo peque√±o */
.turn-sub {
  font-size: 0.82rem;
  opacity: 0.92;
  font-weight: 600;
}

/* hover / active */
.turn-card:hover { transform: translateY(-4px); box-shadow: 0 18px 40px rgba(11,15,27,0.06); }
.turn-card:active { transform: translateY(-1px) scale(.996); }

/* responsive: tarjetas m√°s compactas en m√≥vil */
@media (max-width: 760px) {
  .turn-cards { gap: 12px; padding: 6px; }
  .turn-card { width: 260px; height: 88px; border-radius: 16px; }
  .turn-label { font-size: 1.02rem; }
  .turn-sub { font-size: 0.78rem; }
}

/* pantallas muy peque√±as: vertical stack */
@media (max-width: 420px) {
  .turn-cards { flex-direction: column; gap: 12px; align-items: center; }
  .turn-card { width: calc(100% - 40px); max-width: 420px; height: 82px; }
}

/* accesibilidad: foco visible */
.turn-card:focus { outline: 3px solid rgba(255,255,255,0.14); outline-offset: 3px; box-shadow: 0 18px 40px rgba(11,15,27,0.06), 0 0 0 4px rgba(139,6,48,0.08); }

/* si prefieres tarjeta con borde claro en sitios donde var(--brand) sea oscuro */
@media (prefers-color-scheme: light) {
  .turn-card-bg { border: 1px solid rgba(255,255,255,0.06); }
}
/* ------------------------
  Cabecera: estilo limpio y centrado
  ------------------------ */

/* contenedor header: centrado y con separaci√≥n */
.header-row {
  display: grid;
  grid-template-columns: auto 1fr auto;
  gap: 16px;
  align-items: center;
  padding: 12px 0;
  min-height: 68px;
}

/* logo: m√°s n√≠tido y con sombra sutil */
.logo {
  width:56px;
  height:56px;
  border-radius:12px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  background:#fff;
  box-shadow:0 6px 20px rgba(15,23,42,0.04);
  border:1px solid rgba(15,23,42,0.06);
  flex:0 0 auto;
}

/* title area: centrado vertical y con overflow controlado */
.title-wrap {
  text-align:center;
  min-width:0;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:4px;
  padding-left:6px;
  padding-right:6px;
}

/* principal: color y tama√±o m√°s moderno */
.title-wrap h1 {
  margin:0;
  font-size:20px;
  line-height:1;
  font-weight:800;
  color:var(--brand);
  letter-spacing:0.1px;
}

/* subt√≠tulo/role: m√°s peque√±o, contrastado y con separaci√≥n */
.title-wrap .subtle, #role-display {
  margin:0;
  font-size:14px;
  color:var(--muted);
  font-weight:600;
  opacity:0.95;
}

/* header-actions: botones alineados a la derecha y compactos */
.header-actions {
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:flex-end;
  flex:0 0 auto;
}

/* estilo de los botones r√°pidos en la cabecera */
.header-actions .ghost, .header-actions .primary {
  padding:8px 12px;
  font-size:0.95rem;
  border-radius:10px;
  box-shadow:0 6px 18px rgba(11,15,27,0.03);
}

/* hacer logout discreto en mobile */
#logout-btn { display:inline-flex; align-items:center; gap:6px; }

/* ajustar tipograf√≠as y espaciado para buen aspecto en pantallas grandes */
@media (min-width:1100px) {
  .title-wrap h1 { font-size:22px; }
  .title-wrap .subtle { font-size:15px; }
}

/* Mobile: apilar y centrar, evitar desbordamientos */
@media (max-width:760px) {
  .header-row {
    grid-template-columns: auto 1fr;
    grid-auto-rows: auto;
    align-items: center;
    gap:8px;
    padding:10px 6px;
  }
  .header-actions {
    grid-column: 1 / -1;
    justify-content: flex-end;
    width:100%;
  }
  .title-wrap { text-align:left; align-items:flex-start; padding-left:0; }
  .title-wrap h1 { font-size:18px; }
  .title-wrap .subtle { font-size:13px; }
  .logo { width:48px; height:48px; border-radius:10px; }
}

/* small polish: ensure header never causes horizontal scroll */
.header-row, .container { box-sizing:border-box; overflow-x:visible; }

</style>
</head>
<body>

<div class="container">
  <header class="header-row" role="banner">
    <div class="logo" aria-hidden="true"><svg width="34" height="34" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><rect fill="#fff" width="48" height="48" rx="8"/><text x="50%" y="56%" font-size="16" fill="#8b0630" text-anchor="middle" font-family="Inter">CEVP</text></svg></div>

    <div class="title-wrap">
      <h1>Gestor de Comedor</h1>
      <div id="role-display" class="subtle">Cargando...</div>
    </div>

    <div class="header-actions">
      <!-- logout visible cuando admin -->
      <button id="logout-btn" class="ghost small" title="Cerrar sesi√≥n" style="display:none">Cerrar sesi√≥n</button>
    </div>
  </header>

  <!-- Login admin -->
  <div id="admin-login-view" class="admin-panel hidden" style="max-width:640px;margin:14px auto 0">
    <h2 style="text-align:center">Acceso de Administrador</h2>
    <div style="text-align:center;margin-top:10px">
      <button id="login-admin-btn" class="primary">Iniciar sesi√≥n con Google</button>
    </div>
  </div>

  <!-- Main -->
  <div id="main-content" style="margin-top:18px">

    <section id="shift-selection" class="shift-selection" aria-labelledby="shift-title">
  <h2 id="shift-title" class="main-hero-title">Selecciona un turno</h2>

  <!-- <- IMPORTANTE: mantenemos id="shift-buttons" para que el JS siga funcionando -->
  <div id="shift-buttons" class="turn-cards" role="list" aria-label="Turnos disponibles">
    <button class="turn-card" role="listitem" data-shift="Primer Turno (Infantil)" aria-label="Primer Turno">
      <div class="turn-card-bg" aria-hidden="true"></div>
      <div class="turn-card-content">
        <div class="turn-icon" aria-hidden="true">üçΩÔ∏è</div>
        <div class="turn-label">Primer Turno</div>
        <div class="turn-sub">Marcar asistentes</div>
      </div>
    </button>

    <button class="turn-card" role="listitem" data-shift="Segundo Turno (Primaria)" aria-label="Segundo Turno">
      <div class="turn-card-bg" aria-hidden="true"></div>
      <div class="turn-card-content">
        <div class="turn-icon" aria-hidden="true">üïí</div>
        <div class="turn-label">Segundo Turno</div>
        <div class="turn-sub">Marcar asistentes</div>
      </div>
    </button>
  </div>

  <!-- Panel de gesti√≥n (solo admin) -->
  <div class="admin-panel admin-only" style="margin-top:18px">
    <h3 style="text-align:center;margin-bottom:10px">Panel de Gesti√≥n</h3>
    <div class="btn-row" role="group" aria-label="gestion-datos">
      <button id="import-csv-btn-initial" class="primary">üì§ Importar Alumnos (CSV)</button>
      <button id="manage-students-btn" class="primary">üë• Gestionar Alumnos</button>
      <button id="wipe-db" class="ghost">üóëÔ∏è Borrar todos los alumnos</button>
      <button id="show-monthly-report-btn" class="primary">üìÖ Informe Mensual</button>
      <button id="show-history-btn" class="primary">üìú Historial</button>
    </div>
    <div style="margin-top:12px;display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap">
      <input id="export-date-input" type="date" style="padding:8px;border-radius:8px;border:1px solid var(--card-border);background:#fff">
      <button id="export-csv-btn" class="primary">üíæ Exportar CSV del D√≠a</button>
    </div>
    <p id="import-status-initial" style="text-align:center;margin-top:10px;min-height:18px;color:#059669"></p>
  </div>
</section>


    <main id="dashboard" class="hidden" style="margin-top:18px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:wrap">
        <button id="back-to-shifts" class="ghost">&larr; Volver a Turnos</button>
        <div>
          <button id="finalize-shift-btn" class="primary">üèÅ Finalizar Turno</button>
        </div>
      </div>

      <section id="summaries" style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px;align-items:center">
        <div class="summary-card"><div class="small-muted">Comensales</div><div id="summary-diners" style="font-size:18px;font-weight:800">0</div></div>
        <div class="summary-card"><div class="small-muted">Ausentes</div><div id="summary-absent" style="font-size:18px;font-weight:800">0</div></div>
        <div class="summary-card"><div class="small-muted">Pendientes</div><div id="summary-pending" style="font-size:18px;font-weight:800">0</div></div>
        <div class="summary-card"><div class="small-muted">Presentes</div><div id="summary-present" style="font-size:18px;font-weight:800">0</div></div>
      </section>

      <section id="student-lists">
        <div id="courses-container"></div>
      </section>
    </main>

  </div>
</div>

<input id="csv-file-input" type="file" accept=".csv" style="display:none">

<!-- Manage Students Modal (admin) -->
<div id="manage-students-modal" class="fixed-modal" aria-hidden="true">
  <div class="modal-content">
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h2 style="color:var(--brand)">Gestionar Alumnos</h2>
      <button id="close-manage-modal" class="small">‚úï</button>
    </header>
    <div id="manage-students-content" style="max-height:68vh;overflow:auto"></div>
  </div>
</div>

<!-- Sporadic Picker Modal (profesor) -->
<div id="sporadic-picker-modal" class="fixed-modal" aria-hidden="true">
  <div class="modal-content">
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 id="sporadic-picker-title">Seleccionar espor√°dicos</h3>
      <button id="close-sporadic-picker" class="small">‚úï</button>
    </header>
    <div id="sporadic-picker-content" style="max-height:62vh;overflow:auto"></div>
    <footer style="margin-top:8px;text-align:right">
      <button id="confirm-sporadic-add" class="primary">A√±adir seleccionados</button>
    </footer>
  </div>
</div>

<!-- Monthly report modal -->
<div id="monthly-report-modal" class="fixed-modal" aria-hidden="true">
  <div class="modal-content">
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="color:var(--brand)">Informe de Asistencia Mensual</h3>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="report-month-input" type="month" style="padding:8px;border-radius:8px;border:1px solid var(--card-border)">
        <button id="print-report-btn" class="primary">üñ®Ô∏è Imprimir</button>
        <button id="close-report-btn" class="small">‚úï</button>
      </div>
    </header>
    <div id="monthly-report-content" style="max-height:66vh;overflow:auto"></div>
  </div>
</div>

<!-- History modal -->
<div id="history-modal" class="fixed-modal" aria-hidden="true">
  <div class="modal-content">
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="color:var(--brand)">Historial de Asistencia</h3>
      <button id="close-history-btn" class="small">‚úï</button>
    </header>
    <div style="display:flex;gap:14px">
      <div style="width:35%">
        <input id="history-search" placeholder="Buscar alumno..." style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--card-border)">
        <div id="history-student-list" style="margin-top:8px;max-height:52vh;overflow:auto"></div>
      </div>
      <div style="flex:1;background:#fff;border-radius:8px;padding:10px">
        <h4 id="history-student-name">Selecciona un alumno</h4>
        <div id="history-dates-list" style="margin-top:8px;max-height:52vh;overflow:auto"></div>
      </div>
    </div>
  </div>
</div>

<!-- Firebase + PapaParse -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const firebaseConfig = {
    apiKey: "AIzaSyAeI9G1_2-E8Kghc-88bkrXa_VDJXeDyHo",
    authDomain: "comedorvp.firebaseapp.com",
    projectId: "comedorvp",
    storageBucket: "comedorvp.firebasestorage.app",
    messagingSenderId: "821870274048",
    appId: "1:821870274048:web:62b85d28ceace395245ae5"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();
  const googleProvider = new firebase.auth.GoogleAuthProvider();

  // tempSporadic por turno (ahora es por turno, no global)
  const appState = { currentShift: null, students: [], attendance: {}, tempSporadic: { 'Primer Turno (Infantil)': new Set(), 'Segundo Turno (Primaria)': new Set() } };

  const dom = {
    roleDisplay: document.getElementById('role-display'),
    adminLoginView: document.getElementById('admin-login-view'),
    mainContent: document.getElementById('main-content'),
    coursesContainer: document.getElementById('courses-container'),
    importStatusInitial: document.getElementById('import-status-initial'),
    csvFileInput: document.getElementById('csv-file-input'),
    manageStudentsModal: document.getElementById('manage-students-modal'),
    manageStudentsContent: document.getElementById('manage-students-content'),
    closeManageModal: document.getElementById('close-manage-modal'),
    sporadicPickerModal: document.getElementById('sporadic-picker-modal'),
    sporadicPickerContent: document.getElementById('sporadic-picker-content'),
    sporadicPickerTitle: document.getElementById('sporadic-picker-title'),
    closeSporadicPicker: document.getElementById('close-sporadic-picker'),
    confirmSporadicAdd: document.getElementById('confirm-sporadic-add'),
    monthlyReportModal: document.getElementById('monthly-report-modal'),
    monthlyReportContent: document.getElementById('monthly-report-content'),
    reportMonthInput: document.getElementById('report-month-input'),
    printReportBtn: document.getElementById('print-report-btn'),
    closeReportBtn: document.getElementById('close-report-btn'),
    historyModal: document.getElementById('history-modal'),
    historyStudentList: document.getElementById('history-student-list'),
    historyStudentName: document.getElementById('history-student-name'),
    historyDatesList: document.getElementById('history-dates-list'),
    historySearch: document.getElementById('history-search'),
    loginAdminBtn: document.getElementById('login-admin-btn'),
    importCsvBtnInitial: document.getElementById('import-csv-btn-initial'),
    manageStudentsBtn: document.getElementById('manage-students-btn'),
    wipeDbBtn: document.getElementById('wipe-db'),
    exportCsvBtn: document.getElementById('export-csv-btn'),
    exportDateInput: document.getElementById('export-date-input'),
    finalizeShiftBtn: document.getElementById('finalize-shift-btn'),
    backToShiftsBtn: document.getElementById('back-to-shifts'),
    summary: { diners: document.getElementById('summary-diners'), absent: document.getElementById('summary-absent'), pending: document.getElementById('summary-pending'), present: document.getElementById('summary-present') },
    logoutBtn: document.getElementById('logout-btn'),
    showMonthlyBtn: document.getElementById('show-monthly-report-btn'),
    showHistoryBtn: document.getElementById('show-history-btn')
  };

  /* ----- Firestore helpers ----- */
  async function fetchStudents() {
    const snap = await db.collection('students').get();
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  }
  async function addStudentBatch(students) {
    const batch = db.batch(); const col = db.collection('students'); let added = 0;
    students.forEach(s => {
      if (s.name && s.course) {
        const docRef = col.doc();
        // keep old shape: shift string ('' if none), allergic boolean
        batch.set(docRef, { name: s.name.trim(), course: s.course.trim(), shift: s.shift ? s.shift.trim() : '', allergic: !!s.allergic });
        added++;
      }
    });
    if (added) await batch.commit();
    return added;
  }
  async function updateStudentDoc(id, updates) {
    try { await db.collection('students').doc(id).update(updates); return true; }
    catch(e){ console.error(e); return false; }
  }
  async function deleteAllStudents() { const snap = await db.collection('students').get(); const batch = db.batch(); snap.docs.forEach(d => batch.delete(d.ref)); await batch.commit(); }

  async function logAttendance(studentId, dateStr, state) {
    if (studentId.startsWith && studentId.startsWith('sporadic_')) return;
    const docRef = db.collection('attendance').doc(`${studentId}_${dateStr}`);
    await docRef.set({ studentId, date: dateStr, state });
  }
  async function logBatchAttendance(ids, dateStr, state) {
    const valid = ids.filter(id => !(id.startsWith && id.startsWith('sporadic_')));
    if (!valid.length) return;
    const batch = db.batch(); const col = db.collection('attendance');
    valid.forEach(id => batch.set(col.doc(`${id}_${dateStr}`), { studentId: id, date: dateStr, state }));
    await batch.commit();
  }
  async function fetchAttendanceByDate(dateStr) { const snap = await db.collection('attendance').where('date','==',dateStr).get(); const out = {}; snap.docs.forEach(d=>out[d.data().studentId]=d.data().state); return out; }
  async function fetchAttendanceByMonth(ym) { const start=ym+'-01', end=ym+'-31'; const snap = await db.collection('attendance').where('date','>=',start).where('date','<=',end).get(); const map = new Map(); snap.docs.forEach(d=>{ const r=d.data(); if(!map.has(r.studentId)) map.set(r.studentId,new Set()); const day = parseInt(r.date.slice(-2).replace(/^0+/,''),10); if(!isNaN(day)) map.get(r.studentId).add(day);}); return map; }

  /* ----- UI helpers ----- */
  function updateSummary() {
    const vals = Object.values(appState.attendance || {});
    dom.summary.diners.textContent = vals.length;
    dom.summary.absent.textContent = vals.filter(v=>'absent'===v).length;
    dom.summary.present.textContent = vals.filter(v=>'present'===v).length;
    dom.summary.pending.textContent = vals.filter(v=>'pending'===v).length;
  }

  function createStudentElement(s) {
    const div = document.createElement('div');
    const stateClass = appState.attendance && appState.attendance[s.id]
      ? appState.attendance[s.id]
      : 'pending';

    div.className = `student-item ${stateClass}${s.allergic ? ' allergic' : ''}`;
    div.dataset.studentId = s.id;
    div.dataset.studentName = s.name;

    div.innerHTML = `
      <span class="name ${s.allergic ? 'allergic' : ''}">${s.name}</span>
      <div class="flex items-center gap-2">
        <button class="mark-absent-btn" title="Marcar ausente">&times;</button>
      </div>
    `;
    return div.outerHTML;
  }

  /* ----- Render courses ----- */
  async function renderCourses(shift) {
  appState.currentShift = shift;
  document.getElementById('shift-selection').style.display = 'none';
  document.getElementById('dashboard').classList.remove('hidden');
  dom.coursesContainer.innerHTML = '<p class="small-muted">Cargando alumnos...</p>';

  // Cargar datos
  appState.students = await fetchStudents();
  const today = new Date().toISOString().slice(0,10);
  const attendance = await fetchAttendanceByDate(today); // mapa id -> estado
  appState.attendance = {};
  appState.students.forEach(s => { appState.attendance[s.id] = attendance[s.id] || 'pending'; });

  dom.coursesContainer.innerHTML = '';

  // Conjunto de tempSporadic para este turno (seguridad por si no existiera)
  const sporadicSetForShift = (appState.tempSporadic && appState.tempSporadic[shift]) ? appState.tempSporadic[shift] : new Set();

  // Alumnos fijos para el turno (comprobamos el string completo de shift)
  const fixed = appState.students.filter(s => s.shift && s.shift === shift);

  // Alumnos sin turno asignado -> candidatos espor√°dicos (aparecen en ambos turnos)
  const esporadicos = appState.students.filter(s => !s.shift || s.shift.trim() === '');

  // Alumnos asignados a mostrar: fijos + espor√°dicos a√±adidos temporalmente para este turno
  const assigned = appState.students.filter(s => (s.shift && s.shift === shift) || sporadicSetForShift.has(s.id));

  // Reunir cursos que tengan al menos un asignado o al menos un candidato espor√°dico
  const courseSet = new Set();
  assigned.forEach(s => courseSet.add(s.course));
  esporadicos.forEach(s => courseSet.add(s.course));

  const courses = [...courseSet].sort((a,b) => (a||'').localeCompare(b||''));

  if (!courses.length) {
    dom.coursesContainer.innerHTML = '<p class="small-muted">No hay alumnos en este turno.</p>';
    updateSummary();
    return;
  }

  // Pintar cursos
  courses.forEach(course => {
    const card = document.createElement('div');
    card.className = 'course-card';

    // Los que deben listarse como filas: solo los "assigned" (fijos del turno + los espor√°dicos ya a√±adidos para este turno)
    const studentsInCourse = assigned.filter(s => s.course === course).sort((a,b) => a.name.localeCompare(b.name));
    const listHtml = studentsInCourse.map(createStudentElement).join('');

    // Candidatos espor√°dicos por curso: todos los sin turno de ese curso
    const sporadicCandidates = esporadicos.filter(s => s.course === course).sort((a,b) => a.name.localeCompare(b.name));

    const pickerBtn = sporadicCandidates.length > 0
      ? `<div style="margin-top:8px"><button class="open-sporadic-picker primary" data-course="${course}">+ A√±adir espor√°dico</button></div>`
      : '';

    card.innerHTML = `<div><h3>${course}</h3><div style="display:flex;flex-direction:column;gap:8px" data-course-list="${course}">${listHtml}</div></div>${pickerBtn}`;
    dom.coursesContainer.appendChild(card);
  });

  updateSummary();
}



  /* ----- Sporadic picker ----- */
  let currentPickerCourse = null;
  function openSporadicPickerModal(course) {
    currentPickerCourse = course;
    dom.sporadicPickerTitle.textContent = `Seleccionar espor√°dicos ‚Äî ${course}`;
    // candidates: students in that course WITHOUT any assigned shift (shift falsy)
    // They should appear in picker for both turns; we only exclude those already added as tempSporadic for THIS shift
    const shift = appState.currentShift;
    const candidates = appState.students.filter(s => s.course === course && (!s.shift || s.shift.trim()==='') && !appState.tempSporadic[shift].has(s.id));
    const container = dom.sporadicPickerContent;
    if (!candidates.length) {
      container.innerHTML = `<p class="small-muted">No hay alumnos sin turno asignado en ${course}.</p>`;
    } else {
      let html = `<div style="display:flex;flex-direction:column;gap:8px">`;
      candidates.sort((a,b)=>a.name.localeCompare(b.name)).forEach(s => {
        html += `<label style="display:flex;align-items:center;gap:8px;padding:8px;border:1px solid var(--card-border);border-radius:8px;background:#fff">
                   <input type="checkbox" class="sporadic-candidate" data-id="${s.id}">
                   <div style="flex:1"><strong>${s.name}</strong><div class="small-muted">${s.course}</div></div>
                 </label>`;
      });
      html += `</div>`;
      container.innerHTML = html;
    }
    dom.sporadicPickerModal.classList.add('active');
  }
  dom.closeSporadicPicker.addEventListener('click', () => dom.sporadicPickerModal.classList.remove('active'));
  dom.confirmSporadicAdd.addEventListener('click', async () => {
    const checked = Array.from(dom.sporadicPickerContent.querySelectorAll('.sporadic-candidate:checked')).map(cb => cb.dataset.id);
    if (!checked.length) { alert('Selecciona al menos un alumno.'); return; }
    const today = new Date().toISOString().slice(0,10);
    const shift = appState.currentShift;
    for (const id of checked) {
      try {
        // register attendance for today as present
        await logAttendance(id, today, 'present');
        // add as sporadic only for the current shift (so doesn't appear in the other shift)
        appState.tempSporadic[shift].add(id);
        appState.attendance[id] = 'present';
      } catch (e) { console.error('error al a√±adir espor√°dico', e); }
    }
    if (appState.currentShift) await renderCourses(appState.currentShift);
    dom.sporadicPickerModal.classList.remove('active');
  });

  /* ----- CSV import ----- */
  function handleCsvImport(file) {
    if (!file) return;
    dom.importStatusInitial.textContent = 'Procesando archivo...';
    Papa.parse(file, { header:true, skipEmptyLines:true,
      complete: async (results) => {
        try {
          const fields = (results.meta.fields || []).map(f => (f||'').toLowerCase().trim());
          if (!fields.includes('nombre') || !fields.includes('curso')) {
            dom.importStatusInitial.textContent = 'Error: CSV debe tener columnas "nombre" y "curso" (turno opcional).';
            return;
          }
          await deleteAllStudents();
          const mapped = results.data.map(r => {
            const rawShift = (r.turno || r.shift || '').toString().trim();
            let shift = '';
            if (rawShift) {
              if (/primer/i.test(rawShift)) shift = 'Primer Turno (Infantil)';
              else if (/segund/i.test(rawShift)) shift = 'Segundo Turno (Primaria)';
              else shift = rawShift;
            }
            return { name: (r.nombre||'').toString().trim(), course: (r.curso||'').toString().trim(), shift, allergic: false };
          });
          const added = await addStudentBatch(mapped);
          dom.importStatusInitial.textContent = `Importaci√≥n completa ‚úÖ (${added})`;
          appState.students = await fetchStudents();
          if (appState.currentShift) await renderCourses(appState.currentShift);
        } catch (err) {
          console.error('CSV import error', err);
          dom.importStatusInitial.textContent = 'Error al procesar CSV. Mira la consola.';
        } finally { setTimeout(()=>dom.importStatusInitial.textContent='',5000); }
      },
      error: (err) => { console.error(err); dom.importStatusInitial.textContent = 'Error leyendo CSV'; setTimeout(()=>dom.importStatusInitial.textContent='',3000); }
    });
  }

  /* ----- Export CSV ----- */
  async function exportFullDayCsv(dateStr) {
    const all = await fetchStudents();
    const attendance = await fetchAttendanceByDate(dateStr);
    const rows = all.map(s => ({ Fecha: dateStr, Turno: s.shift || '(Espor√°dico)', Nombre: s.name, Curso: s.course, Estado: attendance[s.id] || 'pending' }));
    rows.sort((a,b) => (a.Turno||'').localeCompare(b.Turno||'') || a.Curso.localeCompare(b.Curso) || a.Nombre.localeCompare(b.Nombre));
    const csv = Papa.unparse(rows);
    const blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `asistencia_${dateStr}.csv`; a.click(); URL.revokeObjectURL(url);
  }

  /* ----- Finalizar turno ----- */
  async function finalizeShift() {
    if (!confirm('¬øSeguro que quieres finalizar el turno? Los pendientes pasar√°n a ausentes.')) return;
    const today = new Date().toISOString().slice(0,10);
    const toMark = [];
    for (const id in appState.attendance) {
      if (appState.attendance[id] === 'pending') {
        appState.attendance[id] = 'absent';
        toMark.push(id);
        // no dependemos de elementos con id en DOM ‚Äî re-render will show correct classes
      }
    }
    await logBatchAttendance(toMark, today, 'absent');
    updateSummary();
    if (appState.currentShift) await renderCourses(appState.currentShift);
  }

  /* ----- History ----- */
  async function showHistoryModal() {
  dom.historyModal.classList.add('active');
  dom.historyStudentList.innerHTML = '<p class="small-muted">Cargando...</p>';

  try {
    const all = await fetchStudents();
    all.sort((a,b)=>a.name.localeCompare(b.name));
    if (!all.length) {
      dom.historyStudentList.innerHTML = '<p class="small-muted">No hay alumnos registrados.</p>';
      return;
    }
    dom.historyStudentList.innerHTML = all.map(s =>
      `<div class="history-student p-2" data-id="${s.id}" data-name="${s.name}" style="border-bottom:1px solid var(--card-border);padding:8px;cursor:pointer">
         <strong>${s.name}</strong>
         <div class="small-muted">${s.shift || '(Espor√°dico)'} ‚Ä¢ ${s.course}</div>
       </div>`
    ).join('');
  } catch (e) {
    console.error('Error cargando lista de alumnos para historial:', e);
    dom.historyStudentList.innerHTML = '<p class="small-muted">Error cargando alumnos.</p>';
  }
}

// 3) Funci√≥n para mostrar historial de un alumno (reemplaza la anterior)
async function showStudentHistory(id, name) {
  dom.historyStudentName.textContent = `Historial de: ${name}`;
  dom.historyDatesList.innerHTML = '<p class="small-muted">Buscando...</p>';
  try {
    const snap = await db.collection('attendance').where('studentId','==',id).get();
    if (snap.empty) {
      dom.historyDatesList.innerHTML = '<p class="small-muted">Sin registros.</p>';
      return;
    }
    // ordenar por fecha descendente (formato 'YYYY-MM-DD' -> compara como string)
    const rows = snap.docs.map(d => d.data()).sort((a,b) => (b.date||'').localeCompare(a.date||''));
    dom.historyDatesList.innerHTML = rows.map(r => {
      const pretty = (r.date && !isNaN(Date.parse(r.date))) ? 
        new Date(r.date + 'T00:00:00').toLocaleDateString('es-ES',{weekday:'long',year:'numeric',month:'long',day:'numeric'}) 
        : (r.date || '‚Äî');
      const state = r.state || (r.status || '‚Äî');
      return `<div style="padding:6px;border-bottom:1px solid var(--card-border);display:flex;justify-content:space-between;align-items:center">
                <div style="text-align:left">${pretty}</div>
                <div style="text-align:right"><strong>${state}</strong></div>
              </div>`;
    }).join('');
  } catch (err) {
    console.error('Error cargando historial del alumno:', err);
    dom.historyDatesList.innerHTML = '<p class="small-muted">Error cargando historial.</p>';
  }
}

  /* ----- Monthly report + print ----- */
  /* ---------------------------
   INFORME MENSUAL (parche)
   --------------------------- */

async function generateMonthlyReport(ym) {
  dom.monthlyReportContent.innerHTML = '<p class="small-muted">Generando informe...</p>';
  if (!ym || !/^\d{4}-\d{2}$/.test(ym)) {
    dom.monthlyReportContent.innerHTML = '<p style="color:#b45309">Selecciona un mes v√°lido.</p>';
    return;
  }

  try {
    const [yStr,mStr] = ym.split('-');
    const y = parseInt(yStr,10), m = parseInt(mStr,10);
    const days = new Date(y, m, 0).getDate(); // n√∫mero de d√≠as del mes

    // datos
    const allStudents = await fetchStudents(); // [{id,name,course,shift,allergic}]
    const attendanceData = await fetchAttendanceByMonth(ym); // debe devolver Map studentId -> Set(days)
    // seguridad: si fetchAttendanceByMonth devuelve objeto en otro formato, normalizamos:
    // (la impl. existente deber√≠a devolver Map, si no, adaptarlo)
    const attendanceMap = (attendanceData instanceof Map) ? attendanceData : new Map(Object.entries(attendanceData || {}));

    // agrupar por curso (incluimos cursos vac√≠os por si)
    const byCourse = allStudents.reduce((acc, s) => { (acc[s.course] = acc[s.course] || []).push(s); return acc; }, {});

    if (!Object.keys(byCourse).length) {
      dom.monthlyReportContent.innerHTML = '<p class="small-muted">No hay alumnos registrados.</p>';
      return;
    }

    // construir HTML del informe
    let html = `<div class="printable-area"><h2 style="text-align:center">${new Date(y, m-1, 1).toLocaleString('es-ES', { month: 'long', year: 'numeric' })}</h2>`;

    Object.keys(byCourse).sort((a,b)=> (a||'').localeCompare(b||'')).forEach(course => {
      const students = byCourse[course].sort((a,b)=> a.name.localeCompare(b.name));
      html += `<div class="report-wrapper" style="margin-top:12px"><div style="display:flex;justify-content:space-between;align-items:center"><strong>${course}</strong><small>D√≠as: ${days} ‚Äî ${students.length} alumnos</small></div><div style="overflow:auto;margin-top:8px"><table class="report-table"><thead><tr><th style="min-width:180px;text-align:left;padding-left:8px">Alumno</th>`;

      for (let d=1; d<=days; d++) html += `<th>${d}</th>`;
      html += `<th>Total</th></tr></thead><tbody>`;

      students.forEach(st => {
        const attended = attendanceMap.get(st.id) || new Set();
        html += `<tr><td style="text-align:left;padding-left:8px">${st.name}</td>`;
        for (let d=1; d<=days; d++) {
          html += attended.has(d) ? `<td><span class="attendance-mark">‚úì</span></td>` : `<td></td>`;
        }
        html += `<td class="total">${attended.size || 0}</td></tr>`;
      });

      html += `</tbody></table></div></div>`;
    });

    html += `</div>`;
    dom.monthlyReportContent.innerHTML = html;
  } catch (err) {
    console.error('Error generando informe mensual:', err);
    dom.monthlyReportContent.innerHTML = `<p class="small-muted">Error al generar el informe. Mira la consola.</p>`;
  }
}

// abre el modal (y preselecciona mes actual si no hay valor)
function openMonthlyReportModal() {
  const now = new Date();
  const ymDefault = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  try {
    if (!dom.reportMonthInput) {
      // crear input si no existe (fallback)
      const wrapper = document.createElement('div');
      wrapper.style.display = 'inline-flex';
      wrapper.style.gap = '8px';
      const input = document.createElement('input');
      input.type = 'month';
      input.id = 'report-month-input';
      input.style.padding = '8px';
      input.style.borderRadius = '8px';
      input.style.border = '1px solid var(--card-border)';
      wrapper.appendChild(input);
      dom.monthlyReportModal.querySelector('header > div')?.insertBefore(wrapper, dom.printReportBtn || null);
      dom.reportMonthInput = input;
    }
    dom.reportMonthInput.value = dom.reportMonthInput.value || ymDefault;
  } catch(e){ console.warn('fallback reportMonthInput create', e); }

  dom.monthlyReportModal.classList.add('active');
  // generar al abrir
  generateMonthlyReport(dom.reportMonthInput.value || ymDefault);
}

// Listener imprimir: crea iframe y llama a print (con color coherente)
if (dom.printReportBtn) {
  dom.printReportBtn.removeEventListener?.('click', null); // intento de evitar duplicados
  dom.printReportBtn.addEventListener('click', async () => {
    let ym = dom.reportMonthInput?.value;
    if (!ym) {
      const now = new Date();
      ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      if (dom.reportMonthInput) dom.reportMonthInput.value = ym;
    }
    await generateMonthlyReport(ym);
    const content = dom.monthlyReportContent.innerHTML;
    if (!content) { alert('No hay contenido para imprimir.'); return; }

    const iframe = document.createElement('iframe');
    iframe.style.position = 'fixed';
    iframe.style.right = '0';
    iframe.style.bottom = '0';
    iframe.style.width = '0';
    iframe.style.height = '0';
    iframe.style.border = '0';
    document.body.appendChild(iframe);

    const doc = iframe.contentWindow.document;
    const successColor = getComputedStyle(document.documentElement).getPropertyValue('--success') || '#004623';
const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary') || '#8b0630';

const styles = `
  <style>
    body {
      font-family: Inter, Arial, sans-serif;
      padding: 18px;
      color: #111;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }

    /* Ticks */
    .attendance-mark {
      display: inline-block;
      width: 20px;
      height: 20px;
      background: ${successColor} !important;
      color: #fff !important;
      border-radius: 50%;
      text-align: center;
      line-height: 20px;
      font-weight: 700;
    }

    /* Tabla general */
    .report-table {
      border-collapse: collapse;
      width: 100%;
      table-layout: auto; /* permitir que la primera columna tenga espacio */
    }
    .report-table th, .report-table td {
      border: 1px solid #e6e8eb;
      padding: 6px;
      text-align: center;
      vertical-align: middle;
    }
    .report-table thead th {
      background: #f3f4f6;
      font-weight: 700;
    }

    /* Primera columna: nombres de alumno (m√°s ancha, alineada a la izquierda y texto que salte l√≠neas) */
    .report-table th:first-child,
    .report-table td:first-child {
      text-align: left;
      padding-left: 8px;
      min-width: 200px;   /* m√≠nimo razonable para nombres largos */
      max-width: 320px;   /* evita que se coma TODO el ancho */
      white-space: normal; /* permitir wrapping */
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    /* Fuerza que el contenido de las celdas mantenga buena legibilidad */
    .report-table td { 
      white-space: nowrap;       /* por defecto los d√≠as no se parten */
    }
    /* pero permitimos al primer td romper l√≠neas */
    .report-table td:first-child { white-space: normal; }

    /* Encabezado de curso (fondo primario) */
    .report-wrapper > div:first-child {
      background: ${primaryColor} !important;
      color: #fff !important;
      padding: 6px 10px;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    /* --- Fix impresi√≥n --- */
    @media print {
      .report-wrapper div[style*="overflow:auto"] {
        overflow: visible !important;
      }
      /* evitar que la tabla reduzca demasiado las columnas en impresi√≥n */
      .report-table { table-layout: auto !important; }
      .report-table th:first-child,
      .report-table td:first-child {
        min-width: 200px !important;
        max-width: 320px !important;
      }
    }
  </style>`;

    doc.open();
    doc.write(`<!doctype html><html><head><meta charset="utf-8"><title>Informe ${ym}</title>${styles}</head><body>${content}</body></html>`);
    doc.close();

    // peque√±o delay para que renderice antes de imprimir
    setTimeout(() => {
      try { iframe.contentWindow.focus(); iframe.contentWindow.print(); }
      catch (e) { console.error('Error al imprimir:', e); alert('Error al imprimir: ' + e.message); }
      setTimeout(() => { try { document.body.removeChild(iframe); } catch (e) {} }, 800);
    }, 300);
  });
}

// Asegurar que existe un bot√≥n para abrir el modal. Si no existe, lo creamos dentro del panel admin (admin-only)
(function ensureMonthlyReportButton() {
  let btn = document.getElementById('show-monthly-report-btn');
  if (!btn) {
    // crear un bot√≥n discreto dentro del panel admin
    const adminPanel = document.querySelector('.admin-panel.admin-only');
    if (adminPanel) {
      btn = document.createElement('button');
      btn.id = 'show-monthly-report-btn';
      btn.className = 'ghost small';
      btn.textContent = 'üìÖ Informe Mensual';
      btn.style.marginTop = '10px';
      adminPanel.appendChild(btn);
    }
  }
  if (btn) {
    btn.removeEventListener?.('click', null);
    btn.addEventListener('click', openMonthlyReportModal);
  }
})();


  /* ----- Manage students modal (admin) ----- */
  async function openManageStudentsModal() {
    dom.manageStudentsModal.classList.add('active');
    dom.manageStudentsContent.innerHTML = '<p class="small-muted">Cargando...</p>';
    const all = await fetchStudents(); const byCourse = all.reduce((acc,s)=>{ (acc[s.course]=acc[s.course]||[]).push(s); return acc; },{});
    let html = '';
    // For each course, list students with only 3 controls: Primer, Segundo, Alergia
    Object.keys(byCourse).sort().forEach(course=>{
      html += `<h4 style="margin-top:12px;color:var(--brand)">${course}</h4>`;
      byCourse[course].sort((a,b)=>a.name.localeCompare(b.name)).forEach(s=>{
        const checkedPrimer = s.shift === 'Primer Turno (Infantil)' ? 'checked' : '';
        const checkedSegundo = s.shift === 'Segundo Turno (Primaria)' ? 'checked' : '';
        const isAllergic = s.allergic ? 'checked' : '';
        html += `<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;padding:8px;border-bottom:1px solid var(--card-border);align-items:center">
                  <div><strong>${s.name}</strong></div>
                  <div style="display:flex;gap:8px;align-items:center">
                    <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" class="student-shift-checkbox" data-id="${s.id}" data-prop="primer" ${checkedPrimer}> 1¬∫ turno</label>
                    <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" class="student-shift-checkbox" data-id="${s.id}" data-prop="segundo" ${checkedSegundo}> 2¬∫ turno</label>
                  </div>
                  <div style="display:flex;justify-content:flex-end;gap:8px;align-items:center">
                    <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" class="student-update-control" data-id="${s.id}" data-prop="allergic" ${isAllergic}> Alergia</label>
                  </div>
                 </div>`;
      });
    });
    dom.manageStudentsContent.innerHTML = html;

    // event listeners: ensure checkboxes behave exclusively for shifts
    dom.manageStudentsContent.querySelectorAll('.student-shift-checkbox').forEach(cb => {
      cb.addEventListener('change', async (ev) => {
        const id = ev.target.dataset.id;
        // Read states from DOM (we rely on two checkboxes present)
        const primerCb = dom.manageStudentsContent.querySelector(`input.student-shift-checkbox[data-id="${id}"][data-prop="primer"]`);
        const segundoCb = dom.manageStudentsContent.querySelector(`input.student-shift-checkbox[data-id="${id}"][data-prop="segundo"]`);
        // enforce exclusivity: if primer checked, uncheck segundo; if segundo checked, uncheck primer
        if (ev.target.dataset.prop === 'primer' && primerCb.checked) { if (segundoCb) segundoCb.checked = false; }
        if (ev.target.dataset.prop === 'segundo' && segundoCb.checked) { if (primerCb) primerCb.checked = false; }

        const primer = primerCb.checked;
        const segundo = segundoCb.checked;
        let newShift = '';
        if (primer && !segundo) newShift = 'Primer Turno (Infantil)';
        else if (!primer && segundo) newShift = 'Segundo Turno (Primaria)';
        else newShift = ''; // none selected

        const ok = await updateStudentDoc(id, { shift: newShift });
        if (ok) {
          const s = appState.students.find(x=>x.id===id);
          if (s) s.shift = newShift;
          dom.importStatusInitial.textContent = 'Guardado';
          setTimeout(()=>dom.importStatusInitial.textContent='',1200);
        } else {
          dom.importStatusInitial.textContent = 'Error guardando';
          setTimeout(()=>dom.importStatusInitial.textContent='',1200);
        }
      });
    });

    dom.manageStudentsContent.querySelectorAll('.student-update-control[data-prop="allergic"]').forEach(cb => {
      cb.addEventListener('change', async (ev) => {
        const id = ev.target.dataset.id; const val = !!ev.target.checked; const ok = await updateStudentDoc(id,{ allergic: val });
        if (ok) { const s = appState.students.find(x=>x.id===id); if (s) s.allergic = val; dom.importStatusInitial.textContent = 'Guardado'; setTimeout(()=>dom.importStatusInitial.textContent='',1200); }
      });
    });

  }

  dom.closeManageModal.addEventListener('click', ()=> dom.manageStudentsModal.classList.remove('active'));

  /* ----- Delegation inside courses (picker / attendance) ----- */
  dom.coursesContainer.addEventListener('click', async (e) => {
    const openPickerBtn = e.target.closest('.open-sporadic-picker');
    if (openPickerBtn) { openSporadicPickerModal(openPickerBtn.dataset.course); return; }

    const studentDiv = e.target.closest('.student-item');
    if (!studentDiv) return;
    const studentId = studentDiv.dataset.studentId || studentDiv.id;
    const isX = e.target.closest('.mark-absent-btn');
    const current = appState.attendance[studentId] || 'pending';
    const newState = isX ? (current === 'absent' ? 'pending' : 'absent') : (current === 'present' ? 'pending' : 'present');
    appState.attendance[studentId] = newState;
    studentDiv.classList.remove('pending','present','absent'); studentDiv.classList.add(newState);
    updateSummary();
    try { await logAttendance(studentId, new Date().toISOString().slice(0,10), newState); } catch(err){ console.error('logAttendance error', err); }
  });

  /* ----- Routing & UI visibility (default to profesor) ----- */
  function setUIForRole(isAdmin) {
    if (isAdmin) {
      dom.roleDisplay.textContent = 'Admin: ' + (auth.currentUser ? (auth.currentUser.displayName || 'Admin') : 'Admin');
      document.querySelectorAll('.admin-only').forEach(el=>el.style.display='block');
      dom.logoutBtn.style.display = 'inline-flex';
    } else {
      dom.roleDisplay.textContent = 'Modo: Profesor / Cuidador';
      document.querySelectorAll('.admin-only').forEach(el=>el.style.display='none');
      dom.logoutBtn.style.display = 'none';
    }
    // always show shift-selection to start (profesor-side entry)
    document.getElementById('dashboard').classList.add('hidden');
    document.getElementById('shift-selection').style.display = 'block';
  }

  auth.onAuthStateChanged(user => {
    const isAdmin = user && !user.isAnonymous;
    setUIForRole(isAdmin);
    // if admin and #admin in hash, show admin view
    if (isAdmin && location.hash.replace('#','') === 'admin') {
      dom.adminLoginView.classList.remove('hidden');
      dom.adminLoginView.style.display = 'block';
    } else {
      // hide the admin login view if not needed
      if (!isAdmin) dom.adminLoginView.classList.add('hidden');
    }
  });

  /* ----- Controls wiring ----- */
  dom.loginAdminBtn.addEventListener('click', ()=> auth.signInWithPopup(googleProvider).catch(e=>{ console.error(e); alert('Error login'); }));
  dom.logoutBtn.addEventListener('click', ()=> auth.signOut().then(()=>{ setUIForRole(false); }));
  dom.importCsvBtnInitial.addEventListener('click', ()=> dom.csvFileInput.click());
  dom.csvFileInput.addEventListener('change', e => handleCsvImport(e.target.files[0]));
  dom.manageStudentsBtn.addEventListener('click', openManageStudentsModal);
  dom.wipeDbBtn.addEventListener('click', async ()=> { if (!confirm('¬øBorrar todos los alumnos?')) return; await deleteAllStudents(); appState.students = []; if (appState.currentShift) renderCourses(appState.currentShift); });
  dom.exportCsvBtn.addEventListener('click', ()=> { const d = dom.exportDateInput.value || new Date().toISOString().slice(0,10); exportFullDayCsv(d); });

  document.querySelectorAll('#shift-buttons button').forEach(btn => btn.addEventListener('click', ()=> renderCourses(btn.dataset.shift)));
  dom.finalizeShiftBtn.addEventListener('click', finalizeShift);
  dom.backToShiftsBtn.addEventListener('click', ()=> { document.getElementById('shift-selection').style.display='block'; document.getElementById('dashboard').classList.add('hidden'); });

  dom.showMonthlyBtn.addEventListener('click', async ()=> {
    const now = new Date(); const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    dom.reportMonthInput.value = ym; dom.monthly-report-modal?.classList?.add?.('active'); dom.monthlyReportModal.classList.add('active'); await generateMonthlyReport(ym);
  });

  dom.showHistoryBtn = dom.showHistoryBtn || document.getElementById('show-history-btn');
if (dom.showHistoryBtn) dom.showHistoryBtn.addEventListener('click', showHistoryModal);

// cerrar modal con la X
if (dom.closeHistoryBtn) {
  dom.closeHistoryBtn.addEventListener('click', () => dom.historyModal.classList.remove('active'));
} else {
  // fallback seguro
  document.getElementById('close-history-btn')?.addEventListener('click', () => document.getElementById('history-modal')?.classList?.remove('active'));
}

// click sobre un alumno en la lista -> abrir su historial
if (dom.historyStudentList) {
  dom.historyStudentList.addEventListener('click', ev => {
    const row = ev.target.closest('.history-student');
    if (!row) return;
    const id = row.dataset.id;
    const name = row.dataset.name;
    if (!id) return;
    showStudentHistory(id, name);
  });
}

// b√∫squeda dentro del listado de alumnos (si tienes el input)
if (dom.historySearch) {
  dom.historySearch.addEventListener('input', (e) => {
    const q = e.target.value.toLowerCase();
    document.querySelectorAll('#history-student-list .history-student').forEach(el => {
      el.style.display = (el.dataset.name && el.dataset.name.toLowerCase().includes(q)) ? '' : 'none';
    });
  });
}
dom.closeHistoryBtn = dom.closeHistoryBtn || document.getElementById('close-history-btn');
  dom.historyModal = dom.historyModal || document.getElementById('history-modal');
  dom.historyStudentList.addEventListener('click', ev => { const row = ev.target.closest('.history-student'); if (!row) return; showStudentHistory(row.dataset.id, row.dataset.name); });
  dom.historySearch.addEventListener('input', (e)=>{ const q=e.target.value.toLowerCase(); document.querySelectorAll('#history-student-list .history-student').forEach(el=> el.style.display = (el.dataset.name.toLowerCase().includes(q)?'':'none')); });

  document.getElementById('close-report-btn')?.addEventListener('click', ()=> dom.monthlyReportModal.classList.remove('active'));

  // safety logs
  window.addEventListener('error', ev => console.error('GLOBAL ERROR:', ev.message));
  window.addEventListener('unhandledrejection', ev => console.error('UNHANDLED REJECTION:', ev.reason));

  // initial UI
  setUIForRole(false);
  document.getElementById('export-date-input').value = new Date().toISOString().slice(0,10);

  // Hash handling: permitir /#admin
  function handleHash() {
    const h = (location.hash || '').replace('#','');
    if (h === 'admin') {
      // mostrar vista admin-login-view y ocultar la selecci√≥n por defecto
      dom.adminLoginView.classList.remove('hidden');
      dom.adminLoginView.style.display = 'block';
      document.getElementById('shift-selection').style.display = 'none';
      document.getElementById('dashboard').classList.add('hidden');
      window.scrollTo(0,0);
      try { dom.loginAdminBtn.focus(); } catch(e){}
    } else {
      if (!auth.currentUser) {
        dom.adminLoginView.classList.add('hidden');
      }
    }
  }
  window.addEventListener('hashchange', handleHash);
  handleHash();

  // service worker (no-fatal)
  if ('serviceWorker' in navigator) { navigator.serviceWorker.register && navigator.serviceWorker.register('/sw.js').then(()=>console.log('sw registered')).catch(()=>{}); }

}); // DOMContentLoaded
</script>
</body>
</html>
