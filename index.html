<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestor de Comedor Escolar</title>

  <!-- Tailwind CDN para prototipo -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <meta name="theme-color" content="#ffffff">

  <style>
    :root {
      --bg:#f6f7f9;
      --paper:#fff;
      --text:#0f172a;
      --muted:#6b7280;
      --brand:#8b0630;
      --brand-dark:#700424;
      --accent:#19b4d6;
      --success:#004623;
      --danger:#c92a2a;
      --card-border: rgba(15,23,42,0.06);
    }

    * { box-sizing: border-box }
    html, body { width: 100%; overflow-x: hidden; -webkit-overflow-scrolling: touch; }
    body {
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      -webkit-font-smoothing: antialiased;
    }

    .container {
      max-width: 1100px;
      width: 100%;
      margin: 0 auto;
      padding: 20px;
      box-sizing: border-box;
    }

    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .logo {
      width: 54px;
      height: 54px;
      border-radius: 10px;
      background: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 20px rgba(15,23,42,0.04);
      border: 1px solid var(--card-border);
    }

    .title-wrap {
      text-align: center;
      flex: 1;
      min-width: 0;
    }

    h1 {
      margin: 8px 0 0;
      color: var(--brand);
      font-weight: 800;
      font-size: 28px;
    }

    .subtle {
      color: var(--muted);
    }

    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
      min-width: 150px;
    }

    .hidden { display: none !important; }

    @media (max-width: 600px) {
      .container { padding: 12px; }
      .header-row { flex-direction: column; align-items: flex-start; gap: 8px; }
      .title-wrap { text-align: left; width: 100%; }
      h1 { font-size: 22px; margin: 4px 0 0; }
      .header-actions { width: 100%; justify-content: flex-start; }
    }
  </style>
</head>

<body>
  <div class="container">
    <header class="header-row" role="banner">
      <div class="logo" aria-hidden="true">
        <svg width="34" height="34" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="true">
          <rect fill="#fff" width="48" height="48" rx="8"/>
          <text x="50%" y="56%" font-size="16" fill="#8b0630" text-anchor="middle" font-family="Inter">CEVP</text>
        </svg>
      </div>

      <div class="title-wrap">
        <h1>Gestor de Comedor</h1>
        <div id="role-display" class="subtle">Cargando rol...</div>
      </div>

      <div class="header-actions">
        <button id="logout-btn" class="ghost small hidden" title="Cerrar sesi√≥n">Cerrar sesi√≥n</button>
      </div>
    </header>

    <!-- Vista de login para admin -->
    <div id="admin-login-view" class="admin-panel hidden" style="max-width:640px;margin:14px auto 0">
      <h2 style="text-align:center">Acceso de Administrador</h2>
      <div style="text-align:center;margin-top:10px">
        <button id="login-admin-btn" class="primary">Iniciar sesi√≥n con Google</button>
      </div>
    </div>

    <!-- Vista principal -->
    <div id="main-content" class="hidden" style="margin-top:18px">

      <!-- Botones de turno (profesor y admin) -->
      <section id="shift-selection" style="text-align:center">
        <h2 style="margin-bottom:12px">Selecciona un turno</h2>
        <div class="btn-row" id="shift-buttons">
          <button class="primary large" data-shift="Primer Turno (Infantil)">1¬∫ Turno</button>
          <button class="primary large" data-shift="Segundo Turno (Primaria)">2¬∫ Turno</button>
        </div>

        <!-- Panel extra solo para admin -->
        <div class="admin-panel admin-only hidden" style="margin-top:24px">
          <h3 style="text-align:center;margin-bottom:10px">Panel de Gesti√≥n</h3>
          <div class="btn-row" role="group" aria-label="gestion-datos">
            <button id="show-history-btn" class="ghost">üìÑ Historial del alumno</button>
            <button id="show-monthly-report-btn" class="ghost">üìä Informe mensual</button>
            <button id="import-csv-btn-initial" class="ghost">üì§ Importar CSV</button>
            <button id="manage-students-btn" class="ghost">üë• Gestionar alumnos</button>
          </div>
          <div style="margin-top:12px;display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap">
            <input id="export-date-input" type="date" style="padding:8px;border-radius:8px;border:1px solid var(--card-border);background:#fff">
            <button id="export-csv-btn" class="primary">üíæ Exportar CSV del D√≠a</button>
          </div>
          <p id="import-status-initial" style="text-align:center;margin-top:10px;min-height:18px;color:#059669"></p>
        </div>
      </section>

      <!-- Panel de turno activo -->
      <main id="dashboard" class="hidden" style="margin-top:18px">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:wrap">
          <button id="back-to-shifts" class="ghost">&larr; Volver a Turnos</button>
          <button id="finalize-shift-btn" class="primary">üèÅ Finalizar Turno</button>
        </div>

        <section style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px">
          <div class="summary-card"><div class="small-muted">Comensales</div><div id="summary-diners" style="font-size:22px;font-weight:800">0</div></div>
          <div class="summary-card"><div class="small-muted">Ausentes</div><div id="summary-absent" style="font-size:22px;font-weight:800">0</div></div>
          <div class="summary-card"><div class="small-muted">Pendientes</div><div id="summary-pending" style="font-size:22px;font-weight:800">0</div></div>
          <div class="summary-card"><div class="small-muted">Presentes</div><div id="summary-present" style="font-size:22px;font-weight:800">0</div></div>
        </section>

        <section id="student-lists">
          <div id="courses-container"></div>
        </section>
      </main>
    </div>
  </div>

  <!-- Modal: Gestionar alumnos (admin) -->
  <div id="manage-students-modal" class="fixed-modal hidden" aria-hidden="true">
    <div class="modal-content">
      <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h2 style="color:var(--brand)">Gestionar Alumnos</h2>
        <button id="close-manage-modal" class="small">‚úï</button>
      </header>
      <div id="manage-students-content" style="max-height:68vh;overflow:auto"></div>
    </div>
  </div>

  <!-- Modal: Picker de espor√°dicos (profesor) -->
  <div id="sporadic-picker-modal" class="fixed-modal hidden" aria-hidden="true">
    <div class="modal-content">
      <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 id="sporadic-picker-title">Seleccionar espor√°dicos</h3>
        <button id="close-sporadic-picker" class="small">‚úï</button>
      </header>
      <div id="sporadic-picker-content" style="max-height:62vh;overflow:auto"></div>
      <footer style="margin-top:8px;text-align:right">
        <button id="confirm-sporadic-add" class="primary">A√±adir seleccionados</button>
      </footer>
    </div>
  </div>

  <!-- Modal: Informe mensual -->
  <div id="monthly-report-modal" class="fixed-modal hidden" aria-hidden="true">
    <div class="modal-content">
      <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="color:var(--brand)">Informe de Asistencia Mensual</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="report-month-input" type="month" style="padding:8px;border-radius:8px;border:1px solid var(--card-border)">
          <button id="print-report-btn" class="primary">üñ®Ô∏è Imprimir</button>
          <button id="close-report-btn" class="small">‚úï</button>
        </div>
      </header>
      <div id="monthly-report-content" style="max-height:66vh;overflow:auto"></div>
    </div>
  </div>

  <!-- Modal: Historial de alumno -->
  <div id="history-modal" class="fixed-modal hidden" aria-hidden="true">
    <div class="modal-content">
      <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="color:var(--brand)">Historial de Asistencia</h3>
        <button id="close-history-btn" class="small">‚úï</button>
      </header>
      <div style="display:flex;gap:14px">
        <div style="width:35%">
          <input id="history-search" placeholder="Buscar alumno..." style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--card-border)">
          <div id="history-student-list" style="margin-top:8px;max-height:52vh;overflow:auto"></div>
        </div>
        <div style="flex:1;background:#fff;border-radius:8px;padding:10px">
          <h4 id="history-student-name">Selecciona un alumno</h4>
          <div id="history-dates-list" style="margin-top:8px;max-height:52vh;overflow:auto"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Input oculto para CSV -->
  <input id="csv-file-input" type="file" accept=".csv" style="display:none">

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const firebaseConfig = {
    apiKey: "AIzaSyAeI9G1_2-E8Kghc-88bkrXa_VDJXeDyHo",
    authDomain: "comedorvp.firebaseapp.com",
    projectId: "comedorvp",
    storageBucket: "comedorvp.appspot.com",
    messagingSenderId: "821870274048",
    appId: "1:821870274048:web:62b85d28ceace395245ae5"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();
  const googleProvider = new firebase.auth.GoogleAuthProvider();

  const appState = {
    currentShift: null,
    students: [],
    attendance: {},
    tempSporadic: new Set()
  };

  const dom = {
    roleDisplay: document.getElementById('role-display'),
    adminLoginView: document.getElementById('admin-login-view'),
    mainContent: document.getElementById('main-content'),
    coursesContainer: document.getElementById('courses-container'),
    importStatusInitial: document.getElementById('import-status-initial'),
    csvFileInput: document.getElementById('csv-file-input'),
    manageStudentsModal: document.getElementById('manage-students-modal'),
    manageStudentsContent: document.getElementById('manage-students-content'),
    closeManageModal: document.getElementById('close-manage-modal'),
    sporadicPickerModal: document.getElementById('sporadic-picker-modal'),
    sporadicPickerContent: document.getElementById('sporadic-picker-content'),
    sporadicPickerTitle: document.getElementById('sporadic-picker-title'),
    closeSporadicPicker: document.getElementById('close-sporadic-picker'),
    confirmSporadicAdd: document.getElementById('confirm-sporadic-add'),
    monthlyReportModal: document.getElementById('monthly-report-modal'),
    monthlyReportContent: document.getElementById('monthly-report-content'),
    reportMonthInput: document.getElementById('report-month-input'),
    printReportBtn: document.getElementById('print-report-btn'),
    closeReportBtn: document.getElementById('close-report-btn'),
    historyModal: document.getElementById('history-modal'),
    historyStudentList: document.getElementById('history-student-list'),
    historyStudentName: document.getElementById('history-student-name'),
    historyDatesList: document.getElementById('history-dates-list'),
    historySearch: document.getElementById('history-search'),
    loginAdminBtn: document.getElementById('login-admin-btn'),
    importCsvBtnInitial: document.getElementById('import-csv-btn-initial'),
    manageStudentsBtn: document.getElementById('manage-students-btn'),
    wipeDbBtn: document.getElementById('wipe-db'),
    exportCsvBtn: document.getElementById('export-csv-btn'),
    exportDateInput: document.getElementById('export-date-input'),
    finalizeShiftBtn: document.getElementById('finalize-shift-btn'),
    backToShiftsBtn: document.getElementById('back-to-shifts'),
    summary: {
      diners: document.getElementById('summary-diners'),
      absent: document.getElementById('summary-absent'),
      pending: document.getElementById('summary-pending'),
      present: document.getElementById('summary-present')
    },
    logoutBtn: document.getElementById('logout-btn')
  };

  // üîê Autenticaci√≥n y rol
  auth.onAuthStateChanged(async user => {
    if (!user) {
      dom.roleDisplay.textContent = 'No autenticado';
      dom.adminLoginView.classList.remove('hidden');
      dom.mainContent.classList.add('hidden');
      return;
    }

    const email = user.email || '';
    const isAdmin = email.includes('@admin.com'); // ajusta seg√∫n tu dominio
    dom.roleDisplay.textContent = isAdmin ? 'Administrador' : 'Profesor';
    dom.logoutBtn.classList.remove('hidden');
    dom.adminLoginView.classList.add('hidden');
    dom.mainContent.classList.remove('hidden');

    document.querySelectorAll('.admin-only').forEach(el => {
      el.classList.toggle('hidden', !isAdmin);
    });

    document.getElementById('shift-selection').style.display = 'block';
    document.getElementById('dashboard').classList.add('hidden');
  });

  // üîò Botones
  dom.loginAdminBtn.addEventListener('click', () => auth.signInWithPopup(googleProvider).catch(e => alert('Error login')));
  dom.logoutBtn.addEventListener('click', () => auth.signOut().then(() => location.reload()));
  dom.importCsvBtnInitial.addEventListener('click', () => dom.csvFileInput.click());
  dom.csvFileInput.addEventListener('change', e => handleCsvImport(e.target.files[0]));
  dom.manageStudentsBtn.addEventListener('click', openManageStudentsModal);
  dom.wipeDbBtn?.addEventListener('click', async () => { if (!confirm('¬øBorrar todos los alumnos?')) return; await deleteAllStudents(); appState.students = []; if (appState.currentShift) renderCourses(appState.currentShift); });
  dom.exportCsvBtn.addEventListener('click', () => exportFullDayCsv(dom.exportDateInput.value || new Date().toISOString().slice(0, 10)));
  document.querySelectorAll('#shift-buttons button').forEach(btn => btn.addEventListener('click', () => renderCourses(btn.dataset.shift)));
  dom.finalizeShiftBtn.addEventListener('click', finalizeShift);
  dom.backToShiftsBtn.addEventListener('click', () => { document.getElementById('shift-selection').style.display = 'block'; document.getElementById('dashboard').classList.add('hidden'); });
  document.getElementById('show-monthly-report-btn')?.addEventListener('click', async () => { const now = new Date(); const ym = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`; dom.reportMonthInput.value = ym; dom.monthlyReportModal.classList.add('active'); await generateMonthlyReport(ym); });
  document.getElementById('show-history-btn')?.addEventListener('click', showHistoryModal);
  document.getElementById('close-history-btn')?.addEventListener('click', () => dom.historyModal.classList.remove('active'));
  dom.historySearch.addEventListener('input', (e) => {
    const q = e.target.value.toLowerCase();
    document.querySelectorAll('#history-student-list .history-student').forEach(el => {
      el.style.display = el.dataset.name.toLowerCase().includes(q) ? '' : 'none';
    });
  });
  dom.closeReportBtn?.addEventListener('click', () => dom.monthlyReportModal.classList.remove('active'));
  dom.closeManageModal.addEventListener('click', () => dom.manageStudentsModal.classList.remove('active'));
  dom.closeSporadicPicker.addEventListener('click', () => dom.sporadicPickerModal.classList.remove('active'));

  // üß† Hash #admin
  function handleHash() {
    const h = (location.hash || '').replace('#', '');
    if (h === 'admin') {
      dom.adminLoginView.classList.remove('hidden');
      dom.adminLoginView.style.display = 'block';
      document.getElementById('shift-selection').style.display = 'none';
      document.getElementById('dashboard').classList.add('hidden');
      try { dom.loginAdminBtn.focus(); } catch (e) {}
    }
  }
  window.addEventListener('hashchange', handleHash);
  handleHash();

  // üõ°Ô∏è Seguridad y extras
  window.addEventListener('error', ev => console.error('GLOBAL ERROR:', ev.message));
  window.addEventListener('unhandledrejection', ev => console.error('UNHANDLED REJECTION:', ev.reason));
  dom.exportDateInput.value = new Date().toISOString().slice(0, 10);
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register?.('/sw.js').then(() => console.log('SW registrado')).catch(() => {});
  }
});
</script>
</body>
</html>



