<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestor de Comedor Escolar</title>

  <!-- Tailwind CDN para prototipo -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <meta name="theme-color" content="#ffffff">

  <style>
    :root {
      --bg:#f6f7f9;
      --paper:#fff;
      --text:#0f172a;
      --muted:#6b7280;
      --brand:#8b0630;
      --brand-dark:#700424;
      --accent:#19b4d6;
      --success:#004623;
      --danger:#c92a2a;
      --card-border: rgba(15,23,42,0.06);
    }

    * { box-sizing: border-box }
    html, body { width: 100%; overflow-x: hidden; -webkit-overflow-scrolling: touch; }
    body {
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      -webkit-font-smoothing: antialiased;
    }

    .container {
      max-width: 1100px;
      width: 100%;
      margin: 0 auto;
      padding: 20px;
      box-sizing: border-box;
    }

    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .logo {
      width: 54px;
      height: 54px;
      border-radius: 10px;
      background: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 20px rgba(15,23,42,0.04);
      border: 1px solid var(--card-border);
    }

    .title-wrap {
      text-align: center;
      flex: 1;
      min-width: 0;
    }

    h1 {
      margin: 8px 0 0;
      color: var(--brand);
      font-weight: 800;
      font-size: 28px;
    }

    .subtle {
      color: var(--muted);
    }

    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
      min-width: 150px;
    }

    .hidden { display: none !important; }

    @media (max-width: 600px) {
      .container { padding: 12px; }
      .header-row { flex-direction: column; align-items: flex-start; gap: 8px; }
      .title-wrap { text-align: left; width: 100%; }
      h1 { font-size: 22px; margin: 4px 0 0; }
      .header-actions { width: 100%; justify-content: flex-start; }
    }
  </style>
</head>

<body>
  <div class="container">
    <header class="header-row" role="banner">
      <div class="logo" aria-hidden="true">
        <svg width="34" height="34" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="true">
          <rect fill="#fff" width="48" height="48" rx="8"/>
          <text x="50%" y="56%" font-size="16" fill="#8b0630" text-anchor="middle" font-family="Inter">CEVP</text>
        </svg>
      </div>

      <div class="title-wrap">
        <h1>Gestor de Comedor</h1>
        <div id="role-display" class="subtle">Cargando rol...</div>
      </div>

      <div class="header-actions">
        <button id="logout-btn" class="ghost small hidden" title="Cerrar sesi√≥n">Cerrar sesi√≥n</button>
      </div>
    </header>

    <!-- Vista de login para admin -->
    <div id="admin-login-view" class="admin-panel hidden" style="max-width:640px;margin:14px auto 0">
      <h2 style="text-align:center">Acceso de Administrador</h2>
      <div style="text-align:center;margin-top:10px">
        <button id="login-admin-btn" class="primary">Iniciar sesi√≥n con Google</button>
      </div>
    </div>

    <!-- Vista principal -->
    <div id="main-content" class="hidden" style="margin-top:18px">

      <!-- Botones de turno (profesor y admin) -->
      <section id="shift-selection" style="text-align:center">
        <h2 style="margin-bottom:12px">Selecciona un turno</h2>
        <div class="btn-row" id="shift-buttons">
          <button class="primary large" data-shift="Primer Turno (Infantil)">1¬∫ Turno</button>
          <button class="primary large" data-shift="Segundo Turno (Primaria)">2¬∫ Turno</button>
        </div>

        <!-- Panel extra solo para admin -->
        <div class="admin-panel admin-only hidden" style="margin-top:24px">
          <h3 style="text-align:center;margin-bottom:10px">Panel de Gesti√≥n</h3>
          <div class="btn-row" role="group" aria-label="gestion-datos">
            <button id="show-history-btn" class="ghost">üìÑ Historial del alumno</button>
            <button id="show-monthly-report-btn" class="ghost">üìä Informe mensual</button>
            <button id="import-csv-btn-initial" class="ghost">üì§ Importar CSV</button>
            <button id="manage-students-btn" class="ghost">üë• Gestionar alumnos</button>
          </div>
          <div style="margin-top:12px;display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap">
            <input id="export-date-input" type="date" style="padding:8px;border-radius:8px;border:1px solid var(--card-border);background:#fff">
            <button id="export-csv-btn" class="primary">üíæ Exportar CSV del D√≠a</button>
          </div>
          <p id="import-status-initial" style="text-align:center;margin-top:10px;min-height:18px;color:#059669"></p>
        </div>
      </section>

      <!-- Panel de turno activo -->
      <main id="dashboard" class="hidden" style="margin-top:18px">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:wrap">
          <button id="back-to-shifts" class="ghost">&larr; Volver a Turnos</button>
          <button id="finalize-shift-btn" class="primary">üèÅ Finalizar Turno</button>
        </div>

        <section style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px">
          <div class="summary-card"><div class="small-muted">Comensales</div><div id="summary-diners" style="font-size:22px;font-weight:800">0</div></div>
          <div class="summary-card"><div class="small-muted">Ausentes</div><div id="summary-absent" style="font-size:22px;font-weight:800">0</div></div>
          <div class="summary-card"><div class="small-muted">Pendientes</div><div id="summary-pending" style="font-size:22px;font-weight:800">0</div></div>
          <div class="summary-card"><div class="small-muted">Presentes</div><div id="summary-present" style="font-size:22px;font-weight:800">0</div></div>
        </section>

        <section id="student-lists">
          <div id="courses-container"></div>
        </section>
      </main>
    </div>
  </div>

  <!-- Modal: Gestionar alumnos (admin) -->
  <div id="manage-students-modal" class="fixed-modal hidden" aria-hidden="true">
    <div class="modal-content">
      <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h2 style="color:var(--brand)">Gestionar Alumnos</h2>
        <button id="close-manage-modal" class="small">‚úï</button>
      </header>
      <div id="manage-students-content" style="max-height:68vh;overflow:auto"></div>
    </div>
  </div>

  <!-- Modal: Picker de espor√°dicos (profesor) -->
  <div id="sporadic-picker-modal" class="fixed-modal hidden" aria-hidden="true">
    <div class="modal-content">
      <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 id="sporadic-picker-title">Seleccionar espor√°dicos</h3>
        <button id="close-sporadic-picker" class="small">‚úï</button>
      </header>
      <div id="sporadic-picker-content" style="max-height:62vh;overflow:auto"></div>
      <footer style="margin-top:8px;text-align:right">
        <button id="confirm-sporadic-add" class="primary">A√±adir seleccionados</button>
      </footer>
    </div>
  </div>

  <!-- Modal: Informe mensual -->
  <div id="monthly-report-modal" class="fixed-modal hidden" aria-hidden="true">
    <div class="modal-content">
      <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="color:var(--brand)">Informe de Asistencia Mensual</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="report-month-input" type="month" style="padding:8px;border-radius:8px;border:1px solid var(--card-border)">
          <button id="print-report-btn" class="primary">üñ®Ô∏è Imprimir</button>
          <button id="close-report-btn" class="small">‚úï</button>
        </div>
      </header>
      <div id="monthly-report-content" style="max-height:66vh;overflow:auto"></div>
    </div>
  </div>

  <!-- Modal: Historial de alumno -->
  <div id="history-modal" class="fixed-modal hidden" aria-hidden="true">
    <div class="modal-content">
      <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="color:var(--brand)">Historial de Asistencia</h3>
        <button id="close-history-btn" class="small">‚úï</button>
      </header>
      <div style="display:flex;gap:14px">
        <div style="width:35%">
          <input id="history-search" placeholder="Buscar alumno..." style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--card-border)">
          <div id="history-student-list" style="margin-top:8px;max-height:52vh;overflow:auto"></div>
        </div>
        <div style="flex:1;background:#fff;border-radius:8px;padding:10px">
          <h4 id="history-student-name">Selecciona un alumno</h4>
          <div id="history-dates-list" style="margin-top:8px;max-height:52vh;overflow:auto"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Input oculto para CSV -->
  <input id="csv-file-input" type="file" accept=".csv" style="display:none">

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const firebaseConfig = {
    apiKey: "AIzaSyAeI9G1_2-E8Kghc-88bkrXa_VDJXeDyHo",
    authDomain: "comedorvp.firebaseapp.com",
    projectId: "comedorvp",
    storageBucket: "comedorvp.appspot.com",
    messagingSenderId: "821870274048",
    appId: "1:821870274048:web:62b85d28ceace395245ae5"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();
  const googleProvider = new firebase.auth.GoogleAuthProvider();

  const appState = {
    currentShift: null,
    students: [],
    attendance: {},
    tempSporadic: new Set()
  };

  const dom = {
    roleDisplay: document.getElementById('role-display'),
    adminLoginView: document.getElementById('admin-login-view'),
    mainContent: document.getElementById('main-content'),
    coursesContainer: document.getElementById('courses-container'),
    importStatusInitial: document.getElementById('import-status-initial'),
    csvFileInput: document.getElementById('csv-file-input'),
    manageStudentsModal: document.getElementById('manage-students-modal'),
    manageStudentsContent: document.getElementById('manage-students-content'),
    closeManageModal: document.getElementById('close-manage-modal'),
    sporadicPickerModal: document.getElementById('sporadic-picker-modal'),
    sporadicPickerContent: document.getElementById('sporadic-picker-content'),
    sporadicPickerTitle: document.getElementById('sporadic-picker-title'),
    closeSporadicPicker: document.getElementById('close-sporadic-picker'),
    confirmSporadicAdd: document.getElementById('confirm-sporadic-add'),
    monthlyReportModal: document.getElementById('monthly-report-modal'),
    monthlyReportContent: document.getElementById('monthly-report-content'),
    reportMonthInput: document.getElementById('report-month-input'),
    printReportBtn: document.getElementById('print-report-btn'),
    closeReportBtn: document.getElementById('close-report-btn'),
    historyModal: document.getElementById('history-modal'),
    historyStudentList: document.getElementById('history-student-list'),
    historyStudentName: document.getElementById('history-student-name'),
    historyDatesList: document.getElementById('history-dates-list'),
    historySearch: document.getElementById('history-search'),
    loginAdminBtn: document.getElementById('login-admin-btn'),
    importCsvBtnInitial: document.getElementById('import-csv-btn-initial'),
    manageStudentsBtn: document.getElementById('manage-students-btn'),
    wipeDbBtn: document.getElementById('wipe-db'),
    exportCsvBtn: document.getElementById('export-csv-btn'),
    exportDateInput: document.getElementById('export-date-input'),
    finalizeShiftBtn: document.getElementById('finalize-shift-btn'),
    backToShiftsBtn: document.getElementById('back-to-shifts'),
    summary: {
      diners: document.getElementById('summary-diners'),
      absent: document.getElementById('summary-absent'),
      pending: document.getElementById('summary-pending'),
      present: document.getElementById('summary-present')
    },
    logoutBtn: document.getElementById('logout-btn')
  };

  // Aqu√≠ contin√∫a la l√≥gica: fetch, render, picker, gesti√≥n, informes, eventos...

</script>

<script>
  /* ----- Firestore helpers ----- */
  async function fetchStudents() {
    const snap = await db.collection('students').get();
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  }

  async function updateStudentDoc(id, updates) {
    try {
      await db.collection('students').doc(id).update(updates);
      return true;
    } catch (e) {
      console.error(e);
      return false;
    }
  }

  async function addStudentBatch(students) {
    const batch = db.batch();
    const col = db.collection('students');
    let added = 0;
    students.forEach(s => {
      if (s.name && s.course) {
        const docRef = col.doc();
        batch.set(docRef, {
          name: s.name.trim(),
          course: s.course.trim(),
          shift: s.shift ? s.shift.trim() : '',
          status: s.shift ? 'fixed' : 'sporadic',
          allergic: !!s.allergic
        });
        added++;
      }
    });
    if (added) await batch.commit();
    return added;
  }

  async function deleteAllStudents() {
    const snap = await db.collection('students').get();
    const batch = db.batch();
    snap.docs.forEach(d => batch.delete(d.ref));
    await batch.commit();
  }

  async function logAttendance(studentId, dateStr, state) {
    if (studentId.startsWith && studentId.startsWith('sporadic_')) return;
    const docRef = db.collection('attendance').doc(`${studentId}_${dateStr}`);
    await docRef.set({ studentId, date: dateStr, state });
  }

  async function logBatchAttendance(ids, dateStr, state) {
    const valid = ids.filter(id => !(id.startsWith && id.startsWith('sporadic_')));
    if (!valid.length) return;
    const batch = db.batch();
    const col = db.collection('attendance');
    valid.forEach(id => batch.set(col.doc(`${id}_${dateStr}`), { studentId: id, date: dateStr, state }));
    await batch.commit();
  }

  async function fetchAttendanceByDate(dateStr) {
    const snap = await db.collection('attendance').where('date', '==', dateStr).get();
    const out = {};
    snap.docs.forEach(d => out[d.data().studentId] = d.data().state);
    return out;
  }

  async function fetchAttendanceByMonth(ym) {
    const start = ym + '-01', end = ym + '-31';
    const snap = await db.collection('attendance').where('date', '>=', start).where('date', '<=', end).get();
    const map = new Map();
    snap.docs.forEach(d => {
      const r = d.data();
      if (!map.has(r.studentId)) map.set(r.studentId, new Set());
      const day = parseInt(r.date.slice(-2).replace(/^0+/, ''), 10);
      if (!isNaN(day)) map.get(r.studentId).add(day);
    });
    return map;
  }

  // Aqu√≠ contin√∫a: renderCourses, picker, gesti√≥n, informes, eventos, UI...
</script>

<script>
  /* ----- UI helpers ----- */
  function updateSummary() {
    const vals = Object.values(appState.attendance || {});
    dom.summary.diners.textContent = vals.length;
    dom.summary.absent.textContent = vals.filter(v => v === 'absent').length;
    dom.summary.present.textContent = vals.filter(v => v === 'present').length;
    dom.summary.pending.textContent = vals.filter(v => v === 'pending').length;
  }

  function createStudentElement(s) {
    const div = document.createElement('div');
    const stateClass = appState.attendance?.[s.id] || 'pending';
    div.className = `student-item ${stateClass}${s.allergic ? ' allergic' : ''}`;
    div.dataset.studentId = s.id;
    div.dataset.studentName = s.name;
    div.innerHTML = `
      <span class="name ${s.allergic ? 'allergic' : ''}">${s.name}</span>
      <div class="flex items-center gap-2">
        <button class="mark-absent-btn" title="Marcar ausente">&times;</button>
      </div>
    `;
    return div.outerHTML;
  }

  async function renderCourses(shift) {
    appState.currentShift = shift;
    document.getElementById('shift-selection').style.display = 'none';
    document.getElementById('dashboard').classList.remove('hidden');
    dom.coursesContainer.innerHTML = '<p class="small-muted">Cargando alumnos...</p>';

    appState.students = await fetchStudents();
    const today = new Date().toISOString().slice(0, 10);
    const attendance = await fetchAttendanceByDate(today);
    appState.attendance = {};
    appState.students.forEach(s => appState.attendance[s.id] = attendance[s.id] || 'pending');

    dom.coursesContainer.innerHTML = '';
    const assigned = appState.students.filter(s => (s.shift === shift) || appState.tempSporadic.has(s.id));
    const courses = [...new Set(assigned.map(s => s.course))].sort();

    if (!courses.length) {
      dom.coursesContainer.innerHTML = '<p class="small-muted">No hay alumnos en este turno.</p>';
    } else {
      courses.forEach(course => {
        const card = document.createElement('div');
        card.className = 'course-card';
        const studentsInCourse = assigned.filter(s => s.course === course).sort((a, b) => a.name.localeCompare(b.name));
        const listHtml = studentsInCourse.map(createStudentElement).join('');
        const pickerBtn = `<div style="margin-top:8px"><button class="open-sporadic-picker primary" data-course="${course}">+ A√±adir espor√°dico</button></div>`;
        card.innerHTML = `<div><h3>${course}</h3><div style="display:flex;flex-direction:column;gap:8px" data-course-list="${course}">${listHtml}</div></div>${pickerBtn}`;
        dom.coursesContainer.appendChild(card);
      });
    }
    updateSummary();
  }

  function openSporadicPickerModal(course) {
    const candidates = appState.students.filter(s => s.course === course && !s.shift && !s.id.startsWith('sporadic_'));
    const container = dom.sporadicPickerContent;
    if (!candidates.length) {
      container.innerHTML = `<p class="small-muted">No hay alumnos sin turno asignado en ${course}.</p>`;
    } else {
      let html = `<div style="display:flex;flex-direction:column;gap:8px">`;
      candidates.sort((a, b) => a.name.localeCompare(b.name)).forEach(s => {
        html += `<label style="display:flex;align-items:center;gap:8px;padding:8px;border:1px solid var(--card-border);border-radius:8px;background:#fff">
                   <input type="checkbox" class="sporadic-candidate" data-id="${s.id}">
                   <div style="flex:1"><strong>${s.name}</strong><div class="small-muted">${s.course}</div></div>
                 </label>`;
      });
      html += `</div>`;
      container.innerHTML = html;
    }
    dom.sporadicPickerTitle.textContent = `Seleccionar espor√°dicos ‚Äî ${course}`;
    dom.sporadicPickerModal.classList.add('active');
  }

  dom.confirmSporadicAdd.addEventListener('click', async () => {
    const checked = Array.from(dom.sporadicPickerContent.querySelectorAll('.sporadic-candidate:checked')).map(cb => cb.dataset.id);
    if (!checked.length) return alert('Selecciona al menos un alumno.');
    const today = new Date().toISOString().slice(0, 10);
    for (const id of checked) {
      try {
        await logAttendance(id, today, 'present');
        appState.tempSporadic.add(id);
        appState.attendance[id] = 'present';
      } catch (e) {
        console.error('Error al a√±adir espor√°dico', e);
      }
    }
    if (appState.currentShift) await renderCourses(appState.currentShift);
    dom.sporadicPickerModal.classList.remove('active');
  });

  dom.closeSporadicPicker.addEventListener('click', () => dom.sporadicPickerModal.classList.remove('active'));

  // Aqu√≠ contin√∫a: gesti√≥n de alumnos, informes, historial, eventos y UI final...
</script>

<script>
  /* ----- Finalizar turno ----- */
  async function finalizeShift() {
    if (!confirm('¬øFinalizar turno? Los pendientes pasar√°n a ausentes.')) return;
    const today = new Date().toISOString().slice(0, 10);
    const toMark = [];
    for (const id in appState.attendance) {
      if (appState.attendance[id] === 'pending') {
        appState.attendance[id] = 'absent';
        toMark.push(id);
        const el = document.querySelector(`[data-student-id="${id}"]`);
        if (el) {
          el.classList.remove('pending', 'present', 'absent');
          el.classList.add('absent');
        }
      }
    }
    await logBatchAttendance(toMark, today, 'absent');
    updateSummary();
  }

  /* ----- Historial ----- */
  async function showHistoryModal() {
    dom.historyModal.classList.add('active');
    dom.historyStudentList.innerHTML = '<p class="small-muted">Cargando...</p>';
    const all = await fetchStudents();
    all.sort((a, b) => a.name.localeCompare(b.name));
    dom.historyStudentList.innerHTML = all.map(s => `
      <div class="history-student p-2" data-id="${s.id}" data-name="${s.name}" style="border-bottom:1px solid var(--card-border);padding:8px;cursor:pointer">
        <strong>${s.name}</strong>
        <div class="small-muted">${s.shift || '(Espor√°dico)'} ‚Ä¢ ${s.course}</div>
      </div>
    `).join('');
  }

  async function showStudentHistory(id, name) {
    dom.historyStudentName.textContent = `Historial de: ${name}`;
    dom.historyDatesList.innerHTML = '<p class="small-muted">Buscando...</p>';
    const snap = await db.collection('attendance').where('studentId', '==', id).get();
    const dates = snap.docs.map(d => d.data().date).sort().reverse();
    dom.historyDatesList.innerHTML = dates.length
      ? dates.map(d => `<div style="padding:6px;border-bottom:1px solid var(--card-border)">${new Date(d + 'T00:00:00').toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>`).join('')
      : '<p class="small-muted">Sin registros.</p>';
  }

  /* ----- Informe mensual ----- */
  async function generateMonthlyReport(ym) {
    dom.monthlyReportContent.innerHTML = '<p class="small-muted">Generando informe...</p>';
    if (!ym) return dom.monthlyReportContent.innerHTML = '<p style="color:#b45309">Selecciona un mes.</p>';
    const [y, m] = ym.split('-').map(v => parseInt(v, 10));
    const days = new Date(y, m, 0).getDate();
    const all = await fetchStudents();
    const attendanceData = await fetchAttendanceByMonth(ym);
    const byCourse = all.reduce((acc, s) => {
      (acc[s.course] = acc[s.course] || []).push(s);
      return acc;
    }, {});
    let html = `<div class="printable-area"><h2 style="text-align:center">${new Date(y, m - 1, 1).toLocaleString('es-ES', { month: 'long', year: 'numeric' })}</h2>`;
    Object.keys(byCourse).sort().forEach(course => {
      const students = byCourse[course].sort((a, b) => a.name.localeCompare(b.name));
      html += `<div class="report-wrapper" style="margin-top:12px"><div style="display:flex;justify-content:space-between;align-items:center"><strong>${course}</strong><small>D√≠as: ${days} ‚Äî ${students.length} alumnos</small></div><div style="overflow:auto;margin-top:8px"><table class="report-table"><thead><tr><th>Alumno</th>`;
      for (let d = 1; d <= days; d++) html += `<th>${d}</th>`;
      html += `<th>Total</th></tr></thead><tbody>`;
      students.forEach(st => {
        const attended = attendanceData.get(st.id) || new Set();
        html += `<tr><td style="text-align:left;padding-left:6px">${st.name}</td>`;
        for (let d = 1; d <= days; d++) html += attended.has(d) ? `<td><span class="attendance-mark">‚úì</span></td>` : `<td></td>`;
        html += `<td class="total">${attended.size}</td></tr>`;
      });
      html += `</tbody></table></div></div>`;
    });
    html += `</div>`;
    dom.monthlyReportContent.innerHTML = html;
  }

  dom.printReportBtn.addEventListener('click', async () => {
    let ym = dom.reportMonthInput.value;
    if (!ym) {
      const now = new Date();
      ym = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      dom.reportMonthInput.value = ym;
    }
    await generateMonthlyReport(ym);
    const content = dom.monthlyReportContent.innerHTML;
    const iframe = document.createElement('iframe');
    iframe.style.position = 'fixed';
    iframe.style.right = '0';
    iframe.style.bottom = '0';
    iframe.style.width = '0';
    iframe.style.height = '0';
    iframe.style.border = '0';
    document.body.appendChild(iframe);
    const doc = iframe.contentWindow.document;
    const successColor = getComputedStyle(document.documentElement).getPropertyValue('--success') || '#004623';
    const styles = `<style>body{font-family:Inter,Arial;padding:18px;color:#111} .attendance-mark{display:inline-block;width:20px;height:20px;background:${successColor};color:#fff;border-radius:50%;text-align:center;line-height:20px;font-weight:700}</style>`;
    doc.open();
    doc.write(`<!doctype html><html><head><meta charset="utf-8"><title>Informe ${ym}</title>${styles}</head><body>${content}</body></html>`);
    doc.close();
    setTimeout(() => {
      try { iframe.contentWindow.focus(); iframe.contentWindow.print(); } catch (e) { console.error(e); alert('Error al imprimir: ' + e.message); }
      setTimeout(() => { try { document.body.removeChild(iframe); } catch (e) {} }, 800);
    }, 300);
  });

  /* ----- Eventos UI ----- */
  dom.loginAdminBtn.addEventListener('click', () => auth.signInWithPopup(googleProvider).catch(e => alert('Error login')));
  dom.logoutBtn.addEventListener('click', () => auth.signOut().then(() => setUIForRole(false)));
  dom.importCsvBtnInitial.addEventListener('click', () => dom.csvFileInput.click());
  dom.csvFileInput.addEventListener('change', e => handleCsvImport(e.target.files[0]));
  dom.manageStudentsBtn.addEventListener('click', openManageStudentsModal);
  dom.wipeDbBtn?.addEventListener('click', async () => { if (!confirm('¬øBorrar todos los alumnos?')) return; await deleteAllStudents(); appState.students = []; if (appState.currentShift) renderCourses(appState.currentShift); });
  dom.exportCsvBtn.addEventListener('click', () => exportFullDayCsv(dom.exportDateInput.value || new Date().toISOString().slice(0, 10)));
  document.querySelectorAll('#shift-buttons button').forEach(btn => btn.addEventListener('click', () => renderCourses(btn.dataset.shift)));
  dom.finalizeShiftBtn.addEventListener('click', finalizeShift);
  dom.backToShiftsBtn.addEventListener('click', () => { document.getElementById('shift-selection').style.display = 'block'; document.getElementById('dashboard').classList.add('hidden'); });
  document.getElementById('show-monthly-report-btn')?.addEventListener('click', async () => { const now = new Date(); const ym = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`; dom.reportMonthInput.value = ym; dom.monthlyReportModal.classList.add('active'); await generateMonthlyReport(ym); });
  document.getElementById('show-history-btn')?.addEventListener('click', showHistoryModal);
  document.getElementById('close-history-btn')?.addEventListener('click', () => dom.historyModal.classList.remove('active'));
  dom.historyStudentList.addEventListener('click', ev => { const row = ev.target.closest('.history-student'); if (row) showStudentHistory(row.dataset.id, row.dataset.name); });
    dom.historySearch.addEventListener('input', (e) => {
    const q = e.target.value.toLowerCase();
    document.querySelectorAll('#history-student-list .history-student').forEach(el => {
      el.style.display = el.dataset.name.toLowerCase().includes(q) ? '' : 'none';
    });
  });

  dom.closeReportBtn?.addEventListener('click', () => dom.monthlyReportModal.classList.remove('active'));
  dom.closeManageModal.addEventListener('click', () => dom.manageStudentsModal.classList.remove('active'));

  // Delegaci√≥n de clics en alumnos y picker
  dom.coursesContainer.addEventListener('click', async (e) => {
    const openPickerBtn = e.target.closest('.open-sporadic-picker');
    if (openPickerBtn) {
      openSporadicPickerModal(openPickerBtn.dataset.course);
      return;
    }

    const studentDiv = e.target.closest('.student-item');
    if (!studentDiv) return;
    const studentId = studentDiv.dataset.studentId;
    const isX = e.target.closest('.mark-absent-btn');
    const current = appState.attendance[studentId] || 'pending';
    const newState = isX ? (current === 'absent' ? 'pending' : 'absent') : (current === 'present' ? 'pending' : 'present');
    appState.attendance[studentId] = newState;
    studentDiv.classList.remove('pending', 'present', 'absent');
    studentDiv.classList.add(newState);
    updateSummary();
    try {
      await logAttendance(studentId, new Date().toISOString().slice(0, 10), newState);
    } catch (err) {
      console.error('logAttendance error', err);
    }
  });

  // Inicializaci√≥n de interfaz
  function setUIForRole(isAdmin) {
    dom.roleDisplay.textContent = isAdmin ? 'Administrador' : 'Modo: Profesor / Cuidador';
    document.querySelectorAll('.admin-only').forEach(el => el.classList.toggle('hidden', !isAdmin));
    dom.logoutBtn.style.display = isAdmin ? 'inline-flex' : 'none';
    document.getElementById('dashboard').classList.add('hidden');
    document.getElementById('shift-selection').style.display = 'block';
  }

  auth.onAuthStateChanged(user => {
    const isAdmin = user && !user.isAnonymous;
    setUIForRole(isAdmin);
  });

  // Hash #admin para mostrar login
  function handleHash() {
    const h = (location.hash || '').replace('#', '');
    if (h === 'admin') {
      dom.adminLoginView.classList.remove('hidden');
      dom.adminLoginView.style.display = 'block';
      document.getElementById('shift-selection').style.display = 'none';
      document.getElementById('dashboard').classList.add('hidden');
      try { dom.loginAdminBtn.focus(); } catch (e) {}
    } else {
      if (!auth.currentUser) dom.adminLoginView.classList.add('hidden');
    }
  }
  window.addEventListener('hashchange', handleHash);
  handleHash();

  // Service worker (no bloqueante)
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register?.('/sw.js').then(() => console.log('SW registrado')).catch(() => {});
  }

  // Seguridad: logs globales
  window.addEventListener('error', ev => console.error('GLOBAL ERROR:', ev.message));
  window.addEventListener('unhandledrejection', ev => console.error('UNHANDLED REJECTION:', ev.reason));

  // Fecha por defecto en exportaci√≥n
  dom.exportDateInput.value = new Date().toISOString().slice(0, 10);
});
</script>
</body>
</html>


